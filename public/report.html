<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¦¬í¬íŠ¸ | ITC</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="css/common.css" />
  <link rel="stylesheet" href="css/chat-widget.css" />
  <style>
    :root { color-scheme: dark; }
    body{ background:#0b0b0b; color:#eaeaea; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    a{ color:inherit; text-decoration:none; }
    header{ position:fixed; top:16px; left:16px; right:16px; z-index:20; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
    header .left, header .right{ pointer-events:auto; display:flex; align-items:center; gap:10px; }
    header img.logo{ width:120px; height:auto; filter:drop-shadow(0 6px 18px rgba(0,0,0,.5)); }
    .btn-nav{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:14px; font-weight:600; font-size:14px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); box-shadow:0 10px 28px rgba(0,0,0,.35); }
    .btn-nav:hover{ transform:translateY(-1px); background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05)); border-color:rgba(255,255,255,.22); }
    nav{ display:flex; gap:10px; }
    .navbtn{ display:inline-flex; align-items:center; gap:10px; height:38px; padding:0 12px; border-radius:10px; background:#121212; border:1px solid #262626; color:#e8e8e8; font-weight:700; }
    .navbtn img{ width:16px; height:16px; }
    .wrap{ max-width:1200px; margin:0 auto; padding:90px 16px 48px; }
    .grid{ display:grid; gap:14px; }
    .grid.cols-4{ grid-template-columns:repeat(4,minmax(0,1fr)); }
    .grid.cols-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    @media (max-width:1024px){ .grid.cols-4{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:760px){ .grid.cols-4,.grid.cols-2{ grid-template-columns:1fr; } }

    /* â†“ ì¹´ë“œ ë†’ì´ ì‚´ì§ ì¶•ì†Œ */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;              /* 18px â†’ 14px */
      padding:12px 12px 10px;          /* 16/16/14 â†’ 12/12/10 */
      box-shadow:0 8px 20px rgba(0,0,0,.30); /* ì‚´ì§ ì™„í™” */
    }

    .title{ font-size:14px; color:#bdbdbd; margin-bottom:8px; }
    .kpi{ display:flex; align-items:flex-end; gap:8px; }
    .kpi .value{ font-size:26px; font-weight:800; } /* 28 â†’ 26ë¡œ ì•„ì£¼ ì†Œí­ */
    .kpi .sub{ font-size:12px; color:#9ec; padding:2px 8px; border-radius:999px; background:rgba(70,215,198,.12); border:1px solid rgba(70,215,198,.28); }

    .table{ width:100%; border-collapse:collapse; font-size:14px; }
    .table th, .table td{ padding:10px; text-align:left; border-bottom:1px solid rgba(255,255,255,.08); }
    .table th{ color:#bdbdbd; font-weight:600; }
    .muted{ color:#a8a8a8; }
    .gain{ color:#3bd1b8; }
    .loss{ color:#ff7f7f; }
    footer{ margin:40px 0 20px; text-align:center; color:#9a9a9a; font-size:13px; }
    .print-btn{ position:fixed; bottom:20px; right:20px; z-index:30; border-radius:999px; padding:10px 14px; font-weight:600; font-size:14px; border:1px solid rgba(255,255,255,.15); background:linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.03)); box-shadow:0 10px 28px rgba(0,0,0,.35); cursor:pointer; }
    #ai-chat-button { bottom: 80px; }
    #ai-chat-widget { bottom: 150px; }

    /* â†“ ìµœê·¼ ì²´ê²° íˆìŠ¤í† ë¦¬: ìŠ¤í¬ë¡¤(ìœ„ì•„ë˜ ìŠ¬ë¼ì´ë“œ) ì»¨í…Œì´ë„ˆ */
    .table-container{
      max-height: 210px;     /* í•„ìš”í•˜ë©´ 260~340px ì‚¬ì´ë¡œ ì¡°ì ˆ */
      overflow-y: auto;
      overflow-x: hidden;
      border:1px solid rgba(255,255,255,.06);
      border-radius:10px;
    }
    /* í—¤ë” ê³ ì •(ìŠ¤í¬ë¡¤ ì‹œ ê°€ë…ì„±) */
    .table-container thead th{
      position: sticky;
      top: 0;
      background: #121212;
      z-index: 1;
    }
    /* ìŠ¤í¬ë¡¤ë°” ì–‡ê²Œ */
    .table-container{ scrollbar-width: thin; }
    .table-container::-webkit-scrollbar{ width:8px; }
    .table-container::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.18); border-radius:8px; }
    .table-container::-webkit-scrollbar-track{ background:transparent; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="left"><a href="index.html"><img class="logo" src="/images/logo.png" alt="ITC" /></a></div>
    <div class="right">
      <a class="navbtn" href="guide.html"><img src="/images/Document.png">ê°€ì´ë“œ</a>
      <a class="btn-nav" href="/mypage.html">ë§ˆì´í˜ì´ì§€</a>
    </div>
  </header>

  <button class="print-btn" onclick="window.print()">ğŸ“„ PDFë¡œ ì €ì¥</button>

  <main class="wrap">
    <h1 style="margin:0 4px 6px; font-size:28px;">ê°œì¸í™”ëœ ì‚¬ìš©ì ë¦¬í¬íŠ¸</h1>
    <p class="muted" style="margin:0 4px 22px;">ë¡œê·¸ì¸ í›„ APIì—ì„œ ì‹¤ì œ ë°ì´í„°ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.</p>

    <!-- KPI -->
    <div class="grid cols-4">
      <div class="card"><div class="title">ì´ë²ˆ ë‹¬ ë‚´ ê±°ë˜ íšŸìˆ˜</div><div class="kpi"><div class="value" id="kpi_trades">â€”</div><div class="sub" id="kpi_trades_diff">â€”</div></div></div>
      <div class="card"><div class="title">ì´ë²ˆ ë‹¬ ì†ìµ(ì‹¤í˜„)</div><div class="kpi"><div class="value" id="kpi_pnl">â€”</div><div class="sub" id="kpi_pnl_diff">â€”</div></div></div>
      <div class="card"><div class="title">ë‚´ ìˆ˜ìµë¥  (ì›”ê°„)</div><div class="kpi"><div class="value" id="kpi_return">â€”</div><div class="sub" id="kpi_return_rank">â€”</div></div></div>
      <div class="card"><div class="title">ê°€ì¥ ë§ì´ ê±°ë˜í•œ ì¢…ëª©</div><div class="kpi"><div class="value" id="kpi_top_symbol">â€”</div><div class="sub" id="kpi_top_symbol_share">â€”</div></div></div>
    </div>

    <!-- Charts -->
    <div class="grid cols-2" style="margin-top:14px;">
      <div class="card"><div class="title">ë‚˜ì˜ ì´ìì‚° ë³€í™”</div><canvas id="chart_equity" height="120"></canvas></div>
      <div class="card"><div class="title">ë‚˜ì˜ ìˆ˜ìµë¥  vs ì „ì²´ í‰ê·  ìˆ˜ìµë¥ </div><canvas id="chart_return_compare" height="120"></canvas></div>
    </div>

    <!-- Top symbols + recent fills -->
    <div class="grid cols-2" style="margin-top:14px;">
      <div class="card"><div class="title">ë‚´ê°€ ê±°ë˜í•œ ì¢…ëª© ìˆ˜ëŸ‰</div><canvas id="chart_my_top_symbols" height="120"></canvas></div>
      <div class="card">
        <div class="title">ìµœê·¼ ì²´ê²° íˆìŠ¤í† ë¦¬</div>
        <!-- ìŠ¤í¬ë¡¤(ìœ„ì•„ë˜ ìŠ¬ë¼ì´ë“œ) ì»¨í…Œì´ë„ˆ -->
        <div class="table-container">
          <table class="table" id="table_recent">
            <thead><tr><th>ì¼ì‹œ</th><th>ì¢…ëª©</th><th>ìœ í˜•</th><th>ìˆ˜ëŸ‰</th><th>ê°€ê²©</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    const fmtKRW = v => 'â‚©' + Number(v||0).toLocaleString('ko-KR');
    const fmtPct = v => (v>=0?'+':'') + Number(v||0).toFixed(1) + '%';
    const fmtDT  = ts => {
      const d = new Date(ts);
      return isNaN(d.getTime()) ? String(ts) : d.toLocaleString('ko-KR', { dateStyle:'short', timeStyle:'short' });
    };
    const sideKR = s => {
      const map = { buy:'ë§¤ìˆ˜', sell:'ë§¤ë„', bid:'ë§¤ìˆ˜', ask:'ë§¤ë„' };
      return map[(s||'').toLowerCase()] || (s||'').toUpperCase();
    };
    const cleanSymbol = sym => (sym||'').replace(/^KRW[-/]/, '');

    async function loadReport(){
      const r = await fetch('/api/user/report', { credentials:'include' });
      if(!r.ok) throw new Error('report api failed');
      const data = await r.json();
      const { days=[], my={} } = data;

      // KPI
      document.getElementById('kpi_trades').textContent = Number(my.monthlyTrades||0).toLocaleString('ko-KR');
      document.getElementById('kpi_trades_diff').textContent = (my.monthlyTradesDiff>=0?'+':'') + (my.monthlyTradesDiff||0) + 'ê±´';

      const monthlyPnL = my.monthlyPnL || 0;
      const monthlyPnLDiff = my.monthlyPnLDiff || 0;
      document.getElementById('kpi_pnl').textContent = fmtKRW(monthlyPnL);
      document.getElementById('kpi_pnl').classList.add(monthlyPnL>=0?'gain':'loss');
      document.getElementById('kpi_pnl_diff').textContent = (monthlyPnLDiff>=0?'+':'') + fmtKRW(Math.abs(monthlyPnLDiff));
      document.getElementById('kpi_pnl_diff').classList.add(monthlyPnLDiff>=0?'gain':'loss');

      document.getElementById('kpi_return').textContent = fmtPct(my.monthlyReturnPct||0);
      document.getElementById('kpi_return_rank').textContent = (my.returnRankPctile!=null) ? `ìƒìœ„ ${my.returnRankPctile}%` : 'â€”';

      if (my.topSymbols?.length){
        document.getElementById('kpi_top_symbol').textContent = cleanSymbol(my.topSymbols[0].symbol);
        document.getElementById('kpi_top_symbol_share').textContent = Math.round(my.topSymbols[0].share*100) + '%';
      }

      /* ìµœê·¼ ì²´ê²° íˆìŠ¤í† ë¦¬: ìµœëŒ€ 20ê°œë§Œ í‘œì‹œ */
      const tbody = document.querySelector('#table_recent tbody');
      tbody.innerHTML = '';
      (my.recentFills||[]).slice(0,20).forEach(f=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDT(f.ts||f.created_at)}</td>
          <td>${cleanSymbol(f.sym||f.market||'')}</td>
          <td>${sideKR(f.side)}</td>
          <td>${f.qty}</td>
          <td>${fmtKRW(f.price)}</td>`;
        tbody.appendChild(tr);
      });

      // ì°¨íŠ¸ ê³µí†µ ì˜µì…˜
      const baseGrid = { color:'rgba(255,255,255,.12)' };
      const baseTicks = { color:'#cfcfcf', font:{ size:11 } };
      const tooltip = { enabled:true, intersect:false, mode:'index' };

      // ì´ìì‚° ë³€í™”
      new Chart(document.getElementById('chart_equity'), {
        type:'line',
        data:{ labels:days, datasets:[{ label:'ì´ìì‚°(â‚©)', data:my.equityCurve||[], fill:true, borderWidth:2, pointRadius:0, tension:.35 }]},
        options:{ plugins:{ legend:{display:false}, tooltip }, scales:{ x:{ grid:{display:false}, ticks:baseTicks }, y:{ grid:baseGrid, ticks:baseTicks } } }
      });

      // ìˆ˜ìµë¥  ë¹„êµ
      const myReturn = my.returnSeries||[];
      const peerReturn = my.peerAvgReturnSeries||null;
      const marketBaseline = my.marketReturnSeries || new Array(days.length).fill(0);

      const datasets = [
        { type:'line', label:'ë‚´ ìˆ˜ìµë¥ (%)', data:myReturn, borderColor:'#4bc0c0', borderWidth:2, pointRadius:0, tension:.35 }
      ];
      if (peerReturn){
        datasets.push({ type:'line', label:'ì „ì²´ í‰ê·  ìˆ˜ìµë¥ (%)', data:peerReturn, borderColor:'#ffcd56', borderWidth:2, pointRadius:0, tension:.35 });
      } else {
        datasets.push({ type:'line', label:'ê¸°ì¤€ì„ (0%)', data:marketBaseline, borderDash:[5,5], borderColor:'#aaa', borderWidth:2, pointRadius:0, tension:.35 });
      }

      new Chart(document.getElementById('chart_return_compare'), {
        type:'line',
        data:{ labels:days, datasets },
        options:{ plugins:{ legend:{display:true, labels:{ color:'#ddd' }}, tooltip },
          scales:{ x:{ grid:{display:false}, ticks:baseTicks }, y:{ grid:baseGrid, ticks:baseTicks } } }
      });

      // ë‚´ê°€ ê±°ë˜í•œ ì¢…ëª©
      new Chart(document.getElementById('chart_my_top_symbols'), {
        type:'bar',
        data:{ labels:(my.topSymbols||[]).map(d=>cleanSymbol(d.symbol)), datasets:[{ label:'ê±°ë˜ ë¹„ì¤‘(%)', data:(my.topSymbols||[]).map(d=>Math.round(d.share*100)) }] },
        options:{ indexAxis:'y', plugins:{ legend:{display:false}, tooltip },
          scales:{ x:{ grid:baseGrid, ticks:baseTicks, max:100 }, y:{ grid:{display:false}, ticks:baseTicks } } }
      });
    }

    loadReport().catch(err=>{
      console.error(err);
      document.querySelector('.muted').textContent = 'ë¦¬í¬íŠ¸ ë¡œë”© ì‹¤íŒ¨: ë¡œê·¸ì¸ ë˜ëŠ” ë°ì´í„° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    });
  </script>

  <script src="js/ReportAIAssistant.js" defer></script>
  <script src="js/report-ai-init.js" defer></script>
</body>
</html>
