<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>리포트 | ITC</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="css/common.css" />
  <link rel="stylesheet" href="css/chat-widget.css" />
  <style>
    :root { color-scheme: dark; }
    body{ background:#0b0b0b; color:#eaeaea; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    a{ color:inherit; text-decoration:none; }
    header{ position:fixed; top:16px; left:16px; right:16px; z-index:20; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
    header .left, header .right{ pointer-events:auto; display:flex; align-items:center; gap:10px; }
    header img.logo{ width:120px; height:auto; filter:drop-shadow(0 6px 18px rgba(0,0,0,.5)); }
    .btn-nav{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:14px; font-weight:600; font-size:14px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); box-shadow:0 10px 28px rgba(0,0,0,.35); }
    .btn-nav:hover{ transform:translateY(-1px); background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05)); border-color:rgba(255,255,255,.22); }
    .wrap{ max-width:1200px; margin:0 auto; padding:90px 16px 48px; }
    .grid{ display:grid; gap:14px; }
    .grid.cols-4{ grid-template-columns:repeat(4,minmax(0,1fr)); }
    .grid.cols-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    @media (max-width:1024px){ .grid.cols-4{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:760px){ .grid.cols-4,.grid.cols-2{ grid-template-columns:1fr; } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px 12px 10px;
      box-shadow:0 8px 20px rgba(0,0,0,.30);
    }
    .title{ font-size:14px; color:#bdbdbd; margin-bottom:8px; }
    .kpi{ display:flex; align-items:flex-end; gap:8px; }
    .kpi .value{ font-size:26px; font-weight:800; }
    .kpi .sub{ font-size:12px; color:#9ec; padding:2px 8px; border-radius:999px; background:rgba(70,215,198,.12); border:1px solid rgba(70,215,198,.28); }

    .table{ width:100%; border-collapse:collapse; font-size:14px; }
    .table th, .table td{ padding:10px; text-align:left; border-bottom:1px solid rgba(255,255,255,.08); }
    .table th{ color:#bdbdbd; font-weight:600; }
    .muted{ color:#a8a8a8; }

    /* + 빨강, - 파랑g */
    .gain{ color:#FF6B6B; }  /* 양수 */
    .loss{ color:#84ceff; }  /* 음수 */

    .table-container{
      max-height: 210px;
      overflow-y: auto;
      overflow-x: hidden;
      border:1px solid rgba(255,255,255,.06);
      border-radius:10px;
    }
    .table-container thead th{ position:sticky; top:0; background:#121212; z-index:1; }
    .table-container::-webkit-scrollbar{ width:8px; }
    .table-container::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.18); border-radius:8px; }
    .table-container::-webkit-scrollbar-track{ background:transparent; }

    /* 값이 비어있으면 서브텍스트(작대기) 자동 숨김 */
    .kpi .sub:empty { display: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

  <!-- BTC/ETH/XRP 전용 팔레트 + HEX→RGBA 유틸 -->
  <script>
    // HEX → rgba()
    function hexA(hex, a=1){
      const h = hex.replace('#','');
      const v = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
      const n = parseInt(v, 16);
      const r = (n>>16)&255, g=(n>>8)&255, b=n&255;
      return `rgba(${r},${g},${b},${a})`;
    }
    // 심볼 팔레트(대문자 기준)
    const PALETTE = {
      BTC: '#FFC98A',
      ETH: '#FF8FB3',
      XRP: '#7CC7A3',
    };
  </script>
</head>
<body>
  <header>
    <div class="left"><a href="index.html"><img class="logo" src="/images/logo.png" alt="ITC" /></a></div>
    <div class="right">
      <a class="btn-nav" href="guide.html">가이드</a>
      <a class="btn-nav" href="/mypage.html">마이페이지</a>
    </div>
  </header>

  <button class="btn-nav" style="position:fixed;bottom:20px;left:20px;z-index:30" onclick="window.print()">📄 PDF로 저장</button>

  <main class="wrap">
    <h1 style="margin:0 4px 6px; font-size:28px;">개인화된 사용자 리포트</h1>
    <p class="muted" style="margin:0 4px 22px;">로그인 후 API에서 실제 데이터로 렌더링합니다.</p>

    <!-- KPI -->
    <div class="grid cols-4">
      <div class="card"><div class="title">이번 달 내 거래 횟수</div><div class="kpi"><div class="value" id="kpi_trades">—</div><div class="sub" id="kpi_trades_diff"></div></div></div>
      <div class="card"><div class="title">이번 달 수익</div><div class="kpi"><div class="value" id="kpi_pnl">—</div><div class="sub" id="kpi_pnl_diff"></div></div></div>
      <div class="card"><div class="title">이번 달 수익률</div><div class="kpi"><div class="value" id="kpi_return">—</div><div class="sub" id="kpi_return_rank"></div></div></div>
      <div class="card"><div class="title">가장 많이 거래한 종목</div><div class="kpi"><div class="value" id="kpi_top_symbol">—</div><div class="sub" id="kpi_top_symbol_share">—</div></div></div>
    </div>

    <!-- Charts -->
    <div class="grid cols-2" style="margin-top:14px;">
      <div class="card"><div class="title">나의 총자산 변화</div><canvas id="chart_equity" height="120"></canvas></div>
      <div class="card"><div class="title">나의 수익률 vs 전체 평균 수익률</div><canvas id="chart_return_compare" height="120"></canvas></div>
    </div>

    <!-- Top symbols + recent fills -->
    <div class="grid cols-2" style="margin-top:14px;">
      <div class="card"><div class="title">내가 거래한 종목 수량</div><canvas id="chart_my_top_symbols" height="120"></canvas></div>
      <div class="card">
        <div class="title">최근 체결 히스토리</div>
        <div class="table-container">
          <table class="table" id="table_recent">
            <thead><tr><th>일시</th><th>종목</th><th>유형</th><th>수량</th><th>가격</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    const fmtKRW = v => '₩' + Number(v||0).toLocaleString('ko-KR');
    const fmtPct = v => (v>=0?'+ ':'- ') + Math.abs(Number(v||0).toFixed(1)) + '%';
    const fmtDT  = ts => {
      const d = new Date(ts);
      return isNaN(d.getTime()) ? String(ts) : d.toLocaleString('ko-KR', { dateStyle:'short', timeStyle:'short' });
    };
    const sideKR = s => ({buy:'매수',sell:'매도',bid:'매수',ask:'매도'})[(s||'').toLowerCase()] || (s||'').toUpperCase();
    const cleanSymbol = sym => (sym||'').replace(/^KRW[-/]/,'');

    /* ====== Y축 범위 계산 (패딩 포함) ====== */
    function calcRange(arr, pad=0.08){
      const vals = (arr||[]).map(Number).filter(v => Number.isFinite(v));
      if (!vals.length) return {};
      const mn = Math.min(...vals), mx = Math.max(...vals);
      if (mn === mx) {
        const d = mn === 0 ? 1 : Math.abs(mn)*0.05;
        return { suggestedMin: mn - d, suggestedMax: mx + d };
      }
      const span = mx - mn, p = span*pad;
      return { suggestedMin: mn - p, suggestedMax: mx + p };
    }

    async function loadReport(){
      const r = await fetch('/api/user/report', { credentials:'include' });
      if(!r.ok) throw new Error('report api failed');
      const data = await r.json();
      const { days=[], my={} } = data;

      /* ===== KPI ===== */
      // 거래 횟수
      document.getElementById('kpi_trades').textContent = Number(my.monthlyTrades||0).toLocaleString('ko-KR');
      // +0건 숨김
      const tradesDiffEl = document.getElementById('kpi_trades_diff');
      const diff = my.monthlyTradesDiff;
      if (diff == null || diff === 0) {
        tradesDiffEl.textContent = '';
        tradesDiffEl.style.display = 'none';
      } else {
        tradesDiffEl.textContent = (diff>0?'+':'') + diff + '건';
        tradesDiffEl.style.display = '';
      }

      // 이번 달 수익(원화) = equityCurve 마지막 - 첫값 (평가 기준)
      const eq = my.equityCurve || [];
      const mtdMoney = (eq?.length >= 2) ? Math.round((eq.at(-1) - eq[0])) : 0;
      const pnlEl = document.getElementById('kpi_pnl');
      pnlEl.textContent = (mtdMoney >= 0 ? '+' : '- ') + fmtKRW(Math.abs(mtdMoney));
      pnlEl.classList.remove('gain','loss');
      pnlEl.classList.add(mtdMoney>=0?'gain':'loss'); // + 빨강 / - 파랑

      // 서브텍스트 숨김
      const pnlDiffEl = document.getElementById('kpi_pnl_diff');
      pnlDiffEl.textContent = '';
      pnlDiffEl.style.display = 'none';

      // 내 수익률(월간) = equityCurve 기반으로 직접 계산 (그래프와 일치)
      const monthlyReturnPct = (eq.length>=2 && eq[0])
        ? ((eq.at(-1) - eq[0]) / eq[0]) * 100
        : 0;
      const returnEl = document.getElementById('kpi_return');
      returnEl.textContent = fmtPct(monthlyReturnPct);
      returnEl.classList.remove('gain','loss');
      returnEl.classList.add(monthlyReturnPct>=0 ? 'gain' : 'loss'); // + 빨강 / - 파랑

      // 수익률 서브텍스트(백분위): 값 있을 때만 표시
      const rankEl = document.getElementById('kpi_return_rank');
      rankEl.textContent = (my.returnRankPctile!=null) ? `상위 ${my.returnRankPctile}%` : '';

      // 최다 거래 종목
      if (my.topSymbols?.length){
        document.getElementById('kpi_top_symbol').textContent = cleanSymbol(my.topSymbols[0].symbol);
        document.getElementById('kpi_top_symbol_share').textContent = Math.round(my.topSymbols[0].share*100) + '%';
      }

      /* ===== 최근 체결 히스토리 ===== */
      const tbody = document.querySelector('#table_recent tbody');
      tbody.innerHTML = '';
      (my.recentFills||[]).slice(0,20).forEach(f=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDT(f.ts||f.created_at)}</td>
          <td>${cleanSymbol(f.sym||f.market||'')}</td>
          <td>${sideKR(f.side)}</td>
          <td>${f.qty}</td>
          <td>${fmtKRW(f.price)}</td>`;
        tbody.appendChild(tr);
      });

      /* ===== 차트 공통 옵션 ===== */
      const baseGrid = { color:'rgba(255,255,255,.12)' };
      const baseTicks = { color:'#cfcfcf', font:{ size:11 } };
      const tooltip = { enabled:true, intersect:false, mode:'index' };

      /* ===== 총자산 변화 (Y축 자동) ===== */
      const equityData = my.equityCurve || [];
      const yRangeEquity = calcRange(equityData, 0.08);

      new Chart(document.getElementById('chart_equity'), {
        type:'line',
        data:{
          labels:days,
          datasets:[{
            label:'총자산(₩)',
            data:equityData,
            fill:true,
            borderWidth:2,
            borderColor:'#4bc0c0',
            backgroundColor:'rgba(75,192,192,0.25)',
            pointRadius:0,
            tension:.35
          }]
        },
        options:{
          plugins:{ legend:{display:false}, tooltip },
          scales:{
            x:{ grid:{display:false}, ticks:baseTicks },
            y:{ grid:baseGrid, ticks:baseTicks, beginAtZero:false, ...yRangeEquity }
          }
        }
      });

      /* ===== 수익률 비교 (통합 범위) ===== */
      const myReturn = my.returnSeries||[];
      const peerReturn = my.peerAvgReturnSeries||null;
      const marketBaseline = my.marketReturnSeries || new Array(days.length).fill(0);

      const datasets = [
        { type:'line', label:'내 수익률(%)', data:myReturn, borderColor:'#4bc0c0', borderWidth:2, pointRadius:0, tension:.35 }
      ];
      if (peerReturn){
        datasets.push({ type:'line', label:'전체 평균 수익률(%)', data:peerReturn, borderColor:'#ffcd56', borderWidth:2, pointRadius:0, tension:.35 });
      } else {
        datasets.push({ type:'line', label:'기준선(0%)', data:marketBaseline, borderDash:[5,5], borderColor:'#aaa', borderWidth:2, pointRadius:0, tension:.35 });
      }

      const allReturnVals = [...myReturn, ...(peerReturn||[]), ...(marketBaseline||[])];
      const yRangeReturn = calcRange(allReturnVals, 0.12);

      new Chart(document.getElementById('chart_return_compare'), {
        type:'line',
        data:{ labels:days, datasets },
        options:{
          plugins:{ legend:{display:true, labels:{ color:'#ddd' }}, tooltip },
          scales:{
            x:{ grid:{display:false}, ticks:baseTicks },
            y:{ grid:baseGrid, ticks:baseTicks, beginAtZero:false, ...yRangeReturn }
          }
        }
      });

      /* ===== 내가 거래한 종목 (BTC/ETH/XRP만 개별 색 적용) ===== */
      const labelsTop = (my.topSymbols||[]).map(d=>cleanSymbol(d.symbol).toUpperCase());
      const dataTop   = (my.topSymbols||[]).map(d=>Math.round(d.share*100));

      new Chart(document.getElementById('chart_my_top_symbols'), {
        type:'bar',
        data:{
          labels: labelsTop,
          datasets:[{
            label:'거래 비중(%)',
            data: dataTop,
            backgroundColor: (ctx) => {
              const label = ctx.chart.data.labels[ctx.dataIndex];
              const hex = PALETTE[label];
              return hex ? hexA(hex, 0.70) : undefined;
            },
            borderColor: (ctx) => {
              const label = ctx.chart.data.labels[ctx.dataIndex];
              return PALETTE[label] || undefined;
            },
            hoverBackgroundColor: (ctx) => {
              const label = ctx.chart.data.labels[ctx.dataIndex];
              return PALETTE[label] || undefined;
            },
            borderWidth: 2,
          }]
        },
        options:{
          indexAxis:'y',
          plugins:{ legend:{display:false}, tooltip },
          scales:{
            x:{ grid:{ color:'rgba(255,255,255,.12)' }, ticks:{ color:'#cfcfcf', font:{ size:11 } }, max:100 },
            y:{ grid:{ display:false }, ticks:{ color:'#cfcfcf', font:{ size:11 } } }
          }
        }
      });
    }

    loadReport().catch(err=>{
      console.error(err);
      document.querySelector('.muted').textContent = '리포트 로딩 실패: 로그인 또는 데이터 상태를 확인하세요.';
    });
  </script>

  <script src="js/ReportAIAssistant.js" defer></script>
  <script src="js/report-ai-init.js" defer></script>
</body>
</html>
