<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>시나리오3 | 유지장</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>

  <style>
    :root{
      --bg:#1b1b1b;
      --panel:#1b1b1b;
      --panel-2:#1b1b1b;
      --line:#303030;
      --hairline:#5e5e5e;
      --text:#E8ECF3;
      --muted:#ffffff;

      --active:#ffffff;
      --active-600:#a3a3a3;

      --candle-up:  rgb(255,77,77);
      --candle-down:rgba(26,175,151);
      --vol-up:     rgba(255,77,77,.56);
      --vol-down:   rgba(26,175,151,.50);

      /* 살짝 축소 */
      --font-sm:12.5px; --font-md:14.5px; --font-lg:18px; --font-xl:20px;
      --radius:16px;
      --shadow:0 10px 28px rgba(0,0,0,.32);

      /* 차트 세로 소폭 ↓ */
      --chart-price-h: 60vh;
      --chart-vol-h:   150px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#1b1b1b;
      color:var(--text);
    }

    .header{
      display:flex; align-items:center; justify-content:center;
      padding:18px; /* 20→18 */
      background:var(--panel); border-bottom:1px solid var(--line);
      position:relative;
    }
    .header .left-tools{ position:absolute; left:12px; top:50%; transform:translateY(-50%); display:flex; gap:8px; }
    .back-btn,.help-btn{
      padding:9px 12px; border-radius:12px;
      background:rgba(255,255,255,.02); border:1px solid var(--hairline);
      color:#dfe5f1; text-decoration:none; font-size:var(--font-md); font-weight:700; line-height:1;
      transition:border-color .15s ease, filter .15s ease, transform .06s ease; backdrop-filter: blur(2px);
    }
    .help-btn{ font-size:18px; padding:9px 10px; }
    .back-btn:hover,.help-btn:hover{ border-color:#313947; filter:brightness(1.06); }
    .back-btn:active,.help-btn:active{ transform:translateY(1px); }

    .scenario-wrap{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .scenario-badge{ display:inline-block; padding:5px 12px; border-radius:14px; background:#1e1e1e; border:1px solid #84f3da; font-size:13px; font-weight:700; color:#84f3da; }
    .scenario-title{ font-size:18px; font-weight:800; color:#84f3da; }

    .balances{ position:absolute; right:12px; top:50%; transform:translateY(-50%); display:flex; gap:10px; }
    .b-item{
      text-align:right; padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    .b-label{ font-size:var(--font-sm); color:#bac0cc; }
    .b-value{ font-size:var(--font-lg); font-weight:800; color:#eef3ff; }
    .positive{ color:#9CD67A; } .negative{ color:#FF7A7A; }

    /* === GRID: 선 이중표시 방지 & 한몸처럼 === */
    .grid{
      display:grid;
      gap:1px;                   /* 2px → 1px (중앙 이중선 제거) */
      background:var(--line);    /* gap 영역을 선처럼 사용 */
      grid-template-columns:1.05fr 1.05fr 0.96fr;
      height: calc(91vh - 64px); /* 92vh-70 → 조금 줄임 */
      border:1px solid var(--line); /* outline 대신 border로 컨테이너와 동기화 */
      border-radius:0;           /* 모서리 움직임 일체화 */
    }
    /* 이중선 원인 제거: 중간/좌우 개별 border 제거 */
    #leftCol{
      border-right:1px solid var(--line);
    }
    .col{ background:var(--panel-2); display:flex; flex-direction:column; min-width:0; }

    .pane-header{
      display:flex; align-items:center; justify-content:space-between; padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#1a1a1a,#191919);
    }
    .pane-title{ display:flex; align-items:center; gap:10px; }
    .badge{
      font-size:var(--font-sm); padding:4px 10px; border-radius:999px;
      border:1px solid var(--hairline); color:#bebebe; background:rgba(255,255,255,.02);
    }
    .badge.active{ background:transparent; border-color: var(--active); color:#ffffff; box-shadow: 0 0 0 1px color-mix(in srgb, var(--active) 60%, rgba(0,0,0,0)) inset; }
    .price-block{ text-align:right; }
    .big{ font-size:var(--font-lg); font-weight:800; }
    .sub{ font-size:var(--font-sm); color:var(--muted); }

    .chart-wrap{ flex:1; padding:12px; display:flex; flex-direction:column; gap:10px; background:var(--panel-2); }
    .price-box,.vol-box{
      position:relative; border:1px solid rgba(255,255,255,.08); border-radius:14px;
      overflow:hidden; background:#141414;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03), 0 8px 22px rgba(0,0,0,.28);
    }
    .price-box{ height:var(--chart-price-h); }
    .vol-box{ height:var(--chart-vol-h); }
    .chart{ width:100%; height:100%; display:block; }

    .trade-panel{ padding:12px; display:flex; flex-direction:column; gap:12px; overflow:auto; }
    .seg{ display:grid; gap:10px; background:rgba(255,255,255,0.02); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .seg-title{ font-weight:900; border-bottom:1px dashed var(--hairline); padding-bottom:8px; font-size:var(--font-md); }

    .toolbar{ display:flex; align-items:center; gap:8px; }
    .btn{
      padding:10px 14px; border-radius:12px;
      font-weight:800; font-size:14px; border:1px solid #2a313c; background:#1a1a1a; color:#b1b1b1;
      transition:transform .06s ease, box-shadow .12s ease, border-color .2s ease, color .2s ease;
      box-shadow:0 4px 12px rgba(0,0,0,.22); cursor:pointer; min-height:42px; line-height:1;
    }
    .btn:hover{ box-shadow:0 6px 16px rgba(0,0,0,.26); border-color:#343c49; }
    .btn:active{ transform:translateY(1px); box-shadow:0 2px 9px rgba(0,0,0,.22) inset; }
    .btn.is-active{ background:#1a1a1a; border-color:var(--active); color:var(--active); box-shadow:none; }

    .timebox{
      margin-left:auto;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      color:#d0d7ff; font-size:14px; opacity:.95;
    }

    .tabs{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .tab{
      padding:10px 12px; border:1px solid var(--line); background:#1b1b1b; color:#cfd5e2;
      cursor:pointer; text-align:center; border-radius:12px; transition:filter .15s, border-color .15s; font-weight:800;
    }
    .tab:hover{ filter:brightness(1.05); border-color:#343c49; }
    .tab.active{ color:#0b0c0f; background:var(--active); border-color:var(--active); box-shadow:none; }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .label{ font-size:var(--font-sm); color:var(--muted); }
    .input{
      width:100%; padding:12px; border:1px solid var(--line); background:#151515; color:#e9eef8; border-radius:12px; font-size:var(--font-md); outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.02);
    }
    .input:focus{ border-color:#3b4660; box-shadow:0 0 0 3px color-mix(in srgb, var(--active) 24%, transparent); }
    #amount::-webkit-outer-spin-button,#amount::-webkit-inner-spin-button,#pctInput::-webkit-outer-spin-button,#pctInput::-webkit-inner-spin-button{ -webkit-appearance:none!important; margin:0; }
    #amount,#pctInput{ -moz-appearance:textfield; }
    #total{ width:100%; }

    .pct-row{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px; }
    .pct{
      padding:10px; border:1px solid var(--line); background:#1b1b1b; color:#cfd5e2;
      border-radius:12px; cursor:pointer; font-size:var(--font-sm); font-weight:800; transition:filter .15s, border-color .15s; text-align:center;
    }
    .pct:hover{ filter:brightness(1.05); border-color:#343c49; }

    .order-btn{
      width:100%; padding:12px; border-radius:12px; font-weight:900; border:0; cursor:pointer;
      transition:filter .15s, transform .06s, box-shadow .12s; letter-spacing:.2px; font-size:14px;
    }
    .order-btn.buy{  background:linear-gradient(180deg,var(--active),var(--active-600)); color:#0b0c0f; }
    .order-btn.sell{ background:linear-gradient(180deg,var(--active),var(--active-600)); color:#0b0c0f; }
    .order-btn:hover{ filter:brightness(1.02); }
    .order-btn:active{ transform:translateY(1px); box-shadow:0 2px 9px rgba(0,0,0,.18) inset; }

    .warn{ font-size:var(--font-sm); color:#f08585; background:rgba(229,62,62,0.08); padding:8px; border-radius:12px; display:none; border:1px dashed rgba(229,62,62,0.15); }

    .hold{ display:grid; gap:8px; }
    .kv{ display:flex; justify-content:space-between; font-size:var(--font-md); }
    .rule{ height:1px; background:var(--line); margin:6px 0; }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,4,8,.60); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:min(580px,94vw); background:#121212; border:1px solid var(--line); border-radius:16px; box-shadow:0 28px 72px rgba(0,0,0,.5); overflow:hidden; }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--line); font-weight:900; font-size:var(--font-lg); }
    .modal-body{ padding:16px; display:grid; gap:10px; }
    .kv-row{ display:flex; justify-content:space-between; }
    .hr{ height:1px; background:var(--line); margin:6px 0; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid var(--line); }
    .mbtn{ padding:10px 12px; border-radius:12px; border:1px solid #2a2f38; background:#1b1b1b; color:#fff; cursor:pointer; }
    .mbtn.primary{ background:linear-gradient(180deg,var(--active),var(--active-600)); color:#0b0c0f; border:none; font-weight:900; }

    .notice-backdrop{ position:fixed; inset:0; background:rgba(2,4,8,.82); display:none; align-items:center; justify-content:center; z-index:10000; }
    .notice{ width:min(680px,96vw); background:#121212; border:1px solid var(--line); border-radius:16px; box-shadow:0 32px 82px rgba(0,0,0,.6); overflow:hidden; }
    .notice-header{ padding:16px 18px; border-bottom:1px solid var(--line); font-size:20px; font-weight:900; }
    .notice-body{ padding:16px 18px; color:#e8edf7; line-height:1.65; }
    .notice-actions{ display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid var(--line); }

    @media (max-width:1200px){
      .grid{ grid-template-columns:1fr 1fr; height:auto; min-height: calc(100vh - 88px); }
      .col:last-child{ grid-column:1 / -1; }
      .trade-panel{ max-height:50vh; }
    }
    @media (max-width:900px){
      .balances{ position:static; transform:none; margin-top:8px; }
      .header{ flex-wrap:wrap; gap:10px; }
      .header .left-tools{ position:static; transform:none; order:1; }
      .grid{ grid-template-columns:1fr; height:auto; }
      .trade-panel{ max-height:none; }
    }
    @media (prefers-reduced-motion:reduce){
      .btn,.back-btn,.help-btn{ transition:none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="left-tools">
      <a href="/historical.html" class="back-btn" title="튜토리얼로">← 튜토리얼로</a>
      <button id="helpBtn" class="help-btn" aria-label="참고사항 다시 보기" title="참고사항 다시 보기">📖</button>
    </div>
    <div class="scenario-wrap">
      <span class="scenario-badge">SCENARIO 03</span>
      <span class="scenario-title">유지장: 횡보 & 거래량 감소</span>
    </div>
    <div class="balances">
      <div class="b-item"><div class="b-label">보유 KRW</div><div class="b-value" id="krwBalance">100,000,000</div></div>
      <div class="b-item"><div class="b-label">총 자산</div><div class="b-value" id="totalAssets">100,000,000</div></div>
      <div class="b-item"><div class="b-label">수익률</div><div class="b-value" id="profitRate">0.00%</div></div>
    </div>
  </div>

  <div class="grid">
    <section class="col" id="leftCol">
      <div class="pane-header">
        <div class="pane-title">
          <span class="badge active" id="badgeBTC">ACTIVE</span>
          <div><div style="font-weight:800;">BTC / KRW</div><div class="sub" id="btcRange">일봉</div></div>
        </div>
        <div class="price-block"><div class="big" id="btcPrice">-</div><div class="sub" id="btcChange">-</div></div>
      </div>
      <div class="chart-wrap">
        <div class="price-box"><canvas id="btcChart" class="chart"></canvas></div>
        <div class="vol-box"><canvas id="btcVol" class="chart"></canvas></div>
      </div>
    </section>

    <section class="col" id="rightCol">
      <div class="pane-header">
        <div class="pane-title">
          <span class="badge" id="badgeXRP">ACTIVE</span>
          <div><div style="font-weight:800;">XRP / KRW</div><div class="sub" id="xrpRange">일봉</div></div>
        </div>
        <div class="price-block"><div class="big" id="xrpPrice">-</div><div class="sub" id="xrpChange">-</div></div>
      </div>
      <div class="chart-wrap">
        <div class="price-box"><canvas id="xrpChart" class="chart"></canvas></div>
        <div class="vol-box"><canvas id="xrpVol" class="chart"></canvas></div>
      </div>
    </section>

    <aside class="col">
      <div class="trade-panel">
        <div class="seg">
          <div class="toolbar">
            <button class="btn" id="playBtn"  aria-pressed="false">▶ 시작</button>
            <button class="btn" id="pauseBtn" aria-pressed="false">⏸ 일시정지</button>
            <button class="btn" id="resetBtn" aria-pressed="false">🔄 리셋</button>
            <div class="timebox" id="timebox">대기중…</div>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">주문 자산 선택</div>
          <div class="tabs">
            <div class="tab active" id="tabBTC">BTC</div>
            <div class="tab" id="tabXRP">XRP</div>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">주문</div>
          <div class="row">
            <div>
              <div class="label">주문 구분</div>
              <select class="input" id="side">
                <option value="buy">매수</option>
                <option value="sell">매도</option>
              </select>
            </div>
            <div>
              <div class="label">체결 단가 (시장가)</div>
              <input class="input" id="price" placeholder="시장가" disabled />
            </div>
          </div>
          <div class="row">
            <div>
              <div class="label">수량</div>
              <input class="input" id="amount" type="number" step="0.00000001" placeholder="0" />
            </div>
            <div>
              <div class="label">주문 총액 (표시=체결, KRW)</div>
              <input class="input" id="total" type="text" placeholder="0" readonly />
            </div>
          </div>
          <div class="pct-row">
            <button class="pct" data-pct="25">25%</button>
            <button class="pct" data-pct="50">50%</button>
            <button class="pct" data-pct="75">75%</button>
            <button class="pct" data-pct="100">MAX</button>
            <input class="input" id="pctInput" type="number" placeholder="직접%" min="0" max="100" />
          </div>
          <div class="warn" id="warn"></div>
          <div class="row" style="grid-template-columns:1fr;">
            <button class="order-btn buy" id="orderBtn">매수</button>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">보유 현황</div>
          <div class="hold">
            <div class="kv"><span>KRW</span><span id="holdKrw">-</span></div>
            <div class="rule"></div>
            <div class="kv"><span>BTC 수량</span><span id="holdBTCQty">-</span></div>
            <div class="kv"><span>BTC 평균단가</span><span id="holdBTCAvg">-</span></div>
            <div class="kv"><span>BTC 평가손익</span><span id="holdBTCPnL">-</span></div>
            <div class="rule"></div>
            <div class="kv"><span>XRP 수량</span><span id="holdXRPQty">-</span></div>
            <div class="kv"><span>XRP 평균단가</span><span id="holdXRPAvg">-</span></div>
            <div class="kv"><span>XRP 평가손익</span><span id="holdXRPPnL">-</span></div>
          </div>
        </div>
      </div>

      <div style="padding:8px 10px; display:flex; justify-content:space-between; color:#a7a7a7; font-size:12px; border-top:1px solid var(--line);">
        <span id="status">시뮬레이션 대기중</span>
        <span id="progress">-</span>
      </div>
    </aside>
  </div>

  <!-- 안내 모달 -->
  <div id="noticeModal" class="notice-backdrop" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
    <div class="notice">
      <div class="notice-header" id="noticeTitle">📖 튜토리얼 진행 전 참고사항</div>
      <div class="notice-body">
        <p><strong>다음의 흐름을 이해하고 튜토리얼을 진행하세요.</strong></p>
        <ol>
          <li>2020년에 SEC가 리플(XRP)을 상대로 소송을 제기했습니다.</li>
          <li>2023년 6월 중순에는 비트코인(BTC) 시장이 단기간 좋아졌습니다.</li>
          <li>2020년에 제기된 소송은 2023년 7월 13일에 판결이 났습니다.</li>
        </ol>
        <p>이러한 사건들은 시장의 흐름을 바꾸며, 선택에 따라 결과가 달라집니다.<br/>
           이제 이러한 흐름 속에서 어떻게 대응해야 최대의 이익을 낼 수 있는지 직접 경험해보세요.</p>
      </div>
      <div class="notice-actions">
        <button class="mbtn primary" id="noticeOkBtn">시작하기</button>
      </div>
    </div>
  </div>

  <!-- 요약 모달 -->
  <div id="summaryModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
    <div class="modal">
      <div class="modal-header">
        <div id="summaryTitle">시뮬레이션 결과 요약</div>
        <button class="mbtn" id="summaryCloseBtn" aria-label="닫기">✕</button>
      </div>
      <div class="modal-body">
        <div class="kv-row"><span>기간</span><strong id="sumRange">-</strong></div>
        <div class="kv-row"><span>최종 총자산</span><strong id="sumTotal">-</strong></div>
        <div class="kv-row"><span>총 수익률</span><strong id="sumPr">-</strong></div>
        <div class="hr"></div>
        <div style="font-weight:800;">보유 내역</div>
        <div class="kv-row"><span>보유 KRW</span><strong id="sumKrw">-</strong></div>
        <div class="kv-row"><span>BTC 수량</span><strong id="sumBTCQty">-</strong></div>
        <div class="kv-row"><span>BTC 평균단가</span><strong id="sumBTCAvg">-</strong></div>
        <div class="kv-row"><span>BTC 평가손익</span><strong id="sumBTCPnL">-</strong></div>
        <div class="kv-row"><span>XRP 수량</span><strong id="sumXRPQty">-</strong></div>
        <div class="kv-row"><span>XRP 평균단가</span><strong id="sumXRPAvg">-</strong></div>
        <div class="kv-row"><span>XRP 평가손익</span><strong id="sumXRPPnL">-</strong></div>
      </div>
      <div class="modal-actions">
        <button class="mbtn" id="summaryOkBtn">닫기</button>
        <button class="mbtn primary" id="summaryResetBtn">리셋하고 다시 시작</button>
      </div>
    </div>
  </div>

  <script>
    const RANGE = { start:"2023-06-01", end:"2023-07-31" };
    const INITIAL_KRW = 100_000_000;
    const TICK_MS = 1000;
    const DECIMALS = { btc:8, xrp:4 };

    const cssVar = n => getComputedStyle(document.documentElement).getPropertyValue(n).trim();
    const CANDLE_UP   = cssVar('--candle-up')   || 'rgba(228,232,240,.75)';
    const CANDLE_DOWN = cssVar('--candle-down') || 'rgba(124,133,146,.75)';
    const VOL_UP      = cssVar('--vol-up')      || 'rgba(228,232,240,.32)';
    const VOL_DOWN    = cssVar('--vol-down')    || 'rgba(124,133,146,.32)';

    const state = {
      activeAsset:'btc',
      running:false, idx:0, dates:[],
      data:{ btc:[], xrp:[] },
      charts:{ btc:null, xrp:null, btcVol:null, xrpVol:null },
      price:{ btc:0, xrp:0 }, prevPrice:{ btc:0, xrp:0 },
      portfolio:{ krw:INITIAL_KRW, btc:{qty:0,cost:0}, xrp:{qty:0,cost:0} },
      timer:null
    };

    async function fetchDaily(asset){
      const res = await fetch(`/api/daily?asset=${asset}&start=${RANGE.start}&end=${RANGE.end}`);
      if(!res.ok) throw new Error(`${asset} 데이터 로딩 실패`);
      const rows = await res.json();
      return rows.map(r=>({
        ts:new Date(r.candle_date_time_kst).getTime(),
        o:+r.opening_price, h:+r.high_price, l:+r.low_price, c:+r.trade_price,
        v:+(r.candle_acc_trade_volume ?? r.volume ?? 0),
        kst:r.candle_date_time_kst
      }));
    }

    function makeCandleChart(ctx){
      return new Chart(ctx,{
        type:'candlestick',
        data:{ datasets:[{ label:'Price', data:[], color:{ up:CANDLE_UP, down:CANDLE_DOWN, unchanged:'#9aa0a6' } }] },
        options:{
          animation:false, responsive:true, maintainAspectRatio:false, parsing:false,
          scales:{
            x:{ type:'time', time:{ unit:'day', tooltipFormat:'yyyy-MM-dd' },
                grid:{ color:'rgba(255,255,255,0.06)', borderColor:'rgba(255,255,255,0.10)' },
                ticks:{ color:'#9aa0a6' } },
            y:{ grid:{ color:'rgba(255,255,255,0.06)', borderColor:'rgba(255,255,255,0.10)' },
                ticks:{ color:'#9aa0a6' } }
          },
          plugins:{ legend:{ display:false }, tooltip:{ intersect:false, mode:'index' } }
        }
      });
    }

    function makeVolumeChart(ctx){
      return new Chart(ctx,{
        type:'bar',
        data:{ datasets:[{ label:'Volume', data:[], backgroundColor:[] }] },
        options:{
          animation:false, parsing:false, responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } },
          scales:{
            x:{ type:'time', time:{ unit:'day' }, grid:{ display:false }, ticks:{ color:'#9aa0a6', maxRotation:0, autoSkip:true } },
            y:{ grid:{ color:'rgba(255,255,255,0.06)' }, ticks:{ color:'#9aa0a6' } }
          }
        }
      });
    }

    function normDay(t){ return new Date(new Date(t).toDateString()).getTime(); }
    function findByDate(arr, dayTs){ return arr.find(d => normDay(d.ts) === dayTs); }

    function redrawCharts(){
      const upto = state.dates.slice(0, state.idx+1);

      ['btc','xrp'].forEach(sym=>{
        const series = upto.map(day=>{ const x = findByDate(state.data[sym], day); return x ? { x:x.ts, o:x.o, h:x.h, l:x.l, c:x.c } : null; }).filter(Boolean);
        state.charts[sym].data.datasets[0].data = series; state.charts[sym].update('none');
      });

      ['btc','xrp'].forEach(sym=>{
        const series = upto.map(day=>{ const x = findByDate(state.data[sym], day); return x ? { x:x.ts, y:x.v, o:x.o, c:x.c } : null; }).filter(Boolean);
        const colors = series.map(d => (d.c >= d.o) ? VOL_UP : VOL_DOWN);
        const key = sym + 'Vol';
        state.charts[key].data.datasets[0].data = series.map(d=>({x:d.x, y:d.y}));
        state.charts[key].data.datasets[0].backgroundColor = colors;
        state.charts[key].update('none');
      });
    }

    function setControlState(mode){
      const play=document.getElementById('playBtn'), pause=document.getElementById('pauseBtn'), reset=document.getElementById('resetBtn');
      [play,pause,reset].forEach(b=>{ b.classList.remove('is-active'); b.setAttribute('aria-pressed','false'); });
      if(mode==='play'){ play.classList.add('is-active'); play.setAttribute('aria-pressed','true'); }
      else if(mode==='pause'){ pause.classList.add('is-active'); pause.setAttribute('aria-pressed','true'); }
    }

    function kstLabel(ts){ const d=new Date(ts); return d.toLocaleDateString('ko-KR',{timeZone:'Asia/Seoul',year:'numeric',month:'2-digit',day:'2-digit'}); }

    function updateHeader(){
      ['btc','xrp'].forEach(sym=>{
        const i=state.idx, day=state.dates[i], bar=findByDate(state.data[sym], day); if(!bar) return;
        state.prevPrice[sym]=state.price[sym]; state.price[sym]=bar.c;
        const priceEl=document.getElementById(sym==='btc'?'btcPrice':'xrpPrice');
        const chgEl  =document.getElementById(sym==='btc'?'btcChange':'xrpChange');
        priceEl.textContent = `${Math.round(bar.c).toLocaleString()} KRW`;
        const prevBar = i>0 ? findByDate(state.data[sym], state.dates[i-1]) : null; const prev = prevBar ? prevBar.c : bar.c;
        const diff = bar.c - prev; const pct = prev ? (diff/prev*100) : 0;
        chgEl.textContent = `${diff>=0?'+':''}${Math.round(diff).toLocaleString()} (${pct.toFixed(2)}%)`;
        chgEl.className = diff>=0 ? 'sub positive' : 'sub negative';
      });
      document.getElementById('timebox').textContent = `시뮬레이션 일자: ${kstLabel(state.dates[state.idx])}`;
      document.getElementById('price').value = Math.round(state.price[state.activeAsset]).toLocaleString();
      calcTotal();
    }

    function updatePortfolioBox(){
      const krw = Math.floor(state.portfolio.krw);
      const pvBTC = state.portfolio.btc.qty * (state.price.btc||0);
      const pvXRP = state.portfolio.xrp.qty * (state.price.xrp||0);
      const total = Math.floor(krw + pvBTC + pvXRP);
      const pr = ((total - INITIAL_KRW)/INITIAL_KRW)*100;

      document.getElementById('krwBalance').textContent = krw.toLocaleString();
      document.getElementById('totalAssets').textContent = total.toLocaleString();
      const prEl=document.getElementById('profitRate'); prEl.textContent=`${pr.toFixed(2)}%`; prEl.className=`b-value ${pr>=0?'positive':'negative'}`;
      document.getElementById('holdKrw').textContent = `${krw.toLocaleString()} 원`;

      const btcAvg = state.portfolio.btc.qty>0 ? (state.portfolio.btc.cost/state.portfolio.btc.qty) : 0;
      const btcPnL = state.portfolio.btc.qty*(state.price.btc||0) - state.portfolio.btc.cost;
      document.getElementById('holdBTCQty').textContent = state.portfolio.btc.qty.toFixed(DECIMALS.btc);
      document.getElementById('holdBTCAvg').textContent = Math.floor(btcAvg).toLocaleString();
      const btcPnLEl=document.getElementById('holdBTCPnL'); btcPnLEl.textContent=`${btcPnL>=0?'+':''}${Math.floor(btcPnL).toLocaleString()} 원`; btcPnLEl.className = btcPnL>=0?'positive':'negative';

      const xrpAvg = state.portfolio.xrp.qty>0 ? (state.portfolio.xrp.cost/state.portfolio.xrp.qty) : 0;
      const xrpPnL = state.portfolio.xrp.qty*(state.price.xrp||0) - state.portfolio.xrp.cost;
      document.getElementById('holdXRPQty').textContent = state.portfolio.xrp.qty.toFixed(DECIMALS.xrp);
      document.getElementById('holdXRPAvg').textContent = Math.floor(xrpAvg).toLocaleString();
      const xrpPnLEl=document.getElementById('holdXRPPnL'); xrpPnLEl.textContent=`${xrpPnL>=0?'+':''}${Math.floor(xrpPnL).toLocaleString()} 원`; xrpPnLEl.className = xrpPnL>=0?'positive':'negative';
    }

    function updateProgress(){ document.getElementById('progress').textContent = `${state.idx+1} / ${state.dates.length} 일`; }
    function updateTick(first=false){ updateHeader(); updatePortfolioBox(); if(!first) redrawCharts(); updateProgress(); }

    function setActiveAsset(asset){
      state.activeAsset = asset;
      document.getElementById('badgeBTC').classList.toggle('active', asset==='btc');
      document.getElementById('badgeXRP').classList.toggle('active', asset==='xrp');
      document.getElementById('tabBTC').classList.toggle('active', asset==='btc');
      document.getElementById('tabXRP').classList.toggle('active', asset==='xrp');

      document.getElementById('price').value = Math.round(state.price[asset]||0).toLocaleString();
      const buy = document.getElementById('side').value==='buy';
      const btn = document.getElementById('orderBtn');
      btn.textContent = buy ? '매수' : '매도';
      btn.classList.toggle('buy', buy);
      btn.classList.toggle('sell', !buy);
      calcTotal();
    }

    function calcTotal(){
      const amount = parseFloat(document.getElementById('amount').value || '0');
      const px = state.price[state.activeAsset] || 0;
      const total = amount * px;
      document.getElementById('total').value = (amount>0 && px>0) ? String(total) : '0';
    }

    function applyPercent(pct){
      const side=document.getElementById('side').value;
      const px=state.price[state.activeAsset]||0; if(px<=0) return;
      const d = DECIMALS[state.activeAsset];
      if(side==='buy'){
        const budget = state.portfolio.krw * (pct/100);
        document.getElementById('amount').value = (budget/px).toFixed(d);
      }else{
        const lot = state.portfolio[state.activeAsset].qty * (pct/100);
        document.getElementById('amount').value = lot.toFixed(d);
      }
      calcTotal();
    }

    function warn(msg){ const w=document.getElementById('warn'); w.textContent=msg||''; w.style.display = msg ? 'block' : 'none'; }

    function placeOrder(){
      warn('');
      const side=document.getElementById('side').value;
      const px=state.price[state.activeAsset]||0;
      const amount=parseFloat(document.getElementById('amount').value||'0');
      if(amount<=0 || px<=0){ warn('수량/가격이 올바르지 않습니다.'); return; }
      const sym=state.activeAsset; const total=amount*px;
      if(side==='buy'){
        if(total > state.portfolio.krw + 1e-9){ warn('보유 KRW가 부족합니다.'); return; }
        state.portfolio.krw -= total; const a=state.portfolio[sym]; a.cost += total; a.qty += amount;
      }else{
        const a=state.portfolio[sym]; if(amount > a.qty + 1e-12){ warn(`${sym.toUpperCase()} 보유 수량이 부족합니다.`); return; }
        const avg = a.qty>0 ? (a.cost/a.qty) : 0; const costOut = avg * amount; a.qty -= amount; a.cost = Math.max(0, a.cost - costOut); state.portfolio.krw += total;
      }
      document.getElementById('amount').value=''; document.getElementById('pctInput').value='';
      calcTotal(); updatePortfolioBox();
      document.getElementById('status').textContent = `${side==='buy'?'매수':'매도'} 체결: ${sym.toUpperCase()} ${amount}`;
      setTimeout(()=>{ document.getElementById('status').textContent = state.running ? '시뮬레이션 실행중' : '시뮬레이션 일시정지'; }, 1200);
    }

    function computeSummary(){
      const krw = Math.floor(state.portfolio.krw);
      const pvBTC = state.portfolio.btc.qty * (state.price.btc || 0);
      const pvXRP = state.portfolio.xrp.qty * (state.price.xrp || 0);
      const total = Math.floor(krw + pvBTC + pvXRP);
      const pr = ((total - INITIAL_KRW) / INITIAL_KRW) * 100;
      const btcAvg = state.portfolio.btc.qty>0 ? (state.portfolio.btc.cost/state.portfolio.btc.qty) : 0;
      const btcPnL = state.portfolio.btc.qty*(state.price.btc||0) - state.portfolio.btc.cost;
      const xrpAvg = state.portfolio.xrp.qty>0 ? (state.portfolio.xrp.cost/state.portfolio.xrp.qty) : 0;
      const xrpPnL = state.portfolio.xrp.qty*(state.price.xrp||0) - state.portfolio.xrp.cost;
      return { total, pr, krw, btcQty:state.portfolio.btc.qty, btcAvg, btcPnL, xrpQty:state.portfolio.xrp.qty, xrpAvg, xrpPnL };
    }

    function openSummaryModal(){
      const s = computeSummary();
      document.getElementById('sumRange').textContent = `${RANGE.start} ~ ${RANGE.end}`;
      document.getElementById('sumTotal').textContent = s.total.toLocaleString() + ' 원';
      const prEl=document.getElementById('sumPr'); prEl.textContent = `${s.pr.toFixed(2)}%`; prEl.className = s.pr>=0 ? 'positive' : 'negative';
      document.getElementById('sumKrw').textContent = s.krw.toLocaleString() + ' 원';
      document.getElementById('sumBTCQty').textContent = s.btcQty.toFixed(DECIMALS.btc);
      document.getElementById('sumBTCAvg').textContent = Math.floor(s.btcAvg).toLocaleString();
      const btcPnLEl=document.getElementById('sumBTCPnL'); btcPnLEl.textContent = `${s.btcPnL>=0?'+':''}${Math.floor(s.btcPnL).toLocaleString()} 원`; btcPnLEl.className = s.btcPnL>=0 ? 'positive' : 'negative';
      document.getElementById('sumXRPQty').textContent = s.xrpQty.toFixed(DECIMALS.xrp);
      document.getElementById('sumXRPAvg').textContent = Math.floor(s.xrpAvg).toLocaleString();
      const xrpPnLEl=document.getElementById('sumXRPPnL'); xrpPnLEl.textContent = `${s.xrpPnL>=0?'+':''}${Math.floor(s.xrpPnL).toLocaleString()} 원`; xrpPnLEl.className = s.xrpPnL>=0 ? 'positive' : 'negative';
      document.getElementById('summaryModal').style.display = 'flex';
    }
    function closeSummaryModal(){ document.getElementById('summaryModal').style.display='none'; }
    function finishSim(){ pause(); document.getElementById('status').textContent='시뮬레이션 완료'; openSummaryModal(); }

    function openNotice(){ document.getElementById('noticeModal').style.display='flex'; }
    function closeNotice(){ document.getElementById('noticeModal').style.display='none'; }

    function play(){
      if(state.running) return; state.running = true; document.getElementById('status').textContent = '시뮬레이션 실행중'; setControlState('play');
      state.charts.btcVol.data.datasets[0].hidden = false;
      state.charts.xrpVol.data.datasets[0].hidden = false;
      state.charts.btcVol.update('none');
      state.charts.xrpVol.update('none');
      state.timer = setInterval(()=>{ if(state.idx >= state.dates.length-1){ finishSim(); return; } state.idx += 1; updateTick(); }, TICK_MS);
    }
    function pause(){ state.running=false; if(state.timer) clearInterval(state.timer); document.getElementById('status').textContent = '시뮬레이션 일시정지'; setControlState('pause'); }
    function resetSim(){
      pause(); state.idx=0; state.portfolio = { krw:INITIAL_KRW, btc:{qty:0, cost:0}, xrp:{qty:0, cost:0} };
      redrawCharts(); updateTick(true); document.getElementById('status').textContent='리셋 완료';
      state.charts.btcVol.data.datasets[0].hidden = true; state.charts.btcVol.update('none');
      state.charts.xrpVol.data.datasets[0].hidden = true; state.charts.xrpVol.update('none');
    }

    function wireEvents(){
      document.getElementById('leftCol').addEventListener('click', ()=>setActiveAsset('btc'));
      document.getElementById('rightCol').addEventListener('click', ()=>setActiveAsset('xrp'));
      document.getElementById('tabBTC').addEventListener('click', ()=>setActiveAsset('btc'));
      document.getElementById('tabXRP').addEventListener('click', ()=>setActiveAsset('xrp'));

      document.getElementById('side').addEventListener('change',()=>{
        const buy = document.getElementById('side').value==='buy';
        const btn = document.getElementById('orderBtn');
        btn.textContent = buy ? '매수' : '매도';
        btn.classList.toggle('buy', buy);
        btn.classList.toggle('sell', !buy);
        calcTotal();
      });

      document.getElementById('amount').addEventListener('input',calcTotal);
      document.getElementById('pctInput').addEventListener('input',e=>{
        const v = Math.max(0, Math.min(100, parseFloat(e.target.value||'0'))); applyPercent(v);
      });
      document.querySelectorAll('.pct').forEach(b=>b.addEventListener('click',()=>applyPercent(parseInt(b.dataset.pct,10))));
      document.getElementById('orderBtn').addEventListener('click',placeOrder);
      document.getElementById('playBtn').addEventListener('click',play);
      document.getElementById('pauseBtn').addEventListener('click',pause);
      document.getElementById('resetBtn').addEventListener('click',resetSim);

      document.getElementById('summaryCloseBtn').addEventListener('click',closeSummaryModal);
      document.getElementById('summaryOkBtn').addEventListener('click',closeSummaryModal);
      document.getElementById('summaryResetBtn').addEventListener('click',()=>{ closeSummaryModal(); resetSim(); });

      document.getElementById('noticeOkBtn').addEventListener('click',closeNotice);
      document.getElementById('helpBtn').addEventListener('click',openNotice);
    }

    async function init(){
      try{
        document.getElementById('status').textContent = '데이터 로딩 중…';
        document.getElementById('btcRange').textContent = `일봉(${RANGE.start} ~ ${RANGE.end})`;
        document.getElementById('xrpRange').textContent = `일봉(${RANGE.start} ~ ${RANGE.end})`;

        const [btc, xrp] = await Promise.all([fetchDaily('btc'), fetchDaily('xrp')]);
        state.data.btc = btc; state.data.xrp = xrp;

        const btcDays = new Set(btc.map(d=>normDay(d.ts)));
        const xrpDays = new Set(xrp.map(d=>normDay(d.ts)));
        const common = [...btcDays].filter(x=>xrpDays.has(x)).sort((a,b)=>a-b);
        if(!common.length) throw new Error('공통 일자가 없습니다. DB 일자 범위를 확인하세요.');
        state.dates = common;

        state.charts.btc    = makeCandleChart(document.getElementById('btcChart').getContext('2d'));
        state.charts.xrp    = makeCandleChart(document.getElementById('xrpChart').getContext('2d'));
        state.charts.btcVol = makeVolumeChart(document.getElementById('btcVol').getContext('2d'));
        state.charts.xrpVol = makeVolumeChart(document.getElementById('xrpVol').getContext('2d'));

        state.charts.btcVol.data.datasets[0].hidden = true; state.charts.btcVol.update('none');
        state.charts.xrpVol.data.datasets[0].hidden = true; state.charts.xrpVol.update('none');

        redrawCharts();
        updateTick(true); updatePortfolioBox(); updateHeader(); updateProgress();
        wireEvents();
        document.getElementById('status').textContent = '시뮬레이션 대기중';
      }catch(e){
        document.getElementById('status').textContent = '로딩 오류';
        console.error(e); alert(e.message);
      }
    }
    init();

    window.addEventListener('load', ()=>{ document.getElementById('noticeModal').style.display='flex'; });
  </script>
</body>
</html>
