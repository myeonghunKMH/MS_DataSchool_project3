<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹œë‚˜ë¦¬ì˜¤3 | ìœ ì§€ì¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Charts (candlestick) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>

  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#0a0a0a;
      --border:#262626;
      --muted:#a0a0a0;
      --accent:#ffffff;

      /* ìº”ë“¤ ìƒ‰ìƒ: #d64d50 / #5d94d8 */
      --red-rgba:  rgba(214, 77, 80, 0.70);
      --blue-rgba: rgba( 93,148,216, 0.70);

      --white:#fff;
      --font-sm:12px; --font-md:14px; --font-lg:18px; --font-xl:20px;
      --radius:8px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--white);
    }

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:center;
      padding:10px 14px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      position:relative; gap:8px;
    }
    .back-btn{
      position:absolute; left:10px; top:8px;
      padding:6px 10px; background:transparent; border:1px solid #2a2a2a; border-radius:var(--radius);
      color:#e8e8e8; text-decoration:none; font-size:var(--font-md); font-weight:600;
      transition:border-color .15s ease, filter .15s ease; backdrop-filter: blur(2px);
    }
    .back-btn:hover{ border-color:#3a3a3a; filter:brightness(1.08); }

    /* ğŸ“– ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ */
    .help-btn{
      position:absolute; left:140px; top:8px;
      padding:6px 10px; background:transparent; border:1px solid #2a2a2a; border-radius:var(--radius);
      color:#e8e8e8; font-size:18px; line-height:1; cursor:pointer;
      transition:border-color .15s ease, filter .15s ease; backdrop-filter: blur(2px);
    }
    .help-btn:hover{ border-color:#3a3a3a; filter:brightness(1.08); }

    .logo{ font-size:var(--font-xl); font-weight:800; color:var(--accent); }

    .balances{
      position:absolute; right:10px; top:8px;
      display:flex; gap:14px;
    }
    .b-item{ text-align:right; }
    .b-label{ font-size:var(--font-sm); color:var(--muted) }
    .b-value{ font-size:var(--font-lg); font-weight:700; }
    .positive{ color:var(--red-rgba); }
    .negative{ color:var(--blue-rgba); }

    /* Grid: ì¢Œ BTC / ìš° XRP / ìš°ì¸¡ íŒ¨ë„ */
    .grid{
      display:grid; gap:1px; background:var(--border);
      grid-template-columns: 1.1fr 1.1fr 0.8fr;
      height: calc(100vh - 65px);
    }
    .col{ background:var(--panel); display:flex; flex-direction:column; min-width:0; }

    .pane-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border-bottom:1px solid var(--border);
    }
    .pane-title{ display:flex; align-items:center; gap:8px; }
    .badge{ font-size:var(--font-sm); padding:2px 6px; border-radius:6px; border:1px solid var(--border); color:var(--muted); background:transparent; }
    .badge.active{ border-color:var(--accent); color:var(--accent); }
    .price-block{ text-align:right; }
    .big{ font-size:var(--font-lg); font-weight:700; }
    .sub{ font-size:var(--font-sm); color:var(--muted); }

    .chart-wrap{ flex:1; padding:8px; min-height:0; display:flex; flex-direction:column; gap:6px; }
    .price-box{ position:relative; flex:1; }
    .vol-box{ position:relative; height:110px; }
    .chart{ width:100%; height:100%; display:block; }

    /* Sim toolbar */
    .sim-toolbar{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border-top:1px solid var(--border); border-bottom:1px solid var(--border); background:#121212;
    }
    .btn{
      padding:8px 14px; border-radius:10px; font-weight:700; font-size:14px;
      border:1px solid #2a2a2a; background:linear-gradient(180deg,#1a1a1a,#141414);
      color:#eaeaea; transition: transform .06s ease, box-shadow .12s ease, background .2s ease, border-color .2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,.25); cursor:pointer;
    }
    .btn:hover{ box-shadow: 0 6px 16px rgba(0,0,0,.35); border-color:#3a3a3a; }
    .btn:active{ transform: translateY(1px); box-shadow: 0 2px 8px rgba(0,0,0,.25) inset; }
    .btn.is-active{ background: linear-gradient(180deg, #3A7AFE, #2e64d4); border-color: rgba(255,255,255,.25); color:#ffffff; box-shadow: 0 10px 24px rgba(58,122,254,.35); }
    .timebox{ margin-left:auto; font-family:monospace; color:#d0d7ff; }

    /* Trade panel */
    .trade-panel{ padding:12px; display:flex; flex-direction:column; gap:12px; overflow:auto; }
    .seg{ display:grid; gap:6px; }
    .seg-title{ font-weight:700; border-bottom:1px solid var(--border); padding-bottom:6px; font-size:var(--font-md); }
    .tabs{ display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .tab{
      padding:8px 10px; border:1px solid var(--border); background:rgba(17,17,17,.85);
      color:var(--muted); cursor:pointer; text-align:center; border-radius:6px; transition: filter .15s ease, border-color .15s ease;
    }
    .tab:hover{ filter:brightness(1.05); border-color:#3a3a3a; }
    .tab.active{ color:#0a0f1a; background:var(--accent); border-color:var(--accent); font-weight:800; }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .label{ font-size:var(--font-sm); color:var(--muted); }
    .input{
      width:100%; padding:8px 10px; border:1px solid var(--border);
      background:rgba(17,17,17,.85); color:#fff; border-radius:6px; font-size:var(--font-md); outline:none;
    }
    .input:focus{ border-color:#3a3a3a; }

    /* ìˆ«ì ì…ë ¥ ìŠ¤í”¼ë„ˆ ì œê±° */
    #amount::-webkit-outer-spin-button, #amount::-webkit-inner-spin-button,
    #pctInput::-webkit-outer-spin-button, #pctInput::-webkit-inner-spin-button { -webkit-appearance: none !important; margin: 0; background: transparent !important; border: none !important; }
    #amount, #pctInput { -moz-appearance: textfield; }

    /* ì´ì•¡: í‘œì‹œ=ì²´ê²° â†’ textë¡œ ê³ ì •(ì½¤ë§ˆ X) */
    #total{ width:100% }

    .pct-row{ display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
    .pct{
      padding:6px; border:1px solid var(--border); background:rgba(17,17,17,.85); color:var(--muted);
      border-radius:6px; cursor:pointer; font-size:var(--font-sm); transition: filter .15s ease, border-color .15s ease; text-align:center;
    }
    .pct:hover{ filter:brightness(1.05); border-color:#3a3a3a; }

    .order-btn{
      width:100%; padding:10px; border-radius:8px; font-weight:800; border:0; cursor:pointer;
      transition: filter .15s ease, transform .06s ease, box-shadow .12s ease; box-shadow: 0 4px 12px rgba(0,0,0,.18);
      background:#ffffff; color:#0b0b0b; border:1px solid #d9d9d9;
    }
    .order-btn:hover{ filter:brightness(0.96); }
    .order-btn:active{ transform:translateY(1px); box-shadow: 0 2px 8px rgba(0,0,0,.18) inset; }

    .warn{ font-size:var(--font-sm); color:#f08585; background:rgba(229,62,62,0.08); padding:8px; border-radius:6px; display:none; border:1px dashed rgba(229,62,62,0.15); }

    .hold{ display:grid; gap:6px; }
    .kv{ display:flex; justify-content:space-between; font-size:var(--font-md); }
    .rule{ height:1px; background:var(--border); margin:4px 0; }

    /* ===== Summary Modal ===== */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.5);
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .modal{
      width: min(560px, 92vw);
      background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55); overflow: hidden;
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; border-bottom:1px solid var(--border); font-weight:800; font-size:var(--font-lg);
    }
    .modal-body{ padding: 14px 16px; display:grid; gap:10px; }
    .kv-row{ display:flex; justify-content:space-between; }
    .hr{ height:1px; background:var(--border); margin:6px 0; }
    .modal-actions{
      display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid var(--border);
    }
    .mbtn{
      padding:8px 12px; border-radius:8px; border:1px solid #2a2a2a; background:#1a1a1a; color:#fff; cursor:pointer;
    }
    .mbtn.primary{ background:#ffffff; color:#0b0b0b; border-color:#d9d9d9; font-weight:800; }

    /* ===== Notice (íŠœí† ë¦¬ì–¼ ì‚¬ì „ ì•ˆë‚´) Modal ===== */
    .notice-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.88);
      display: none; align-items: center; justify-content: center; z-index: 10000;
    }
    .notice{
      width: min(680px, 94vw);
      background: #0f0f0f; border:1px solid #2b2b2b; border-radius:14px;
      box-shadow: 0 24px 64px rgba(0,0,0,.65); overflow:hidden;
    }
    .notice-header{
      padding:16px 18px; border-bottom:1px solid var(--border);
      font-size:20px; font-weight:800;
    }
    .notice-body{
      padding:16px 18px; color:#e8e8e8; line-height:1.6;
    }
    .notice-body p{ margin:0 0 8px 0; color:#cfcfcf; }
    .notice-body ol{ margin:8px 0 12px 20px; }
    .notice-body li{ margin:6px 0; }
    .notice-actions{
      display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="/historical.html" class="back-btn" title="íŠœí† ë¦¬ì–¼ë¡œ">â† íŠœí† ë¦¬ì–¼ë¡œ</a>
    <button id="helpBtn" class="help-btn" aria-label="ì°¸ê³ ì‚¬í•­ ë‹¤ì‹œ ë³´ê¸°" title="ì°¸ê³ ì‚¬í•­ ë‹¤ì‹œ ë³´ê¸°">ğŸ“–</button>
    <div class="logo">â†ª ìœ ì§€ì¥ : íš¡ë³´ & ê±°ë˜ëŸ‰ ê°ì†Œ</div>
    <div class="balances">
      <div class="b-item"><div class="b-label">ë³´ìœ  KRW</div><div class="b-value" id="krwBalance">100,000,000</div></div>
      <div class="b-item"><div class="b-label">ì´ ìì‚°</div><div class="b-value" id="totalAssets">100,000,000</div></div>
      <div class="b-item"><div class="b-label">ìˆ˜ìµë¥ </div><div class="b-value" id="profitRate">0.00%</div></div>
    </div>
  </div>

  <div class="grid">
    <!-- ì¢Œ: BTC -->
    <section class="col" id="leftCol">
      <div class="pane-header">
        <div class="pane-title">
          <span class="badge active" id="badgeBTC">ACTIVE</span>
          <div>
            <div style="font-weight:700;">BTC / KRW</div>
            <div class="sub" id="btcRange">ì¼ë´‰</div>
          </div>
        </div>
        <div class="price-block">
          <div class="big" id="btcPrice">-</div>
          <div class="sub" id="btcChange">-</div>
        </div>
      </div>

      <!-- ì°¨íŠ¸(ìœ„: ìº”ë“¤ / ì•„ë˜: ê±°ë˜ëŸ‰) -->
      <div class="chart-wrap">
        <div class="price-box"><canvas id="btcChart" class="chart"></canvas></div>
        <div class="vol-box"><canvas id="btcVol" class="chart"></canvas></div>
      </div>
    </section>

    <!-- ìš°: XRP -->
    <section class="col" id="rightCol">
      <div class="pane-header">
        <div class="pane-title">
          <span class="badge" id="badgeXRP">ACTIVE</span>
          <div>
            <div style="font-weight:700;">XRP / KRW</div>
            <div class="sub" id="xrpRange">ì¼ë´‰</div>
          </div>
        </div>
        <div class="price-block">
          <div class="big" id="xrpPrice">-</div>
          <div class="sub" id="xrpChange">-</div>
        </div>
      </div>

      <!-- ì°¨íŠ¸(ìœ„: ìº”ë“¤ / ì•„ë˜: ê±°ë˜ëŸ‰) -->
      <div class="chart-wrap">
        <div class="price-box"><canvas id="xrpChart" class="chart"></canvas></div>
        <div class="vol-box"><canvas id="xrpVol" class="chart"></canvas></div>
      </div>
    </section>

    <!-- ê±°ë˜/ë³´ìœ  íŒ¨ë„ (ê·¸ëŒ€ë¡œ) -->
    <aside class="col">
      <div class="sim-toolbar">
        <button class="btn" id="playBtn"  aria-pressed="false">â–¶ ì‹œì‘</button>
        <button class="btn" id="pauseBtn" aria-pressed="false">â¸ ì¼ì‹œì •ì§€</button>
        <button class="btn" id="resetBtn" aria-pressed="false">ğŸ”„ ë¦¬ì…‹</button>
        <div class="timebox" id="timebox">ëŒ€ê¸°ì¤‘â€¦</div>
      </div>

      <div class="trade-panel">
        <div class="seg">
          <div class="seg-title">ì£¼ë¬¸ ìì‚° ì„ íƒ</div>
          <div class="tabs">
            <div class="tab active" id="tabBTC">BTC</div>
            <div class="tab" id="tabXRP">XRP</div>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">ì£¼ë¬¸</div>
          <div class="row">
            <div>
              <div class="label">ì£¼ë¬¸ êµ¬ë¶„</div>
              <select class="input" id="side">
                <option value="buy">ë§¤ìˆ˜</option>
                <option value="sell">ë§¤ë„</option>
              </select>
            </div>
            <div>
              <div class="label">ì²´ê²° ë‹¨ê°€ (ì‹œì¥ê°€)</div>
              <input class="input" id="price" placeholder="ì‹œì¥ê°€" disabled />
            </div>
          </div>

          <div class="row">
            <div>
              <div class="label">ìˆ˜ëŸ‰</div>
              <input class="input" id="amount" type="number" step="0.00000001" placeholder="0" />
            </div>
            <div>
              <div class="label">ì£¼ë¬¸ ì´ì•¡ (í‘œì‹œ=ì²´ê²°, KRW)</div>
              <input class="input" id="total" type="text" placeholder="0" readonly />
            </div>
          </div>

          <div class="pct-row">
            <button class="pct" data-pct="25">25%</button>
            <button class="pct" data-pct="50">50%</button>
            <button class="pct" data-pct="75">75%</button>
            <button class="pct" data-pct="100">MAX</button>
            <input class="input" id="pctInput" type="number" placeholder="ì§ì ‘%" min="0" max="100" />
          </div>

          <div class="warn" id="warn"></div>

          <div class="row" style="grid-template-columns:1fr;">
            <button class="order-btn" id="orderBtn">ë§¤ìˆ˜</button>
          </div>
        </div>

        <div class="seg">
          <div class="seg-title">ë³´ìœ  í˜„í™©</div>
          <div class="hold">
            <div class="kv"><span>KRW</span><span id="holdKrw">-</span></div>
            <div class="rule"></div>
            <div class="kv"><span>BTC ìˆ˜ëŸ‰</span><span id="holdBTCQty">-</span></div>
            <div class="kv"><span>BTC í‰ê· ë‹¨ê°€</span><span id="holdBTCAvg">-</span></div>
            <div class="kv"><span>BTC í‰ê°€ì†ìµ</span><span id="holdBTCPnL">-</span></div>
            <div class="rule"></div>
            <div class="kv"><span>XRP ìˆ˜ëŸ‰</span><span id="holdXRPQty">-</span></div>
            <div class="kv"><span>XRP í‰ê· ë‹¨ê°€</span><span id="holdXRPAvg">-</span></div>
            <div class="kv"><span>XRP í‰ê°€ì†ìµ</span><span id="holdXRPPnL">-</span></div>
          </div>
        </div>
      </div>

      <div style="padding:8px 10px; display:flex; justify-content:space-between; color:#a7a7a7; font-size:12px; border-top:1px solid var(--border);">
        <span id="status">ì‹œë®¬ë ˆì´ì…˜ ëŒ€ê¸°ì¤‘</span>
        <span id="progress">-</span>
      </div>
    </aside>
  </div>

  <!-- ===== NOTICE MODAL (íŠœí† ë¦¬ì–¼ ì‹œì‘ ì „ ì•ˆë‚´) ===== -->
  <div id="noticeModal" class="notice-backdrop" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
    <div class="notice">
      <div class="notice-header" id="noticeTitle">ğŸ“– íŠœí† ë¦¬ì–¼ ì§„í–‰ ì „ ì°¸ê³ ì‚¬í•­</div>
      <div class="notice-body">
        <p><strong>ë‹¤ìŒì˜ íë¦„ì„ ì´í•´í•˜ê³  íŠœí† ë¦¬ì–¼ì„ ì§„í–‰í•˜ì„¸ìš”.</strong></p>
        <ol>
          <li>2020ë…„ì— SECê°€ ë¦¬í”Œ(XRP)ì„ ìƒëŒ€ë¡œ ì†Œì†¡ì„ ì œê¸°í–ˆìŠµë‹ˆë‹¤.</li>
          <li>2023ë…„ 6ì›” ì¤‘ìˆœì—ëŠ” ë¹„íŠ¸ì½”ì¸(BTC) ì‹œì¥ì´ ë‹¨ê¸°ê°„ ì¢‹ì•„ì¡ŒìŠµë‹ˆë‹¤.</li>
          <li>2020ë…„ì— ì œê¸°ëœ ì†Œì†¡ì€ 2023ë…„ 7ì›” 13ì¼ì— íŒê²°ì´ ë‚¬ìŠµë‹ˆë‹¤.</li>
        </ol>
        <p>ì´ëŸ¬í•œ ì‚¬ê±´ë“¤ì€ ì‹œì¥ì˜ íë¦„ì„ ë°”ê¾¸ë©°, ì„ íƒì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤. <br />
          ì´ì œ ì´ëŸ¬í•œ íë¦„ ì†ì—ì„œ ì–´ë–»ê²Œ ëŒ€ì‘í•´ì•¼ ìµœëŒ€ì˜ ì´ìµì„ ë‚¼ ìˆ˜ ìˆëŠ”ì§€ ì§ì ‘ ê²½í—˜í•´ë³´ì„¸ìš”.</p>
      </div>
      <div class="notice-actions">
        <button class="mbtn primary" id="noticeOkBtn">ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ===== SUMMARY MODAL ===== -->
  <div id="summaryModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
    <div class="modal">
      <div class="modal-header">
        <div id="summaryTitle">ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ìš”ì•½</div>
        <button class="mbtn" id="summaryCloseBtn" aria-label="ë‹«ê¸°">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="kv-row"><span>ê¸°ê°„</span><strong id="sumRange">-</strong></div>
        <div class="kv-row"><span>ìµœì¢… ì´ìì‚°</span><strong id="sumTotal">-</strong></div>
        <div class="kv-row"><span>ì´ ìˆ˜ìµë¥ </span><strong id="sumPr">-</strong></div>
        <div class="hr"></div>
        <div style="font-weight:700;">ë³´ìœ  ë‚´ì—­</div>
        <div class="kv-row"><span>ë³´ìœ  KRW</span><strong id="sumKrw">-</strong></div>

        <div class="kv-row"><span>BTC ìˆ˜ëŸ‰</span><strong id="sumBTCQty">-</strong></div>
        <div class="kv-row"><span>BTC í‰ê· ë‹¨ê°€</span><strong id="sumBTCAvg">-</strong></div>
        <div class="kv-row"><span>BTC í‰ê°€ì†ìµ</span><strong id="sumBTCPnL">-</strong></div>

        <div class="kv-row"><span>XRP ìˆ˜ëŸ‰</span><strong id="sumXRPQty">-</strong></div>
        <div class="kv-row"><span>XRP í‰ê· ë‹¨ê°€</span><strong id="sumXRPAvg">-</strong></div>
        <div class="kv-row"><span>XRP í‰ê°€ì†ìµ</span><strong id="sumXRPPnL">-</strong></div>
      </div>

      <div class="modal-actions">
        <button class="mbtn" id="summaryOkBtn">ë‹«ê¸°</button>
        <button class="mbtn primary" id="summaryResetBtn">ë¦¬ì…‹í•˜ê³  ë‹¤ì‹œ ì‹œì‘</button>
      </div>
    </div>
  </div>

  <script>
    /** ===== ë°ì´í„° ë²”ìœ„ & ê³ ì •ê°’ ===== */
    const RANGE = { start: "2023-06-01", end: "2023-07-31" };
    const INITIAL_KRW = 100_000_000;

    /** ===== ì¬ìƒ ì†ë„(ms) ===== */
    const TICK_MS = 1000;

    /** ===== ì •ë°€ë„ ===== */
    const DECIMALS = { btc: 8, xrp: 4 };
    const fmtRaw = (x) => String(Number.isFinite(x) ? x : 0);

    /** ===== ìº”ë“¤ ìƒ‰ìƒ ===== */
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    const CANDLE_UP = cssVar('--red-rgba')  || 'rgba(214,77,80,0.70)';
    const CANDLE_DOWN = cssVar('--blue-rgba') || 'rgba(93,148,216,0.70)';

    /** ===== ìƒíƒœ ===== */
    const state = {
      activeAsset:'btc',
      running:false,
      idx:0,
      dates:[],
      data:{ btc:[], xrp:[] },
      charts:{ btc:null, xrp:null, btcVol:null, xrpVol:null },  // â–¼ volume ì°¨íŠ¸ ìŠ¬ë¡¯
      price:{ btc:0, xrp:0 },
      prevPrice:{ btc:0, xrp:0 },
      portfolio:{ krw: INITIAL_KRW, btc:{ qty:0, cost:0 }, xrp:{ qty:0, cost:0 } },
      timer:null
    };

    /** ===== API ===== */
    async function fetchDaily(asset){
      const url = `/api/daily?asset=${asset}&start=${RANGE.start}&end=${RANGE.end}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`${asset} ë°ì´í„° ë¡œë”© ì‹¤íŒ¨`);
      const rows = await res.json();
      return rows.map(r => ({
        ts: new Date(r.candle_date_time_kst).getTime(),
        o:  Number(r.opening_price),
        h:  Number(r.high_price),
        l:  Number(r.low_price),
        c:  Number(r.trade_price),
        v:  Number(r.candle_acc_trade_volume ?? r.volume ?? 0),  // â–¼ ê±°ë˜ëŸ‰ í•œ ì¤„
        kst: r.candle_date_time_kst
      }));
    }

    /** ===== ì°¨íŠ¸ ===== */
    function makeCandleChart(ctx){
      return new Chart(ctx,{
        type:'candlestick',
        data:{ datasets:[{ label:'Price', data:[], color:{ up:CANDLE_UP, down:CANDLE_DOWN, unchanged:'#999' } }] },
        options:{
          animation:false, responsive:true, maintainAspectRatio:false, parsing:false,
          scales:{
            x:{ type:'time', time:{ unit:'day', tooltipFormat:'yyyy-MM-dd' },
                grid:{ color:'rgba(255,255,255,0.06)', borderColor:'rgba(255,255,255,0.10)' }, ticks:{ color:'#9aa0a6' } },
            y:{ grid:{ color:'rgba(255,255,255,0.06)', borderColor:'rgba(255,255,255,0.10)' }, ticks:{ color:'#9aa0a6' } }
          },
          plugins:{ legend:{ display:false }, tooltip:{ intersect:false, mode:'index' } }
        }
      });
    }

    function makeVolumeChart(ctx){
      return new Chart(ctx,{
        type:'bar',
        data:{ datasets:[{ label:'Volume', data:[], backgroundColor:[] }] },
        options:{
          animation:false, parsing:false, responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } },
          scales:{
            x:{ type:'time', time:{ unit:'day' }, grid:{ display:false }, ticks:{ color:'#9aa0a6', maxRotation:0, autoSkip:true } },
            y:{ grid:{ color:'rgba(255,255,255,0.06)' }, ticks:{ color:'#9aa0a6' } }
          }
        }
      });
    }

    function normDay(t){ return new Date(new Date(t).toDateString()).getTime(); }
    function findByDate(arr, dayTs){ return arr.find(d => normDay(d.ts) === dayTs); }

    function redrawCharts(){
      const upto = state.dates.slice(0, state.idx+1);

      // ê°€ê²©
      ['btc','xrp'].forEach(sym=>{
        const series = upto.map(day=>{
          const x = findByDate(state.data[sym], day);
          return x ? { x:x.ts, o:x.o, h:x.h, l:x.l, c:x.c } : null;
        }).filter(Boolean);
        state.charts[sym].data.datasets[0].data = series;
        state.charts[sym].update('none');
      });

      // ê±°ë˜ëŸ‰
      ['btc','xrp'].forEach(sym=>{
        const series = upto.map(day=>{
          const x = findByDate(state.data[sym], day);
          return x ? { x:x.ts, y:x.v, o:x.o, c:x.c } : null;
        }).filter(Boolean);
        const colors = series.map(d => (d.c >= d.o) ? 'rgba(214,77,80,0.45)' : 'rgba(93,148,216,0.45)');

        const key = sym + 'Vol';
        state.charts[key].data.datasets[0].data = series.map(d=>({x:d.x, y:d.y}));
        state.charts[key].data.datasets[0].backgroundColor = colors;
        state.charts[key].update('none');
      });
    }

    /** ===== UI ===== */
    function setControlState(mode){
      const play  = document.getElementById('playBtn');
      const pause = document.getElementById('pauseBtn');
      const reset = document.getElementById('resetBtn');
      [play,pause,reset].forEach(b=>{ b.classList.remove('is-active'); b.setAttribute('aria-pressed','false'); });
      if(mode==='play'){ play.classList.add('is-active'); play.setAttribute('aria-pressed','true'); }
      else if(mode==='pause'){ pause.classList.add('is-active'); pause.setAttribute('aria-pressed','true'); }
    }

    function kstLabel(ts){
      const d=new Date(ts);
      return d.toLocaleDateString('ko-KR',{ timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' });
    }

    function updateHeader(){
      ['btc','xrp'].forEach(sym=>{
        const i=state.idx, day=state.dates[i], bar=findByDate(state.data[sym], day);
        if(!bar) return;
        state.prevPrice[sym]=state.price[sym]; state.price[sym]=bar.c;

        const priceEl = document.getElementById(sym==='btc'?'btcPrice':'xrpPrice');
        const chgEl   = document.getElementById(sym==='btc'?'btcChange':'xrpChange');
        priceEl.textContent = `${Math.round(bar.c).toLocaleString()} KRW`;

        const prevBar = i>0 ? findByDate(state.data[sym], state.dates[i-1]) : null;
        const prev = prevBar ? prevBar.c : bar.c;
        const diff = bar.c - prev;
        const pct = prev ? (diff/prev*100) : 0;
        chgEl.textContent = `${diff>=0?'+':''}${Math.round(diff).toLocaleString()} (${pct.toFixed(2)}%)`;
        chgEl.className = diff >= 0 ? 'sub positive' : 'sub negative';
      });

      document.getElementById('timebox').textContent = `ì‹œë®¬ë ˆì´ì…˜ ì¼ì: ${kstLabel(state.dates[state.idx])}`;
      document.getElementById('price').value = Math.round(state.price[state.activeAsset]).toLocaleString();
      calcTotal();
    }

    function updatePortfolioBox(){
      const krw = Math.floor(state.portfolio.krw);
      const pvBTC = state.portfolio.btc.qty * (state.price.btc || 0);
      const pvXRP = state.portfolio.xrp.qty * (state.price.xrp || 0);
      const total = Math.floor(krw + pvBTC + pvXRP);
      const pr = ((total - INITIAL_KRW)/INITIAL_KRW)*100;

      document.getElementById('krwBalance').textContent = krw.toLocaleString();
      document.getElementById('totalAssets').textContent = total.toLocaleString();

      const prEl = document.getElementById('profitRate');
      prEl.textContent = `${pr.toFixed(2)}%`;
      prEl.className = `b-value ${pr>=0?'positive':'negative'}`;

      document.getElementById('holdKrw').textContent = `${krw.toLocaleString()} ì›`;

      // BTC
      const btcAvg = state.portfolio.btc.qty>0 ? (state.portfolio.btc.cost/state.portfolio.btc.qty):0;
      const btcPnL = state.portfolio.btc.qty*(state.price.btc||0) - state.portfolio.btc.cost;
      document.getElementById('holdBTCQty').textContent = state.portfolio.btc.qty.toFixed(DECIMALS.btc);
      document.getElementById('holdBTCAvg').textContent = Math.floor(btcAvg).toLocaleString();
      const btcPnLEl = document.getElementById('holdBTCPnL');
      btcPnLEl.textContent = `${btcPnL>=0?'+':''}${Math.floor(btcPnL).toLocaleString()} ì›`;
      btcPnLEl.className = btcPnL>=0 ? 'positive':'negative';

      // XRP
      const xrpAvg = state.portfolio.xrp.qty>0 ? (state.portfolio.xrp.cost/state.portfolio.xrp.qty):0;
      const xrpPnL = state.portfolio.xrp.qty*(state.price.xrp||0) - state.portfolio.xrp.cost;
      document.getElementById('holdXRPQty').textContent = state.portfolio.xrp.qty.toFixed(DECIMALS.xrp);
      document.getElementById('holdXRPAvg').textContent = Math.floor(xrpAvg).toLocaleString();
      const xrpPnLEl = document.getElementById('holdXRPPnL');
      xrpPnLEl.textContent = `${xrpPnL>=0?'+':''}${Math.floor(xrpPnL).toLocaleString()} ì›`;
      xrpPnLEl.className = xrpPnL>=0 ? 'positive':'negative';
    }

    function updateProgress(){ document.getElementById('progress').textContent = `${state.idx+1} / ${state.dates.length} ì¼`; }

    function updateTick(first=false){
      updateHeader(); updatePortfolioBox();
      if(!first) redrawCharts();
      updateProgress();
    }

    function setActiveAsset(asset){
      state.activeAsset = asset;
      document.getElementById('badgeBTC').classList.toggle('active', asset==='btc');
      document.getElementById('badgeXRP').classList.toggle('active', asset==='xrp');
      document.getElementById('tabBTC').classList.toggle('active', asset==='btc');
      document.getElementById('tabXRP').classList.toggle('active', asset==='xrp');

      document.getElementById('price').value = Math.round(state.price[asset]||0).toLocaleString();
      const buySide = document.getElementById('side').value === 'buy';
      document.getElementById('orderBtn').textContent = buySide ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
      calcTotal();
    }

    /** ===== ì£¼ë¬¸ ===== */
    function calcTotal(){
      const amount = parseFloat(document.getElementById('amount').value || '0');
      const px = state.price[state.activeAsset] || 0;
      const total = amount * px;
      document.getElementById('total').value = (amount>0 && px>0) ? fmtRaw(total) : '0';
    }

    function applyPercent(pct){
      const side = document.getElementById('side').value;
      const px = state.price[state.activeAsset] || 0;
      if(px<=0) return;
      const d = DECIMALS[state.activeAsset];
      if(side==='buy'){
        const budget = state.portfolio.krw * (pct/100);
        document.getElementById('amount').value = (budget/px).toFixed(d);
      }else{
        const lot = state.portfolio[state.activeAsset].qty * (pct/100);
        document.getElementById('amount').value = lot.toFixed(d);
      }
      calcTotal();
    }

    function warn(msg){
      const w=document.getElementById('warn');
      w.textContent = msg||''; w.style.display = msg ? 'block':'none';
    }

    function placeOrder(){
      warn('');
      const side = document.getElementById('side').value;
      const px = state.price[state.activeAsset] || 0;
      const amount = parseFloat(document.getElementById('amount').value || '0');
      if(amount<=0 || px<=0){ warn('ìˆ˜ëŸ‰/ê°€ê²©ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

      const sym = state.activeAsset;
      const total = amount*px;

      if(side==='buy'){
        if(total > state.portfolio.krw + 1e-9){ warn('ë³´ìœ  KRWê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; }
        state.portfolio.krw -= total;
        const a = state.portfolio[sym];
        a.cost += total; a.qty += amount;
      }else{
        const a = state.portfolio[sym];
        if(amount > a.qty + 1e-12){ warn(`${sym.toUpperCase()} ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.`); return; }
        const avg = a.qty>0 ? (a.cost/a.qty) : 0;
        const costOut = avg * amount;
        a.qty -= amount;
        a.cost = Math.max(0, a.cost - costOut);
        state.portfolio.krw += total;
      }

      document.getElementById('amount').value=''; document.getElementById('pctInput').value='';
      calcTotal(); updatePortfolioBox();
      document.getElementById('status').textContent = `${side==='buy'?'ë§¤ìˆ˜':'ë§¤ë„'} ì²´ê²°: ${sym.toUpperCase()} ${amount}`;
      setTimeout(()=>{ document.getElementById('status').textContent = state.running?'ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ì¤‘':'ì‹œë®¬ë ˆì´ì…˜ ì¼ì‹œì •ì§€'; },1200);
    }

    /** ===== ìš”ì•½ ê³„ì‚° & ëª¨ë‹¬ ===== */
    function computeSummary(){
      const krw = Math.floor(state.portfolio.krw);
      const pvBTC = state.portfolio.btc.qty * (state.price.btc || 0);
      const pvXRP = state.portfolio.xrp.qty * (state.price.xrp || 0);
      const total = Math.floor(krw + pvBTC + pvXRP);
      const pr = ((total - INITIAL_KRW) / INITIAL_KRW) * 100;

      const btcAvg = state.portfolio.btc.qty>0 ? (state.portfolio.btc.cost/state.portfolio.btc.qty):0;
      const btcPnL = state.portfolio.btc.qty*(state.price.btc||0) - state.portfolio.btc.cost;

      const xrpAvg = state.portfolio.xrp.qty>0 ? (state.portfolio.xrp.cost/state.portfolio.xrp.qty):0;
      const xrpPnL = state.portfolio.xrp.qty*(state.price.xrp||0) - state.portfolio.xrp.cost;

      return {
        total, pr, krw,
        btcQty: state.portfolio.btc.qty, btcAvg, btcPnL,
        xrpQty: state.portfolio.xrp.qty, xrpAvg, xrpPnL
      };
    }

    function openSummaryModal(){
      const s = computeSummary();
      document.getElementById('sumRange').textContent = `${RANGE.start} ~ ${RANGE.end}`;
      document.getElementById('sumTotal').textContent = s.total.toLocaleString() + ' ì›';

      const prEl = document.getElementById('sumPr');
      prEl.textContent = `${s.pr.toFixed(2)}%`;
      prEl.className = s.pr >= 0 ? 'positive' : 'negative';

      document.getElementById('sumKrw').textContent = s.krw.toLocaleString() + ' ì›';

      document.getElementById('sumBTCQty').textContent = s.btcQty.toFixed(DECIMALS.btc);
      document.getElementById('sumBTCAvg').textContent = Math.floor(s.btcAvg).toLocaleString();
      const btcPnLEl = document.getElementById('sumBTCPnL');
      btcPnLEl.textContent = `${s.btcPnL>=0?'+':''}${Math.floor(s.btcPnL).toLocaleString()} ì›`;
      btcPnLEl.className = s.btcPnL >= 0 ? 'positive' : 'negative';

      document.getElementById('sumXRPQty').textContent = s.xrpQty.toFixed(DECIMALS.xrp);
      document.getElementById('sumXRPAvg').textContent = Math.floor(s.xrpAvg).toLocaleString();
      const xrpPnLEl = document.getElementById('sumXRPPnL');
      xrpPnLEl.textContent = `${s.xrpPnL>=0?'+':''}${Math.floor(s.xrpPnL).toLocaleString()} ì›`;
      xrpPnLEl.className = s.xrpPnL >= 0 ? 'positive' : 'negative';

      document.getElementById('summaryModal').style.display = 'flex';
    }
    function closeSummaryModal(){ document.getElementById('summaryModal').style.display = 'none'; }
    function finishSim(){ pause(); document.getElementById('status').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ'; openSummaryModal(); }

    /** ===== Notice Modal control ===== */
    function openNotice(){ document.getElementById('noticeModal').style.display = 'flex'; }
    function closeNotice(){ document.getElementById('noticeModal').style.display = 'none'; }

    /** ===== ì»¨íŠ¸ë¡¤ ===== */
    function play(){
      if(state.running) return;
      state.running = true; document.getElementById('status').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ì¤‘'; setControlState('play');
      state.timer = setInterval(()=>{
        if(state.idx >= state.dates.length-1){ finishSim(); return; }
        state.idx += 1; updateTick();
      }, TICK_MS);
    }
    function pause(){
      state.running=false; if(state.timer) clearInterval(state.timer);
      document.getElementById('status').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì¼ì‹œì •ì§€'; setControlState('pause');
    }
    function resetSim(){
      pause();
      state.idx=0; state.portfolio = { krw:INITIAL_KRW, btc:{qty:0, cost:0}, xrp:{qty:0, cost:0} };
      redrawCharts(); updateTick(true);
      document.getElementById('status').textContent='ë¦¬ì…‹ ì™„ë£Œ'; setControlState('reset');
    }

    /** ===== ì´ë²¤íŠ¸ ===== */
    function wireEvents(){
      document.getElementById('leftCol').addEventListener('click', ()=>setActiveAsset('btc'));
      document.getElementById('rightCol').addEventListener('click', ()=>setActiveAsset('xrp'));
      document.getElementById('tabBTC').addEventListener('click', ()=>setActiveAsset('btc'));
      document.getElementById('tabXRP').addEventListener('click', ()=>setActiveAsset('xrp'));

      document.getElementById('side').addEventListener('change', ()=>{
        const buy = document.getElementById('side').value==='buy';
        const btn = document.getElementById('orderBtn');
        btn.textContent = buy?'ë§¤ìˆ˜':'ë§¤ë„';
        calcTotal();
      });

      document.getElementById('amount').addEventListener('input', calcTotal);
      document.getElementById('pctInput').addEventListener('input', (e)=>{
        const v = Math.max(0, Math.min(100, parseFloat(e.target.value||'0'))); applyPercent(v);
      });
      document.querySelectorAll('.pct').forEach(btn=> btn.addEventListener('click', ()=> applyPercent(parseInt(btn.dataset.pct,10)) ));
      document.getElementById('orderBtn').addEventListener('click', placeOrder);
      document.getElementById('playBtn').addEventListener('click', play);
      document.getElementById('pauseBtn').addEventListener('click', pause);
      document.getElementById('resetBtn').addEventListener('click', resetSim);

      // Summary modal
      document.getElementById('summaryCloseBtn').addEventListener('click', closeSummaryModal);
      document.getElementById('summaryOkBtn')?.addEventListener('click', closeSummaryModal);
      document.getElementById('summaryResetBtn').addEventListener('click', ()=>{ closeSummaryModal(); resetSim(); });

      // Notice modal & ğŸ“– ë²„íŠ¼
      document.getElementById('noticeOkBtn').addEventListener('click', closeNotice);
      document.getElementById('helpBtn').addEventListener('click', openNotice);
    }

    /** ===== ì´ˆê¸°í™” ===== */
    async function init(){
      try{
        document.getElementById('status').textContent = 'ë°ì´í„° ë¡œë”© ì¤‘â€¦';
        document.getElementById('btcRange').textContent = `ì¼ë´‰(${RANGE.start} ~ ${RANGE.end})`;
        document.getElementById('xrpRange').textContent = `ì¼ë´‰(${RANGE.start} ~ ${RANGE.end})`;

        const [btc, xrp] = await Promise.all([fetchDaily('btc'), fetchDaily('xrp')]);
        state.data.btc = btc; state.data.xrp = xrp;

        const btcDays = new Set(btc.map(d=>normDay(d.ts)));
        const xrpDays = new Set(xrp.map(d=>normDay(d.ts)));
        const common = [...btcDays].filter(x=>xrpDays.has(x)).sort((a,b)=>a-b);
        if(!common.length) throw new Error('ê³µí†µ ì¼ìê°€ ì—†ìŠµë‹ˆë‹¤. DB ì¼ì ë²”ìœ„ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        state.dates = common;

        // ì°¨íŠ¸ ìƒì„±
        state.charts.btc    = makeCandleChart(document.getElementById('btcChart').getContext('2d'));
        state.charts.xrp    = makeCandleChart(document.getElementById('xrpChart').getContext('2d'));
        state.charts.btcVol = makeVolumeChart(document.getElementById('btcVol').getContext('2d'));  // â–¼
        state.charts.xrpVol = makeVolumeChart(document.getElementById('xrpVol').getContext('2d'));  // â–¼

        redrawCharts();

        updateTick(true); updatePortfolioBox(); updateHeader(); updateProgress();
        wireEvents();
        document.getElementById('status').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ëŒ€ê¸°ì¤‘';
        setControlState('reset');
      }catch(e){
        document.getElementById('status').textContent = 'ë¡œë”© ì˜¤ë¥˜';
        console.error(e); alert(e.message);
      }
    }
    init();

    // í˜ì´ì§€ ì§„ì… ì‹œ ì•ˆë‚´ ëª¨ë‹¬ ìë™ í‘œì‹œ
    window.addEventListener('load', openNotice);
  </script>
</body>
</html>
