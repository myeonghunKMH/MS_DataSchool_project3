<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼ê±° ë°ì´í„° ëª¨ì˜íˆ¬ì</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #212121;
            --panel: #1f1f1f;
            --panel-2: #1f1f1f;
            --line: #424242;
            --hairline: #5e5e5e;
            --text: #E8ECF3;
            --muted: #bfc6d6;
            --active: #ffffff;
            --active-600: #a3a3a3;
            --headline: #ffd166;
            --candle-up: rgb(255, 103, 103);
            --candle-down: rgb(74, 196, 175);
            --vol-up: rgba(255, 103, 103, .34);
            --vol-down: rgba(74, 196, 175, .30);
            --font-sm: 12.5px;
            --font-md: 14.5px;
            --font-lg: 18px;
        }

        body {
            margin: 0;
            background: var(--panel);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border-bottom: 1px solid var(--line);
            position: relative;
            background: var(--panel);
        }

        .left-tools {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-title {
            text-align: center;
            flex: 1;
            /* ì¤‘ì•™ ë°°ì¹˜ */
        }

        .scenario-badge {
            padding: 6px 16px;
            border-radius: 9999px;
            /* ì™„ì „íˆ ë‘¥ê·¼ pill */
            background: rgba(49, 49, 49, 0.705);
            border: 1px solid #bbb;
            color: #bbb;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .scenario-subtitle {
            font-size: var(--font-lg);
            font-weight: bold;
            color: var(--text);
        }

        .header-date {
            font-family: ui-monospace, Menlo, Consolas, monospace;
            color: #ffffff;
            font-size: 15px;
            opacity: .95;
        }

        .scenario-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .back-btn {
            font-size: 12px;
            padding: 9px 12px;
            border-radius: 12px;
            background: rgba(63, 63, 63, 0.705);
            border: 1px solid var(--hairline);
            color: #dfe5f1;
            text-decoration: none;
            font-weight: 700;
            cursor: pointer;
            height: 35px;
            display: flex;
            align-items: center;
        }

        .back-btn:hover {
            background: #2c2c2c;
            color: var(--active);
        }

        .back-icon {
            font-size: 14px;
            line-height: 1;
        }

        .back-text {
            font-size: var(--font-sm);
            font-weight: 600;
        }

        .header-title {
            text-align: center;
            flex: 1;
        }

        .scenario-title {
            font-size: 12px;
            font-weight: 800;
            color: #bbbbbb;
        }

        .balances {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .b-item {
            padding: 10px 12px;
            border: 1px solid var(--line);
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(63, 63, 63, 0), rgb(63, 63, 63));
        }

        .b-label {
            font-size: 9px;
            color: #bac0cc;
        }

        .b-value {
            font-size: 16px;
            font-weight: 800;
            color: #eef3ff;
        }

        .b-value.positive {
            color: #9CD67A;
        }

        .b-value.negative {
            color: #FF7A7A;
        }

        .coin-icon {
            width: 22px;
            /* ì•„ì´ì½˜ í¬ê¸° */
            height: 22px;
            vertical-align: middle;
        }

        #krwBalance::after {
            content: "â‚©";
            margin-left: 2px;
            font-size: 14px;
            color: #eef3ff;
        }

        .scenario-subtitle {
            font-size: var(--font-lg);
            font-weight: bold;
            color: var(--text);
        }

        .price-box {
            text-align: center;
        }

        .price-main {
            font-size: 28px;
            font-weight: bold;
            color: var(--active);
        }

        .price-sub {
            font-size: var(--font-md);
            margin-top: 4px;
            color: var(--muted);
        }

        .price-sub.positive {
            color: var(--candle-up);
        }

        .price-sub.negative {
            color: var(--candle-down);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00d4aa;
        }

        .balance-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .balance-item {
            flex: 1;
            background: linear-gradient(180deg, rgba(63, 63, 63, 0), rgb(63, 63, 63));
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px 16px;
            text-align: center;
        }

        .balance-label {
            font-size: var(--font-sm);
            color: var(--muted);
            margin-bottom: 4px;
        }

        .balance-value {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--text);
        }

        .balance-value.positive {
            color: var(--candle-up);
        }

        .balance-value.negative {
            color: var(--candle-down);
        }

        .main-container {
            display: grid;
            grid-template-columns: 230px 1fr 280px;
            /* âœ… ì¢Œì¸¡ 220px, ìš°ì¸¡ 280px, ë‚˜ë¨¸ì§€ ì „ë¶€ ì¤‘ì•™ */
            height: calc(100vh - 85px);
            gap: 1px;
            /* âœ… ê³µê°„ ì œê±° */
            background: #2d3748;
        }

        .left-panel {
            background: #1a1f2e;
            display: flex;
            flex-direction: column;
            width: 230px;
            min-width: 200px;
        }

        .news-section {
            border-top: 1px solid #2d3748;
            padding: 12px 8px;
            /* âœ… ë‚´ë¶€ ì—¬ë°± ì¶•ì†Œ */
            overflow-y: auto;
            flex: 4;
        }

        .news-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 13px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--line);
        }

        #news-timeline {
            max-height: 600px;
            overflow-y: auto;
            font-size: 12px;
            /* âœ… ë‰´ìŠ¤ í•­ëª© ê¸€ì”¨ í¬ê¸° ì¤„ì„ */
            line-height: 1.4;
        }

        .news-entry {
            padding: 5px 0;
        }

        .market-select {
            padding: 20px;
            border-bottom: 1px solid #2d3748;
        }

        .market-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .market-tab {
            padding: 8px 15px;
            background: #2d3748;
            border: none;
            color: #8892b0;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .market-tab.active {
            background: #00d4aa;
            color: #1a1f2e;
        }

        .market-list {
            flex: 1;
            overflow-y: auto;
        }

        .market-item {
            padding: 12px 20px;
            border-bottom: 1px solid #2d3748;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .market-item:hover {
            background: #2d3748;
        }

        .market-item.active {
            background: #00d4aa;
            color: #1a1f2e;
        }

        .market-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .market-price {
            font-size: 14px;
            font-weight: bold;
        }

        .price-change {
            font-size: 12px;
        }

        .price-up {
            color: #d73527;
        }

        .price-down {
            color: #1261c4;
        }

        .center-panel {
            background: #1a1f2e;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            padding: 5px 15px;
            border-bottom: 1px solid var(--line);
            background: var(--panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-price {
            font-size: 28px;
            font-weight: bold;
            color: #ffffff;
        }

        .price-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .simulation-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            border: 1px solid #414141;
            background: #202020;
            color: #b1b1b1;
            cursor: pointer;
            height: 32px;
        }

        .control-btn:hover {
            background: #2c2c2c;
        }

        .control-btn.active {
            border-color: var(--active);
            color: var(--active);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .speed-slider {
            width: 130px;
            accent-color: #cacaca;
        }

        .chart-container {
            flex: 1;
            padding: 8px;
            position: relative;
            background: #1b1b1b;
        }

        #priceChart {
            width: 100%;
            height: 100%;
        }

        .right-panel {
            background: var(--panel);
            display: flex;
            flex-direction: column;
            width: 100%;
            min-width: unset;
        }

        .trading-section {
            flex: 1;
            padding: 15px 6px;
        }

        .trade-header {
            width: 100%;
            border-bottom: 1px solid var(--line);
            margin: 0;
            padding: 0;
        }

        .trading-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
            height: 50px;
            font-size: 20px;
            margin: 0;
            padding: 0;
            border-radius: 0;
            overflow: hidden;
        }

        .trading-tab {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-md);
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            border: none;
            line-height: 1;
            height: 100%;
        }

        .trading-tab.buy {
            background: #661f1a;
        }

        /* âœ… ì–´ë‘ìš´ ë¹¨ê°• */
        .trading-tab.sell {
            background: #123764;
        }

        /* âœ… ì–´ë‘ìš´ íŒŒë‘ */
        .trading-tab.active {
            opacity: 0.9;
        }

        .order-form {
            margin: 0;
            /* âœ… ë°”ê¹¥ ì—¬ë°± ì œê±° */
            padding: 0;
            /* âœ… ë‚´ë¶€ ì—¬ë°± ì œê±° */
            background: transparent;
            /* âœ… ë°°ê²½ ì—†ì• ê³  ìš°ì¸¡íŒ¨ë„ ë°°ê²½ ê·¸ëŒ€ë¡œ ì‚¬ìš© */
            border: none;
            /* âœ… í…Œë‘ë¦¬ ì œê±° */
            border-radius: 0;
            /* âœ… ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
            width: 100%;
            /* âœ… íŒ¨ë„ ì „ì²´ ê°€ë¡œ ì°¨ì§€ */
            box-sizing: border-box;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ffffff;
            /* âœ… ìƒë‹¨ í—¤ë”ì™€ ë™ì¼ í…ìŠ¤íŠ¸ ìƒ‰ */
        }

        .form-input {
            width: 100%;
            padding: 10px;
            /* âœ… ì‚´ì§ ì¤„ì—¬ì„œ ë†’ì´ ì¡°ì • */
            border: 1px solid var(--line);
            background: var(--panel);
            /* âœ… í—¤ë”ì™€ ë™ì¼í•œ ë°°ê²½ìƒ‰ */
            color: var(--text);
            /* âœ… ë””ìì¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            border-radius: 8px;
            /* âœ… ë‘¥ê·¼ ì •ë„ ì¤„ì„ */
            font-size: var(--font-md);
            height: 38px;
            /* âœ… ê³ ì • ë†’ì´ */
            box-sizing: border-box;
            -moz-appearance: textfield;
        }

        .form-input::-webkit-outer-spin-button,
        .form-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d4aa;
        }

        .percentage-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .percentage-buttons {
            display: flex;
            gap: 5px;
            flex-grow: 1;
        }

        .percentage-btn {
            padding: 8px 0;
            /* âœ… ë†’ì´ ì¤„ì„ */
            flex: 1;
            background: var(--panel);
            /* âœ… ë°°ê²½ í†µì¼ */
            border: 1px solid var(--line);
            border-radius: 6px;
            /* âœ… pill â†’ ì‚´ì§ ë‘¥ê¸€ê²Œ */
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--text);
            /* âœ… í…ìŠ¤íŠ¸ ìƒ‰ í†µì¼ */
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            height: 38px;
            /* âœ… ì…ë ¥ì¹¸ê³¼ ë™ì¼ ë†’ì´ */
            box-sizing: border-box;
        }

        .percentage-btn:hover {
            background: #1f2535;
            border-color: #5a5a5a;
        }

        .percentage-input-group {
            display: flex;
            align-items: center;
            background: var(--panel);
            /* âœ… íŒ¨ë„ ìƒ‰ìƒ í†µì¼ */
            border: 1px solid var(--line);
            border-radius: 6px;
            height: 38px;
            /* âœ… ë²„íŠ¼ê³¼ ì…ë ¥ì¹¸ ë†’ì´ ë™ì¼ */
            padding: 0 6px;
            box-sizing: border-box;
        }

        .percentage-input {
            width: 70px;
            height: 35px;
            padding: 8px;
            border: none;
            background: transparent;
            text-align: right;
            color: #ffffff;
            font-size: 12px;
            -moz-appearance: textfield;
        }

        .percentage-input::-webkit-outer-spin-button,
        .percentage-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .order-btn {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            /* ë” ë‘¥ê¸€ê²Œ */
            font-size: var(--font-md);
            /* í…ìŠ¤íŠ¸ í¬ê¸° í†µì¼ */
            font-weight: 700;
            border: 1px solid #2a2f38;
            /* ì–‡ì€ í…Œë‘ë¦¬ */
            cursor: pointer;
            background: linear-gradient(180deg, var(--active), var(--active-600));
            color: #0b0c0f;
            transition: opacity 0.2s, transform 0.02s;
        }

        .order-btn.buy-btn {
            background: #b52b20;
            color: #ffffff;
        }

        .order-btn.sell-btn {
            background: #0f4e9c;
            color: #ffffff;
        }

        .order-btn:hover {
            opacity: 0.85;
        }

        .order-btn:active {
            transform: translateY(0.5px);
        }

        .order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .holdings-section {
            border-top: 1px solid #2d3748;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .holdings-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffffff;
            padding-bottom: 10px;
            border-bottom: 1px solid #2d3748;
        }

        #holdingsList {
            flex: 1;
            overflow-y: auto;
        }

        .holding-item {
            display: grid;
            grid-template-columns: 1fr 2fr;
            padding: 12px 5px;
            border-bottom: 1px solid #2d3748;
            font-size: 14px;
        }

        .holding-item:last-child {
            border-bottom: none;
        }

        .holding-symbol {
            font-weight: bold;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .holding-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 10px;
            font-size: 12px;
        }

        .detail-label {
            color: #8892b0;
        }

        .detail-value {
            text-align: right;
            font-weight: bold;
        }

        .holding-pnl {
            font-size: 12px;
            text-align: right;
        }

        .positive {
            color: #d73527;
        }

        .negative {
            color: #1261c4;
        }

        .time-display {
            padding: 10px 20px;
            background: #2d3748;
            text-align: center;
            font-family: monospace;
            font-size: 16px;
            color: #00d4aa;
        }

        .status-bar {
            padding: 10px 20px;
            background: #2d3748;
            display: flex;
            justify-content: space-between;
            /* ì¢Œ/ìš° ê· í˜• */
            align-items: center;
            font-size: 14px;
            gap: 20px;
            /* ìš”ì†Œ ê°„ ê°„ê²© */
        }

        #timeDisplay {
            color: #00d4aa;
            /* ì‹œë®¬ì‹œê°„ ê°•ì¡° */
            font-family: monospace;
            font-size: 14px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00d4aa;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1f2e;
            border-radius: 8px;
            padding: 30px;
            min-width: 400px;
            border: 1px solid #2d3748;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #8892b0;
            font-size: 24px;
            cursor: pointer;
        }

        .order-summary {
            background: #2d3748;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .confirm-btn {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: 1px solid #2a2f38;
            background: linear-gradient(180deg, var(--active), var(--active-600));
            color: #0b0c0f;
            font-size: var(--font-md);
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.02s;
        }

        .confirm-btn:hover {
            opacity: 0.85;
        }

        .confirm-btn:active {
            transform: translateY(0.5px);
        }

        .error-message {
            color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .pill-btn {
            flex: 1;
            padding: 12px 0;
            background: #202020;
            border: 1px solid #414141;
            border-radius: 9999px;
            /* ì™„ì „ ë‘¥ê·¼ pill */
            color: #b1b1b1;
            font-weight: 700;
            font-size: var(--font-md);
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
        }

        .pill-btn:hover {
            background: #2c2c2c;
            border-color: #5a5a5a;
            color: var(--active);
        }

        .currency-krw {
            color: #ffd166;
            font-weight: 800;
            font-size: 0.8em;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="left-tools">
            <a href="javascript:history.back()" class="back-btn">â† íŠœí† ë¦¬ì–¼</a>
        </div>
        <div class="scenario-wrap">
            <span class="scenario-badge">SCENARIO 02</span>
            <span class="scenario-title">ETH ê³¼ê±° ë°ì´í„° ëª¨ì˜íˆ¬ì</span>
        </div>
        <div class="balances">
            <div class="b-item">
                <div class="b-label">ë³´ìœ  KRW</div>
                <div class="b-value">
                    <span id="krwBalance">10,000,000</span>
                </div>
            </div>
            <div class="b-item">
                <div class="b-label">ì´ ìì‚°</div>
                <div class="b-value">
                    <img src="/images/coin.png" alt="ì½”ì¸" class="coin-icon">
                    <span id="totalAssets">10,000,000</span>
                </div>
            </div>
            <div class="b-item">
                <div class="b-label">ìˆ˜ìµë¥ </div>
                <div class="b-value">
                    <span id="profitRate">0.00%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel" style="background: var(--panel);">
            <div class="news-section" style="border-top:1px solid #2d3748; padding:15px 10px; overflow-y:auto; flex:4;">
                <div class="news-title" style="font-weight:bold; margin-bottom:10px;">ë‰´ìŠ¤ íƒ€ì„ë¼ì¸</div>
                <div id="news-timeline" class="news-list" style="max-height:600px; overflow-y:auto;"></div>
            </div>
        </div>

        <div class="center-panel">
            <div class="chart-header">
                <div class="price-box">
                    <div class="price-main" id="currentPrice">-</div>
                    <div class="price-sub" id="priceChange">-</div>
                </div>
                <div class="simulation-controls">
                    <button class="control-btn" id="playBtn">â–¶ ì‹œì‘</button>
                    <button class="control-btn" id="pauseBtn">â¸ ì¼ì‹œì •ì§€</button>
                    <button class="control-btn" id="resetBtn">â†» ë¦¬ì…‹</button>
                    <div class="speed-control">
                        <span>ì†ë„:</span>
                        <input type="range" class="speed-slider" id="speedSlider" min="1" max="10" value="1">
                        <span id="speedDisplay">1x</span>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="statusText">ì‹œë®¬ë ˆì´ì…˜ ëŒ€ê¸° ì¤‘</span>
                </div>
                <div id="timeDisplay">ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„: ì¤€ë¹„ ì¤‘...</div>
                <div id="dataProgress">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <div class="right-panel">
            <div class="trade-header">
                <div class="trading-tabs">
                    <button class="trading-tab buy active" id="buyTab">ë§¤ìˆ˜</button>
                    <button class="trading-tab sell" id="sellTab">ë§¤ë„</button>
                </div>
            </div>
            <div class="trading-section">
                <div class="order-form" id="orderForm">
                    <div class="form-group">
                        <label class="form-label">ì£¼ë¬¸ ìˆ˜ëŸ‰</label>
                        <input type="number" class="form-input" id="orderAmount" placeholder="0" step="0.00000001">
                        <div class="percentage-controls">
                            <div class="percentage-buttons">
                                <button class="percentage-btn" data-percent="25">25%</button>
                                <button class="percentage-btn" data-percent="50">50%</button>
                                <button class="percentage-btn" data-percent="75">75%</button>
                                <button class="percentage-btn" data-percent="100">MAX</button>
                            </div>
                            <div class="percentage-input-group">
                                <input type="number" id="percentageInput" class="percentage-input" placeholder="ì§ì ‘ì…ë ¥">
                                <span>%</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì£¼ë¬¸ ê°€ê²©</label>
                        <input type="number" class="form-input" id="orderPrice" placeholder="ì‹œì¥ê°€">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ì£¼ë¬¸ ì´ì•¡</label>
                        <input type="number" class="form-input" id="orderTotal" placeholder="0" readonly>
                    </div>

                    <button class="order-btn buy-btn" id="orderBtn">ë§¤ìˆ˜</button>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>

            <div class="holdings-section">
                <div class="holdings-title">ë³´ìœ  ìì‚°</div>
                <div id="holdingsList">
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="orderModal">
        <div class="modal-content">
            <button class="close-btn" id="closeModal">&times;</button>
            <div class="modal-header">ì£¼ë¬¸ í™•ì¸</div>
            <div class="order-summary" id="orderSummary">
            </div>
            <button class="confirm-btn" id="confirmOrder">ì£¼ë¬¸ í™•ì¸</button>
        </div>
    </div>
    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ† ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</div>
            <div class="order-summary" id="resultsSummary">
                <div class="summary-row">
                    <span>ì´ ìì‚°</span>
                    <span id="finalAssets"></span>
                </div>
                <div class="summary-row">
                    <span>ì´ ì†ìµ</span>
                    <span id="finalPnl"></span>
                </div>
                <div class="summary-row">
                    <span>ìˆ˜ìµë¥ </span>
                    <span id="finalPnlRate"></span>
                </div>
            </div>
            <button class="confirm-btn" id="closeResultsModal">í™•ì¸</button>
        </div>
    </div>

    <div id="overlay"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1500;">
    </div>
    <div id="news-popup" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%,-20%);
                        background:url('/images/news1.png') center center / cover no-repeat; 
                        border:1px solid #444; padding:25px; border-radius:8px;
                        z-index:2000; text-align:left; width:600px; max-height:70vh; overflow-y:auto;
                        color:#242424; font-weight:bold;">
        <h3 id="news-popup-title" style="margin-bottom:10px; font-size:1.4rem;"></h3>
        <div id="news-popup-date" style="font-size:0.9rem; color:#ffffff; margin-bottom:15px; font-weight:bold;"></div>
        <p id="news-popup-desc" style="margin:10px 0; line-height:1.5; white-space:pre-line;"></p>
        <!-- 1ë‹¨ê³„: ì„ íƒ ë²„íŠ¼ (í•­ìƒ ë³´ì„, ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë³µì›) -->
        <div id="news-popup-choice" style="display:flex; gap:10px; margin-top:15px;">
            <button id="news-popup-buy" class="pill-btn">ë§¤ìˆ˜</button>
            <button id="news-popup-sell" class="pill-btn">ë§¤ë„</button>
            <button id="news-popup-hold" class="pill-btn">ìœ ì§€</button>
        </div>

        <!-- 2ë‹¨ê³„: ì‹¤ì œ ì£¼ë¬¸ì°½ (ë²„íŠ¼ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ì£¼ë¬¸ì°½ë§Œ ì¶”ê°€ë¡œ ë…¸ì¶œë¨) -->
        <div id="news-trade-form" style="display:none; margin-top:20px;">
            <div class="form-group">
                <label class="form-label">ì£¼ë¬¸ ìˆ˜ëŸ‰</label>
                <input type="number" class="form-input" id="news-orderAmount" placeholder="0" step="0.00000001">
                <div class="percentage-controls">
                    <div class="percentage-buttons">
                        <button class="percentage-btn" data-percent="25">25%</button>
                        <button class="percentage-btn" data-percent="50">50%</button>
                        <button class="percentage-btn" data-percent="75">75%</button>
                        <button class="percentage-btn" data-percent="100">MAX</button>
                    </div>
                    <div class="percentage-input-group">
                        <input type="number" id="news-percentageInput" class="percentage-input" placeholder="ì§ì ‘ì…ë ¥">
                        <span>%</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ì£¼ë¬¸ ê°€ê²©</label>
                <input type="number" class="form-input" id="news-orderPrice" placeholder="ì‹œì¥ê°€">
            </div>

            <div class="form-group">
                <label class="form-label">ì£¼ë¬¸ ì´ì•¡</label>
                <input type="number" class="form-input" id="news-orderTotal" placeholder="0" readonly>
            </div>

            <!-- ë§¤ìˆ˜/ë§¤ë„ì— ë”°ë¼ ë™ì ìœ¼ë¡œ í´ë˜ìŠ¤ ë³€ê²½ -->
            <button id="news-orderConfirm" class="order-btn buy-btn">ë§¤ìˆ˜</button>
        </div>
    </div>

    <script>
        class HistoricalTradingSystem {
            constructor() {
                this.currentMarket = 'eth';
                this.isBuyMode = true;
                this.isSimulationRunning = false;
                this.simulationSpeed = 1;
                this.currentDataIndex = 0;
                this.startIndex = 0;
                this.historicalData = {};
                this.chart = null;

                this.initialKrw = 5000000;   // ğŸ’° í˜„ê¸ˆ 500ë§Œ ì›
                this.portfolio = {
                    krw: this.initialKrw,
                    eth: { amount: 0, totalCost: 0 }   // ì‹¤ì œ ë³´ìœ ëŠ” init()ì—ì„œ ì±„ì›Œì§
                };

                this.currentPrices = { eth: 0 };
                this.tradeHistory = [];
                this.newsList = [];

                // âœ… ì‹œë‚˜ë¦¬ì˜¤2 êµ¬ê°„
                this.scenarioStart = "2025-07-07";
                this.scenarioEnd = "2025-08-15";

                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadHistoricalData();
                await this.loadNews();

                // ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘ì¼ ê¸°ì¤€ìœ¼ë¡œ 30ì¼ì¹˜ ë¯¸ë¦¬ í‘œì‹œ
                const startTsKst = new Date(this.scenarioStart + "T00:00:00+09:00").getTime();
                const preloadEnd = startTsKst + 5 * 24 * 60 * 60 * 1000; // 6ì¼ (7/7 ~ 7/12)
                const data = this.historicalData[this.currentMarket];

                // preloadIndex = 30ì¼ ë§ˆì§€ë§‰ ë°ì´í„° ì¸ë±ìŠ¤
                let preloadIndex = data.findIndex(d => d.timestamp >= preloadEnd);
                if (preloadIndex === -1) preloadIndex = Math.min(29, data.length - 1);

                // âœ… ì°¨íŠ¸ì—ëŠ” preloadIndexê¹Œì§€ ë¨¼ì € ê·¸ë¦¬ê¸°
                this.currentDataIndex = preloadIndex;

                // ğŸ”¹ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ì¼ì = scenarioStart
                this.startIndex = preloadIndex;

                this.initChart();
                this.updateDisplay();

                // âœ… ì´ˆê¸° í‘œì‹œ êµ¬ê°„ ì¦‰ì‹œ ë°˜ì˜
                this.updateMarketPrices();   // ê°€ê²©/ë³€ë™ë¥  ì—…ë°ì´íŠ¸
                this.updateChart();          // ì°¨íŠ¸ ê°±ì‹ 
                document.getElementById('speedSlider').value = this.simulationSpeed;
                document.getElementById('speedDisplay').textContent = `${this.simulationSpeed}x`;

                // âœ… ì´ˆê¸° ë³´ìœ  ìƒíƒœ (ETH 500ë§Œ ì›ì–´ì¹˜ ë§¤ìˆ˜)
                const firstData = this.historicalData[this.currentMarket][this.startIndex];
                if (firstData) {
                    const initPrice = parseFloat(firstData.opening_price);
                    const ethAmount = 5000000 / initPrice;

                    this.portfolio.krw = 5000000;  // í˜„ê¸ˆ 500ë§Œ ì›
                    this.portfolio.eth = {
                        amount: ethAmount,
                        totalCost: 5000000
                    };
                }
            }

            async loadNews() {
                try {
                    const res = await fetch("/api/scenario2/news");
                    this.newsList = await res.json();
                    document.getElementById("news-timeline").innerHTML = "";
                } catch (err) {
                    console.error("ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                    this.newsList = [];
                }
            }

            setupEventListeners() {
                document.querySelectorAll('.market-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        document.querySelectorAll('.market-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.currentMarket = item.dataset.market;
                        this.updateDisplay();
                    });
                });

                document.getElementById('percentageInput').addEventListener('input', (e) => {
                    const percentValue = parseFloat(e.target.value);
                    if (!isNaN(percentValue) && percentValue >= 0) {
                        this.setOrderAmount(percentValue > 100 ? 100 : percentValue);
                    }
                });

                document.getElementById('buyTab').addEventListener('click', () => this.switchTradingMode(true));
                document.getElementById('sellTab').addEventListener('click', () => this.switchTradingMode(false));
                document.getElementById('playBtn').addEventListener('click', () => this.startSimulation());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pauseSimulation());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetSimulation());
                document.getElementById('speedSlider').addEventListener('input', (e) => {
                    this.simulationSpeed = parseInt(e.target.value);
                    document.getElementById('speedDisplay').textContent = `${this.simulationSpeed}x`;
                    if (this.isSimulationRunning) {
                        this.pauseSimulation();
                        this.startSimulation();
                    }
                });
                document.querySelectorAll('.percentage-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const percent = parseInt(e.target.dataset.percent);
                        this.setOrderAmount(percent);
                    });
                });
                document.getElementById('orderAmount').addEventListener('input', () => this.calculateOrderTotal());
                document.getElementById('orderPrice').addEventListener('input', () => this.calculateOrderTotal());
                document.getElementById('orderBtn').addEventListener('click', () => this.showOrderModal());
                document.getElementById('closeModal').addEventListener('click', () => this.hideOrderModal());
                document.getElementById('confirmOrder').addEventListener('click', () => this.executeOrder());
                document.getElementById('closeResultsModal').addEventListener('click', () => {
                    document.getElementById('resultsModal').style.display = 'none';
                });
            }

            async loadHistoricalData() {
                try {
                    document.getElementById('dataProgress').textContent = 'ì„œë²„ ë°ì´í„° ë¡œë”© ì¤‘...';

                    const markets = ['eth'];   // âœ… BTCë§Œ ì‚¬ìš©
                    let loadedCount = 0;

                    for (const market of markets) {
                        try {
                            // ì‹œë‚˜ë¦¬ì˜¤2 â†’ ETH_daily (ì¼ë´‰)
                            const response = await fetch(`/api/scenario2?market=KRW-ETH&start=${this.scenarioStart}&end=${this.scenarioEnd}`);
                            const data = await response.json();
                            this.historicalData[market] = data.map(item => {
                                const kstIso = item.candle_date_time_kst;
                                return {
                                    candle_date_time_kst: kstIso,
                                    timestamp: new Date(kstIso).getTime(),
                                    opening_price: Number(item.opening_price),
                                    high_price: Number(item.high_price),
                                    low_price: Number(item.low_price),
                                    trade_price: Number(item.trade_price),
                                    volume: Number(item.volume || 0)
                                };
                            });

                            loadedCount++;
                            document.getElementById('dataProgress').textContent =
                                `ë°ì´í„° ë¡œë”© ì¤‘... (${loadedCount}/${markets.length})`;

                        } catch (error) {
                            console.error(`${market.toUpperCase()} ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:`, error);
                            this.historicalData[market] = [];
                        }
                    }

                    const totalDataCount = Object.values(this.historicalData)
                        .reduce((sum, data) => sum + data.length, 0);

                    if (totalDataCount > 0) {
                        document.getElementById('dataProgress').textContent =
                            `ë°ì´í„° ë¡œë”© ì™„ë£Œ (ì´ ${totalDataCount}ê°œ ë ˆì½”ë“œ)`;
                    } else {
                        document.getElementById('dataProgress').textContent = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨';
                    }

                } catch (error) {
                    console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                    document.getElementById('dataProgress').textContent = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨';
                }
            }

            initChart() {
                if (this.chart) this.chart.destroy();
                const ctx = document.getElementById('priceChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [
                            {
                                type: 'candlestick',
                                label: 'Price',
                                data: [],
                                yAxisID: 'yPrice',
                                color: {
                                    up: getComputedStyle(document.documentElement).getPropertyValue('--candle-up').trim(),
                                    down: getComputedStyle(document.documentElement).getPropertyValue('--candle-down').trim(),
                                    unchanged: '#9aa0a6'
                                }
                            },
                            {
                                type: 'bar',
                                label: 'Volume',
                                data: [],
                                yAxisID: 'yVolume',
                            }
                        ],
                    },
                    options: {
                        animation: false,
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    tooltipFormat: 'yyyy-MM-dd',
                                    displayFormats: { day: 'MM-dd' }
                                },
                                adapters: {
                                    date: luxon
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.08)', borderColor: 'rgba(255, 255, 255, 0.08)' },
                                ticks: { color: '#8892b0', maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
                            },
                            yVolume: {
                                type: 'linear',
                                position: 'left',
                                stack: 'stock_chart',
                                stackWeight: 1,
                                grid: {
                                    drawOnChartArea: false,
                                    borderColor: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: { display: false }
                            },
                            yPrice: {
                                type: 'linear',
                                position: 'left',
                                stack: 'stock_chart',
                                stackWeight: 4,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    borderColor: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: { color: '#8892b0' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                });
            }

            updateChart() {
                if (!this.chart || !this.historicalData[this.currentMarket]) return;

                const slicedData = this.historicalData[this.currentMarket].slice(0, this.currentDataIndex + 1);
                const displayData = slicedData.slice(-70);

                // âœ… ìº”ë“¤ ë°ì´í„° (ëª¸í†µ í‘œì‹œ)
                const priceData = displayData.map(d => {
                    const isUp = parseFloat(d.trade_price) >= parseFloat(d.opening_price);
                    const candleColor = isUp
                        ? getComputedStyle(document.documentElement).getPropertyValue('--candle-up').trim()
                        : getComputedStyle(document.documentElement).getPropertyValue('--candle-down').trim();
                    return {
                        x: new Date(d.candle_date_time_kst).getTime(),
                        o: parseFloat(d.opening_price),
                        h: parseFloat(d.high_price),
                        l: parseFloat(d.low_price),
                        c: parseFloat(d.trade_price),
                        color: candleColor   // ğŸ”¹ ìº”ë“¤ë³„ ìƒ‰ìƒ ì§€ì •
                    };
                });

                // âœ… ê±°ë˜ëŸ‰ ë°ì´í„°
                const volumeData = displayData.map(d => ({
                    x: new Date(d.candle_date_time_kst).getTime(),
                    y: parseFloat(d.volume || 0),
                }));

                // âœ… ê±°ë˜ëŸ‰ ìƒ‰ìƒ (ìƒìŠ¹ = ë¹¨ê°•, í•˜ë½ = íŒŒë‘)
                const volumeColors = displayData.map(d =>
                    parseFloat(d.trade_price) >= parseFloat(d.opening_price)
                        ? getComputedStyle(document.documentElement).getPropertyValue('--vol-up').trim()
                        : getComputedStyle(document.documentElement).getPropertyValue('--vol-down').trim()
                );

                // ì°¨íŠ¸ ë°ì´í„° ê°±ì‹ 
                this.chart.data.datasets[0].data = priceData;   // ìº”ë“¤
                this.chart.data.datasets[1].data = volumeData;  // ê±°ë˜ëŸ‰
                this.chart.data.datasets[1].backgroundColor = volumeColors;

                this.chart.update('none');
            }

            updateMarketPrices() {
                Object.keys(this.historicalData).forEach(market => {
                    if (this.historicalData[market] && this.historicalData[market].length > 0) {
                        const currentData = this.historicalData[market][this.currentDataIndex] || this.historicalData[market][0];
                        const prevData = this.historicalData[market][this.currentDataIndex - 1] || currentData;

                        const price = parseFloat(currentData.trade_price);
                        const prevPrice = parseFloat(prevData.trade_price);
                        const change = ((price - prevPrice) / prevPrice * 100).toFixed(2);

                        this.currentPrices[market] = price;

                        const priceElement = document.getElementById(`${market}-price`);
                        const changeElement = document.getElementById(`${market}-change`);

                        if (priceElement) {
                            priceElement.textContent = price.toLocaleString();
                        }

                        if (changeElement) {
                            changeElement.textContent = `${change > 0 ? '+' : ''}${change}%`;
                            changeElement.className = `price-change ${change >= 0 ? 'price-up' : 'price-down'}`;
                        }
                    }
                });

                this.updateDisplay();
            }

            updateCurrentMarketDisplay() {
                const currentData = this.historicalData[this.currentMarket]?.[this.currentDataIndex];
                if (!currentData) return;

                const price = parseFloat(currentData.trade_price);
                const prevData = this.historicalData[this.currentMarket]?.[this.currentDataIndex - 1];

                document.getElementById('currentPrice').innerHTML = `<span class="currency-krw">ETH/KRW </span>${price.toLocaleString()} &#8361;`;

                if (prevData) {
                    const prevPrice = parseFloat(prevData.trade_price);
                    const change = price - prevPrice;
                    const changePercent = ((change / prevPrice) * 100).toFixed(2);

                    const changeElement = document.getElementById('priceChange');
                    changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toLocaleString()} (${changePercent}%)`;
                    changeElement.className = change >= 0 ? 'positive' : 'negative';
                }

                if (currentData.candle_date_time_kst) {
                    const date = new Date(currentData.candle_date_time_kst);
                    // KSTë¡œ ë³€í™˜ í›„ ì´ˆ ì œê±°
                    const kstString = date.toLocaleString("ko-KR", {
                        timeZone: "Asia/Seoul",
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                        hour: "2-digit",
                        minute: "2-digit"
                    }).replace(/\s/g, ''); // ê³µë°± ì œê±° (2021.05.19 00:00 â†’ 2021.05.19 00:00)

                    document.getElementById('timeDisplay').textContent =
                        `ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„ : ${kstString}`;
                }
            }

            resetSimulation() {
                this.pauseSimulation();

                // ğŸ”¹ ì´ˆê¸° í•œ ë‹¬(3/25~4/25) ë°ì´í„°ê¹Œì§€ ë¯¸ë¦¬ í‘œì‹œ
                const preloadEnd = new Date("2021-04-25T23:59:59+09:00").getTime();
                const data = this.historicalData[this.currentMarket];
                let preloadIndex = data.findIndex(d => d.timestamp >= preloadEnd);
                if (preloadIndex === -1) preloadIndex = 0;

                this.currentDataIndex = preloadIndex;  // âœ… í•œ ë‹¬ êµ¬ê°„ ë¯¸ë¦¬ ê·¸ë¦¼
                this.startIndex = preloadIndex;        // âœ… ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ì  ì¬ì„¤ì •

                this.portfolio = {
                    krw: this.initialKrw,
                    btc: { amount: 0, totalCost: 0 },
                    eth: { amount: 0, totalCost: 0 },
                    xrp: { amount: 0, totalCost: 0 }
                };
                this.tradeHistory = [];

                // âœ… ë‰´ìŠ¤ ìƒíƒœ ì´ˆê¸°í™” (_userAction ì œê±°)
                this.newsList.forEach(n => delete n._userAction);

                // âœ… ë‰´ìŠ¤ íƒ€ì„ë¼ì¸ ì´ˆê¸°í™”
                document.getElementById("news-timeline").innerHTML = "";

                this.updateMarketPrices();
                this.updateChart(); // âœ… ì´ˆê¸° í•œ ë‹¬ ë°ì´í„° ë°˜ì˜
                document.getElementById('statusText').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ë¦¬ì…‹ ì™„ë£Œ';
            }

            switchTradingMode(isBuy) {
                this.isBuyMode = isBuy;

                document.querySelectorAll('.trading-tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById(isBuy ? 'buyTab' : 'sellTab').classList.add('active');

                const orderBtn = document.getElementById('orderBtn');
                orderBtn.textContent = isBuy ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
                orderBtn.className = `order-btn ${isBuy ? 'buy-btn' : 'sell-btn'}`;

                this.clearOrderForm();
            }

            setOrderAmount(percent) {
                if (document.activeElement.id !== 'percentageInput') {
                    document.getElementById('percentageInput').value = percent;
                }
                const currentPrice = this.currentPrices[this.currentMarket];
                if (!currentPrice || currentPrice === 0) return;

                if (this.isBuyMode) {
                    const availableKrw = this.portfolio.krw;
                    const orderTotal = (availableKrw * percent / 100);
                    const orderAmount = orderTotal / currentPrice;

                    document.getElementById('orderAmount').value = orderAmount.toFixed(8);
                } else {
                    const availableCoin = this.portfolio[this.currentMarket].amount;
                    const orderAmount = (availableCoin * percent / 100);

                    document.getElementById('orderAmount').value = orderAmount.toFixed(8);
                }

                this.calculateOrderTotal();
            }

            calculateOrderTotal() {
                const amount = parseFloat(document.getElementById('orderAmount').value) || 0;
                const price = parseFloat(document.getElementById('orderPrice').value) || this.currentPrices[this.currentMarket];
                const total = amount * price;

                document.getElementById('orderTotal').value = Math.floor(total);
            }

            showOrderModal() {
                const amount = parseFloat(document.getElementById('orderAmount').value);
                const price = parseFloat(document.getElementById('orderPrice').value) || this.currentPrices[this.currentMarket];
                const total = amount * price;

                if (!this.validateOrder(amount, price, total)) {
                    return;
                }

                const summary = `
                <div class="summary-row">
                    <span>ë§ˆì¼“:</span>
                    <span>${this.currentMarket.toUpperCase()}/KRW</span>
                </div>
                <div class="summary-row">
                    <span>ì£¼ë¬¸êµ¬ë¶„:</span>
                    <span>${this.isBuyMode ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</span>
                </div>
                <div class="summary-row">
                    <span>ì£¼ë¬¸ìˆ˜ëŸ‰:</span>
                    <span>${amount.toFixed(8)} ${this.currentMarket.toUpperCase()}</span>
                </div>
                <div class="summary-row">
                    <span>ì£¼ë¬¸ë‹¨ê°€:</span>
                    <span>${price.toLocaleString()} KRW</span>
                </div>
                <div class="summary-row">
                    <span>ì£¼ë¬¸ì´ì•¡:</span>
                    <span>${Math.floor(total).toLocaleString()} KRW</span>
                </div>
            `;

                document.getElementById('orderSummary').innerHTML = summary;
                document.getElementById('orderModal').style.display = 'block';
            }

            hideOrderModal() {
                document.getElementById('orderModal').style.display = 'none';
            }

            validateOrder(amount, price, total) {
                this.hideError();

                if (!amount || amount <= 0) {
                    this.showError('ì£¼ë¬¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return false;
                }

                if (!price || price <= 0) {
                    this.showError('ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return false;
                }

                if (this.isBuyMode) {
                    if (total > this.portfolio.krw) {
                        this.showError('ë³´ìœ  KRWê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                        return false;
                    }
                } else {
                    if (amount > this.portfolio[this.currentMarket].amount) {
                        this.showError(`ë³´ìœ  ${this.currentMarket.toUpperCase()}ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.`);
                        return false;
                    }
                }

                return true;
            }

            executeOrder() {
                const amount = parseFloat(document.getElementById('orderAmount').value);
                const price = parseFloat(document.getElementById('orderPrice').value) || this.currentPrices[this.currentMarket];
                const total = amount * price;

                if (!this.validateOrder(amount, price, total)) {
                    this.hideOrderModal();
                    return;
                }

                const asset = this.portfolio[this.currentMarket];

                if (this.isBuyMode) {
                    this.portfolio.krw -= total;
                    asset.amount += amount;
                    asset.totalCost += total;
                } else {
                    this.portfolio.krw += total;
                    if (asset.amount > 0) {
                        const costPerCoin = asset.totalCost / asset.amount;
                        asset.totalCost -= costPerCoin * amount;
                    }
                    asset.amount -= amount;
                    if (asset.amount < 1e-8) {
                        asset.amount = 0;
                        asset.totalCost = 0;
                    }
                }

                this.tradeHistory.push({
                    timestamp: this.historicalData[this.currentMarket][this.currentDataIndex].timestamp,
                    market: this.currentMarket,
                    type: this.isBuyMode ? 'buy' : 'sell',
                    amount,
                    price,
                    total
                });

                this.updatePortfolioDisplay();
                this.clearOrderForm();
                this.hideOrderModal();

                const message = `${this.isBuyMode ? 'ë§¤ìˆ˜' : 'ë§¤ë„'} ì£¼ë¬¸ì´ ì²´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                document.getElementById('statusText').textContent = message;
                setTimeout(() => {
                    document.getElementById('statusText').textContent =
                        this.isSimulationRunning ? 'ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘' : 'ì‹œë®¬ë ˆì´ì…˜ ëŒ€ê¸° ì¤‘';
                }, 3000);
            }

            updatePortfolioDisplay() {
                document.getElementById('krwBalance').textContent = Math.floor(this.portfolio.krw).toLocaleString();

                let totalAssets = this.portfolio.krw;
                Object.keys(this.portfolio).forEach(market => {
                    if (market !== 'krw') {
                        const asset = this.portfolio[market];
                        const currentPrice = this.currentPrices[market] || 0;
                        totalAssets += asset.amount * currentPrice;
                    }
                });

                document.getElementById('totalAssets').textContent = Math.floor(totalAssets).toLocaleString();

                const profitRate = ((totalAssets - this.initialKrw) / this.initialKrw * 100).toFixed(2);
                const profitElement = document.getElementById('profitRate');
                profitElement.textContent = `${profitRate}%`;
                profitElement.className = `balance-value ${profitRate >= 0 ? 'positive' : 'negative'}`;

                this.updateHoldingsList();
            }

            updateHoldingsList() {
                const holdingsList = document.getElementById('holdingsList');
                holdingsList.innerHTML = '';

                const krwItem = document.createElement('div');
                krwItem.className = 'holding-item';
                krwItem.innerHTML = `
                <div>
                    <div class="holding-symbol">KRW</div>
                    <div>í˜„ê¸ˆ</div>
                </div>
                <div class="holding-details">
                    <div class="detail-label">ë³´ìœ ê¸ˆì•¡</div>
                    <div class="detail-value">${Math.floor(this.portfolio.krw).toLocaleString()} ì›</div>
                </div>
            `;
                holdingsList.appendChild(krwItem);

                Object.keys(this.portfolio).forEach(market => {
                    if (market !== 'krw' && this.portfolio[market].amount > 1e-8) {
                        const asset = this.portfolio[market];
                        const currentPrice = this.currentPrices[market] || 0;

                        const amount = asset.amount;
                        const avgPrice = (amount > 0) ? asset.totalCost / amount : 0;
                        const currentValue = amount * currentPrice;
                        const pnl = currentValue - asset.totalCost;
                        const pnlRate = (asset.totalCost > 0) ? (pnl / asset.totalCost * 100).toFixed(2) : 0;
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';

                        const coinItem = document.createElement('div');
                        coinItem.className = 'holding-item';
                        coinItem.innerHTML = `
                        <div>
                            <div class="holding-symbol">${market.toUpperCase()}</div>
                            <div class="holding-pnl ${pnlClass}">
                                ${pnl >= 0 ? '+' : ''}${Math.floor(pnl).toLocaleString()} ì› (${pnlRate}%)
                            </div>
                        </div>
                        <div class="holding-details">
                            <div class="detail-label">ë³´ìœ ìˆ˜ëŸ‰</div>
                            <div class="detail-value">${amount.toFixed(8)}</div>
                            <div class="detail-label">ë§¤ìˆ˜í‰ê· ê°€</div>
                            <div class="detail-value">${Math.floor(avgPrice).toLocaleString()}</div>
                            <div class="detail-label">í‰ê°€ê¸ˆì•¡</div>
                            <div class="detail-value">${Math.floor(currentValue).toLocaleString()}</div>
                        </div>
                    `;
                        holdingsList.appendChild(coinItem);
                    }
                });
            }

            startSimulation() {
                if (this.isSimulationRunning) return;

                this.isSimulationRunning = true;
                document.getElementById('statusText').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘';
                document.getElementById('playBtn').classList.add('active');
                document.getElementById('pauseBtn').classList.remove('active');

                // ğŸ”¹ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ì€ startIndexë¶€í„°
                if (this.currentDataIndex < this.startIndex) {
                    this.currentDataIndex = this.startIndex;
                }

                this.simulationInterval = setInterval(() => {
                    this.nextDataPoint();
                }, 1000 / this.simulationSpeed);
            }

            pauseSimulation() {
                this.isSimulationRunning = false;
                document.getElementById('statusText').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì¼ì‹œì •ì§€';
                document.getElementById('playBtn').classList.remove('active');
                document.getElementById('pauseBtn').classList.add('active');

                if (this.simulationInterval) {
                    clearInterval(this.simulationInterval);
                }
            }

            nextDataPoint() {
                const maxDataLength = this.historicalData[this.currentMarket].length;

                if (this.currentDataIndex >= maxDataLength - 1) {
                    this.pauseSimulation();
                    document.getElementById('statusText').textContent = 'ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ';

                    const totalAssets = this.portfolio.krw + Object.keys(this.portfolio)
                        .filter(m => m !== 'krw')
                        .reduce((sum, market) => sum + this.portfolio[market].amount * this.currentPrices[market], 0);

                    const profitAmount = totalAssets - this.initialKrw;
                    const profitRate = (profitAmount / this.initialKrw * 100).toFixed(2);
                    const pnlClass = profitAmount >= 0 ? 'positive' : 'negative';

                    document.getElementById('finalAssets').textContent = `${Math.floor(totalAssets).toLocaleString()} KRW`;

                    const finalPnlEl = document.getElementById('finalPnl');
                    finalPnlEl.textContent = `${profitAmount >= 0 ? '+' : ''}${Math.floor(profitAmount).toLocaleString()} KRW`;
                    finalPnlEl.className = pnlClass;

                    const finalPnlRateEl = document.getElementById('finalPnlRate');
                    finalPnlRateEl.textContent = `${profitRate}%`;
                    finalPnlRateEl.className = pnlClass;

                    document.getElementById('resultsModal').style.display = 'block';
                    return;
                }

                // ğŸ”¹ ì¼ë´‰ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ì§„í–‰ (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥)
                const prevTime = this.historicalData[this.currentMarket][this.currentDataIndex]?.timestamp || 0;
                this.currentDataIndex++;
                const currentTime = this.historicalData[this.currentMarket][this.currentDataIndex]?.timestamp || prevTime;

                this.updateMarketPrices();
                this.updateChart();   // âœ… ì¼ë´‰ ë°ì´í„°ì¼ ë•Œë„ ì°¨íŠ¸ ì¦‰ì‹œ ê°±ì‹ 

                // ğŸ”¹ ë‰´ìŠ¤ ë°œìƒ ì²´í¬ (ì¼ë´‰ì—ì„œë„ ë™ì¼í•˜ê²Œ ì ìš©)
                const matched = this.newsList.find(n => {
                    const newsTime = new Date(n.time.replace(" ", "T") + "+09:00").getTime();
                    return newsTime > prevTime && newsTime <= currentTime;
                });
                if (matched) {
                    this.showNewsPopup(matched);
                    this.addNewsToTimeline(matched);
                }
            }

            addNewsToTimeline(news) {
                const box = document.getElementById("news-timeline");
                let div = [...box.children].find(d => d.dataset.time === news.time);

                let actionTag = "";
                if (news._userAction === "buy") {
                    actionTag = ` <span style="color:#d73527;">(ë§¤ìˆ˜)</span>`;
                } else if (news._userAction === "sell") {
                    actionTag = ` <span style="color:#1261c4;">(ë§¤ë„)</span>`;
                } else if (news._userAction === "hold") {
                    actionTag = ` <span style="color:#aaa;">(ìœ ì§€)</span>`;
                }

                if (!div) {
                    div = document.createElement("div");
                    div.classList.add("news-item");
                    div.dataset.time = news.time;
                    box.appendChild(div);
                }

                div.innerHTML = `
                    <div class="news-entry">
                        <strong>${news.time}${actionTag}</strong><br>${news.title}
                    </div>
                `;
                div.onclick = () => this.showNewsPopup(news);
            }

            showNewsPopup(news) {
                this.pauseSimulation();
                this.currentNews = news;

                // ë‚ ì§œ ì¶”ê°€
                const date = new Date(news.time.replace(" ", "T") + "+09:00");
                const dateStr = date.toLocaleString("ko-KR", {
                    year: "numeric", month: "2-digit", day: "2-digit",
                    hour: "2-digit", minute: "2-digit", timeZone: "Asia/Seoul"
                });

                document.getElementById("news-popup-title").innerText = `ğŸ“°${news.title}`;
                document.getElementById("news-popup-date").innerText = `${dateStr}`;
                document.getElementById("news-popup-desc").innerText = news.description || "";
                document.getElementById("overlay").style.display = "block";
                document.getElementById("news-popup").style.display = "block";

                // ì´ˆê¸° ìƒíƒœ
                document.getElementById("news-popup-choice").style.display = "flex";
                document.getElementById("news-trade-form").style.display = "none";

                // ë§¤ìˆ˜ ë²„íŠ¼
                document.getElementById("news-popup-buy").onclick = () => {
                    this.isBuyMode = true;
                    document.getElementById("news-trade-form").style.display = "block";
                    const confirmBtn = document.getElementById("news-orderConfirm");
                    confirmBtn.textContent = "ë§¤ìˆ˜";
                    confirmBtn.className = "order-btn buy-btn";
                };

                // ë§¤ë„ ë²„íŠ¼
                document.getElementById("news-popup-sell").onclick = () => {
                    this.isBuyMode = false;
                    document.getElementById("news-trade-form").style.display = "block";
                    const confirmBtn = document.getElementById("news-orderConfirm");
                    confirmBtn.textContent = "ë§¤ë„";
                    confirmBtn.className = "order-btn sell-btn";
                };

                // ìœ ì§€ ë²„íŠ¼
                document.getElementById("news-popup-hold").onclick = () => {
                    this.currentNews._userAction = "hold";
                    this.addNewsToTimeline(this.currentNews);

                    document.getElementById("news-popup").style.display = "none";
                    document.getElementById("overlay").style.display = "none";
                    this.startSimulation();
                };

                // ì…ë ¥ ì´ë²¤íŠ¸ â†’ ì´ì•¡ ìë™ ê³„ì‚°
                document.getElementById("news-orderAmount").oninput = () => this.calculateNewsOrderTotal();
                document.getElementById("news-orderPrice").oninput = () => this.calculateNewsOrderTotal();

                // í¼ì„¼íŠ¸ ë²„íŠ¼
                document.querySelectorAll('#news-trade-form .percentage-btn').forEach(btn => {
                    btn.onclick = () => {
                        const percent = parseInt(btn.dataset.percent);
                        this.setNewsOrderAmount(percent);
                    };
                });

                // ì§ì ‘ì…ë ¥ %
                document.getElementById("news-percentageInput").oninput = (e) => {
                    let val = parseFloat(e.target.value);
                    if (isNaN(val) || val < 0) val = 0;
                    if (val > 100) val = 100;
                    this.setNewsOrderAmount(val);
                };

                // í™•ì¸ ë²„íŠ¼
                document.getElementById("news-orderConfirm").onclick = () => {
                    const amount = parseFloat(document.getElementById("news-orderAmount").value);
                    const price = parseFloat(document.getElementById("news-orderPrice").value) || this.currentPrices[this.currentMarket];
                    const total = amount * price;

                    // íŒì—… ì „ìš© ìœ íš¨ì„± ê²€ì‚¬
                    if (!amount || amount <= 0) {
                        alert("ì£¼ë¬¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    if (!price || price <= 0) {
                        alert("ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    this.currentNews._userAction = this.isBuyMode ? "buy" : "sell";
                    this.addNewsToTimeline(this.currentNews);

                    const summary = `
                    <div class="summary-row">
                        <span>ë§ˆì¼“:</span>
                        <span>${this.currentMarket.toUpperCase()}/KRW</span>
                    </div>
                    <div class="summary-row">
                        <span>ì£¼ë¬¸êµ¬ë¶„:</span>
                        <span>${this.isBuyMode ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</span>
                    </div>
                    <div class="summary-row">
                        <span>ì£¼ë¬¸ìˆ˜ëŸ‰:</span>
                        <span>${amount.toFixed(8)} ${this.currentMarket.toUpperCase()}</span>
                    </div>
                    <div class="summary-row">
                        <span>ì£¼ë¬¸ë‹¨ê°€:</span>
                        <span>${price.toLocaleString()} KRW</span>
                    </div>
                    <div class="summary-row">
                        <span>ì£¼ë¬¸ì´ì•¡:</span>
                        <span>${Math.floor(total).toLocaleString()} KRW</span>
                    </div>
                `;

                    document.getElementById("orderSummary").innerHTML = summary;
                    document.getElementById("orderModal").style.display = "block";

                    document.getElementById("news-popup").style.display = "none";
                    document.getElementById("overlay").style.display = "none";
                };
                // ìˆ˜ëŸ‰/ê°€ê²© ì…ë ¥ ì‹œ â†’ íŒì—… ì´ì•¡ ìë™ ê³„ì‚°
                document.getElementById("news-orderAmount").oninput = () => this.calculateNewsOrderTotal();
                document.getElementById("news-orderPrice").oninput = () => this.calculateNewsOrderTotal();

                // í¼ì„¼íŠ¸ ë²„íŠ¼
                document.querySelectorAll('#news-trade-form .percentage-btn').forEach(btn => {
                    btn.onclick = () => {
                        const percent = parseInt(btn.dataset.percent);
                        this.setNewsOrderAmount(percent);
                    };
                });

                // ì§ì ‘ì…ë ¥ %
                document.getElementById("news-percentageInput").oninput = (e) => {
                    let val = parseFloat(e.target.value);
                    if (isNaN(val) || val < 0) val = 0;
                    if (val > 100) val = 100;
                    this.setNewsOrderAmount(val);
                };
            }

            setNewsOrderAmount(percent) {
                const currentPrice = this.currentPrices[this.currentMarket];
                if (!currentPrice || currentPrice === 0) return;

                let orderAmount;
                if (this.isBuyMode) {
                    const availableKrw = this.portfolio.krw;
                    const orderTotal = (availableKrw * percent / 100);
                    // ğŸ”¹ ìš°ì¸¡ ê±°ë˜ì°½ ë°©ì‹ ê·¸ëŒ€ë¡œ ì ìš©
                    orderAmount = (orderTotal / currentPrice) - 1e-8;
                } else {
                    const availableCoin = this.portfolio[this.currentMarket].amount;
                    orderAmount = (availableCoin * percent / 100);
                }

                // íŒì—…ì°½ ê°’ ê°±ì‹ 
                document.getElementById("news-orderAmount").value = orderAmount.toFixed(8);
                this.calculateNewsOrderTotal();

                // ğŸ”¹ ìš°ì¸¡ ê±°ë˜ì°½ ê°’ë„ ë™ì¼í•˜ê²Œ ê°±ì‹ 
                document.getElementById("orderAmount").value = orderAmount.toFixed(8);
                this.calculateOrderTotal();
            }

            calculateNewsOrderTotal() {
                const amount = parseFloat(document.getElementById("news-orderAmount").value) || 0;
                const price = parseFloat(document.getElementById("news-orderPrice").value) || this.currentPrices[this.currentMarket];
                const total = amount * price;
                document.getElementById("news-orderTotal").value = Math.floor(total);
            }

            clearOrderForm() {
                document.getElementById('orderAmount').value = '';
                document.getElementById('orderPrice').value = '';
                document.getElementById('orderTotal').value = '';
                document.getElementById('percentageInput').value = '';
            }

            showError(message) {
                const errorElement = document.getElementById('errorMessage');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }

            updateDisplay() {
                this.updateCurrentMarketDisplay();
                this.updatePortfolioDisplay();
                this.updateChart();
            }

            addUserActionToTimeline(news, type, amountKRW) {
                const box = document.getElementById("news-timeline");
                const div = document.createElement("div");
                div.classList.add("user-action");

                let text = "";
                if (type === "buy") {
                    text = `ğŸ‘‰ [ì‚¬ìš©ì] ${Math.floor(amountKRW).toLocaleString()} KRW ë§¤ìˆ˜ ì‹¤í–‰`;
                    div.style.color = "#d73527";
                } else if (type === "sell") {
                    text = `ğŸ‘‰ [ì‚¬ìš©ì] ${Math.floor(amountKRW).toLocaleString()} KRW ë§¤ë„ ì‹¤í–‰`;
                    div.style.color = "#1261c4";
                } else {
                    text = `ğŸ‘‰ [ì‚¬ìš©ì] ìœ ì§€ ì„ íƒ`;
                    div.style.color = "#aaa";
                }

                div.innerText = `${news.time} - ${text}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.tradingSystem = new HistoricalTradingSystem();
        });
    </script>
</body>

</html>