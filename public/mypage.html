<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITC | ë§ˆì´í˜ì´ì§€</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root{
      color-scheme: dark;
      --stroke:#2b2b2b;
      --glow:255,255,255;
      --card-bg-1: rgba(255,255,255,.06);
      --card-bg-2: rgba(255,255,255,.02);
    }
    body{
      margin:0; color:#eaeaea;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 600px at 50% 120%, rgba(255,255,255,.08), transparent 60%),
        repeating-linear-gradient(to bottom, rgba(255,255,255,.03) 0 2px, rgba(0,0,0,0) 2px 8px),
        linear-gradient(#151515, #0a0a0a);
      background-attachment: fixed;
    }
    *{ box-sizing:border-box; }

    /* Header - ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì œê±° */
    header{
      position:fixed; inset:12px 12px auto 12px; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      backdrop-filter:saturate(120%) blur(2px);
    }
    .brand img{
      width:120px; height:auto;
      filter: drop-shadow(0 10px 26px rgba(var(--glow),.22))
              drop-shadow(0 0 20px rgba(var(--glow),.18));
    }
    
    /* Header ìš°ì¸¡ ë²„íŠ¼ ê·¸ë£¹ */
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .navbtn{
      display:inline-flex; align-items:center; gap:8px;
      height:36px; padding:0 12px; border-radius:10px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke); color:#f3f3f3; text-decoration:none; font-weight:700;
      transition:.22s; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .navbtn:hover{
      border-color:rgba(var(--glow),.32);
      box-shadow:0 0 12px rgba(var(--glow),.22);
      transform:translateY(-1px); color:#fff;
    }
    
    /* Admin ë²„íŠ¼ ì¼ë°˜ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½ */
    .admin-btn {
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      color:#f3f3f3;
    }
    .admin-btn:hover {
      border-color:rgba(var(--glow),.32);
      box-shadow:0 0 12px rgba(var(--glow),.22);
      color:#fff;
    }

    /* Layout */
    main{
      width:min(1100px,92vw);
      margin:130px auto 48px;
      display:flex; flex-direction:column; gap:22px;
      position: relative;
    }
    .pagetitle h1{
      margin:0; font-size:clamp(22px,3.2vw,30px); font-weight:900; letter-spacing:.2px;
      background:linear-gradient(95deg,#fff 0%,#eee 18%,#fff 45%,#d2d2d2 65%,#fff 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      filter: drop-shadow(0 12px 36px rgba(var(--glow),.18)) drop-shadow(0 0 24px rgba(var(--glow),.14));
    }

    /* Card */
    .card{
      position:relative;
      background:linear-gradient(180deg, var(--card-bg-1), var(--card-bg-2) 40%, rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:
        0 8px 22px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 0 30px rgba(255,255,255,.03);
      overflow:hidden;
      transition:.28s;
      padding:22px;
    }
    .card::after{
      content:""; position:absolute; inset:auto 0 0 0; height:46px;
      background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.08));
      pointer-events:none;
    }
    .card:hover{
      transform:translateY(-5px);
      box-shadow:0 12px 26px rgba(0,0,0,.45), 0 0 18px rgba(var(--glow),.16);
      border-color:rgba(var(--glow),.22);
    }

    .card h2{
      margin:0 0 16px; font-size:20px; font-weight:800;
      display:flex; align-items:center; justify-content:space-between;
    }
    .h2-left{ display:flex; align-items:center; gap:10px; }
    .h2-right{ display:flex; align-items:center; gap:8px; }
    .icon-btn{
      border:1px solid var(--stroke); background:rgba(255,255,255,.04); color:#e8e8e8;
      border-radius:10px; padding:8px 12px; cursor:pointer; font-size:14px; font-weight:700;
      transition:.22s;
    }
    .icon-btn:hover{
      border-color:rgba(var(--glow),.30); box-shadow:0 0 12px rgba(var(--glow),.18); transform:translateY(-1px);
    }
    .dropdown{ position:relative; }
    .menu{
      position:absolute; top:110%; right:0; display:none; min-width:200px;
      background:rgba(26,26,26,.96); border:1px solid var(--stroke); border-radius:12px; padding:6px;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .menu.open{ display:block; }
    .menu button{
      width:100%; text-align:left; background:transparent; border:none; color:#e8e8e8;
      padding:10px 12px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;
    }
    .menu button:hover{ background:rgba(255,255,255,.06); }
    .menu .danger{ color:#ffb3b3; }
    .menu .logout{ color:#7e7a6e; }

    /* Profile info */
    .profile-wrap{ display:flex; gap:20px; align-items:center; margin:6px 0 18px; }
    .avatar{
      width:84px; height:84px; border-radius:50%; flex:none;
      background:linear-gradient(135deg, #1a1a1a, #2a2a2a);
      border:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:center;
      font-size:30px; font-weight:800; color:#bcd9ff;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 -1px 0 rgba(0,0,0,.2),
        0 4px 12px rgba(0,0,0,.3);
      overflow: hidden;
    }
    .avatar img {
      width: 70%;
      height: 70%;
      object-fit: contain; /* ì‹¤ë£¨ì—£ì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ */
      display: block;
      filter: 
        brightness(0) 
        invert(1) 
        opacity(0.85);
      /* ê²€ì€ ì‹¤ë£¨ì—£ì„ í°ìƒ‰ìœ¼ë¡œ ë³€í™˜í•˜ê³  ì•½ê°„ íˆ¬ëª…í•˜ê²Œ */
    }
    .profile{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)); }
    .field .label{ opacity:.7; font-size:13px; }
    .field .value{ font-size:17px; margin-top:2px; }
    @media (max-width:640px){ .profile{ grid-template-columns:1fr; } }

    /* Quick */
    .quick{ display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 2px; }
    .qbtn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.04); color:#e8e8e8; text-decoration:none; font-weight:700;
      transition:.22s;
    }
    .qbtn:hover{ border-color:rgba(var(--glow),.30); box-shadow:0 0 12px rgba(var(--glow),.16); transform:translateY(-1px); }
    .qbtn img{ width:18px; height:18px; display:block; }

    /* Wallet */
    .wallet{ margin-top:8px; padding-top:16px; border-top:1px dashed #616161; display:grid; gap:14px; }
    
    /* ì´ ìì‚° ìŠ¤íƒ€ì¼ - ì„±ê³¼ í‘œì‹œ ì¶”ê°€ */
    .total-assets {
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:14px 16px;
      box-shadow: 
        inset 0 1px 0 rgba(255,255,255,.1),
        0 4px 12px rgba(0,0,0,.15);
      margin-bottom:10px;
    }
    .total-assets-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .total-assets-label {
      font-weight: 700;
      font-size: 16px;
      color: #fff;
    }
    .total-assets-amount {
      color: #00d4aa; /* ì´ ìì‚°ì€ ì²­ë¡ìƒ‰ìœ¼ë¡œ */
      font-weight: 800;
      font-size: 18px;
      text-shadow: 0 0 8px rgba(0, 212, 170, 0.3);
    }
    .total-assets-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    .performance-change {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .performance-percent {
      font-weight: 800;
      font-size: 14px;
      padding: 2px 8px;
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
    }
    .gain {
      color: #ff6b6b;
      text-shadow: 0 0 6px rgba(255, 107, 107, 0.4);
    }
    .loss {
      color: #84ceff;
      text-shadow: 0 0 6px rgba(132, 206, 255, 0.4);
    }
    .neutral {
      color: #ccc;
    }
    
    .cash{
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke); border-radius:12px; padding:12px 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .cash-amount {
      color: #ffd700; /* ê¸ˆì•¡ í…ìŠ¤íŠ¸ ë…¸ë€ìƒ‰ */
      font-weight: 700;
    }
    .holdings{
      background:rgba(255,255,255,.04);
      border:1px solid var(--stroke); border-radius:12px; overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }

    table{ width:100%; border-collapse:collapse; font-size:15px; table-layout:fixed; }
    th,td{ padding:12px 14px; border-bottom:1px solid #262626; text-align:left; }
    th{ background:rgba(255,255,255,.04); font-weight:700; }
    tr:last-child td{ border-bottom:none; }

    /* í…Œì´ë¸” ì»¬ëŸ¼ ë„ˆë¹„ ì¡°ì • - 4ê°œ ì»¬ëŸ¼ìœ¼ë¡œ í™•ì¥ */
    th:nth-child(1), td:nth-child(1){ width:20%; border-right:1px solid var(--stroke); }
    th:nth-child(2), td:nth-child(2){ width:25%; border-right:1px solid var(--stroke); }
    th:nth-child(3), td:nth-child(3){ width:25%; border-right:1px solid var(--stroke); }
    th:nth-child(4), td:nth-child(4){ width:30%; }

    /* Bottom links */
    .actions-row{
      width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:-4px;
    }
    .pill-link{
      background:rgba(255,255,255,.04);
      border:1px solid var(--stroke); color:#f2f2f2;
      border-radius:11px; height:40px; padding:0 14px; text-decoration:none; font-weight:800;
      display:inline-flex; align-items:center; gap:10px; transition:.24s;
    }
    .pill-link:hover{ 
      border-color:rgba(var(--glow),.30); 
      box-shadow:0 0 12px rgba(var(--glow),.20), 0 10px 20px rgba(0,0,0,.35); 
      color:#fff; 
      transform:translateY(-1px); 
    }

    /* ì˜¤ë¥¸ìª½ í•˜ë‹¨ ê³ ì • ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
    .floating-logout {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
      background: rgba(255, 68, 58, 0.267);
      border: 1px solid rgba(71, 69, 69, 0.4);
      color: #b94e4e;
      border-radius: 50px;
      padding: 12px 20px;
      font-weight: 700;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all .24s ease;
      box-shadow: 0 4px 12px rgba(255,69,58,.15);
    }
    .floating-logout:hover {
      background: rgba(255,69,58,.2);
      border-color: rgba(255,69,58,.6);
      box-shadow: 0 6px 20px rgba(255,69,58,.25);
      transform: translateY(-2px);
      color: #ff4757;
    }

    /* Modals (íƒˆí‡´ë§Œ ìœ ì§€) */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.7);
      display:none; justify-content:center; align-items:center; z-index:1000;
    }
    .modal-content{
      background:rgba(44,44,44,.98); padding:24px; border-radius:12px; width:90%; max-width:480px;
      border:1px solid var(--stroke); box-shadow:0 10px 24px rgba(0,0,0,.45);
    }
    .modal-content h2{ margin-top:0; }
    .modal-content textarea{
      width:100%; padding:10px; border-radius:8px; border:1px solid #555; background:#1a1a1a; color:#e8e8e8; margin-top:10px;
    }
    .modal-actions{ margin-top:20px; display:flex; justify-content:flex-end; gap:10px; }
    .btn-secondary{ background:#555; color:#fff; border:none; padding:10px 16px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-secondary:hover{ background:#777; }
    .danger-btn{ background:#c82333; color:#fff; border:none; padding:10px 16px; border-radius:8px; font-weight:700; cursor:pointer; }
    .danger-btn:hover{ background:#a51c2b; }

    th:last-child {
      position: relative;
    }

    .refresh-btn{
      margin-left:6px;
      background:transparent;
      border:none;
      color:#ccc;
      cursor:pointer;
      font-size:14px;
      line-height:1;
    }
    .refresh-btn:hover{ color:#fff; }

    /* í‰ê· ë§¤ì…ê°€ ìŠ¤íƒ€ì¼ë§ */
    .avg-price {
      font-weight: 600;
      color:#ccc;
    }

    @media (max-width: 768px) {
      .floating-logout {
        bottom: 16px;
        right: 16px;
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .total-assets {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .total-assets-right {
        align-items: flex-start;
      }
      
      .performance-change {
        justify-content: space-between;
        width: 100%;
      }
    }

  </style>
</head>
<body>
  <header>
    <a class="brand" href="index.html"><img src="/images/logo.png" alt="ITC ë¡œê³ " /></a>
    <div class="header-actions">
      <!-- Admin button - initially hidden -->
      <a class="navbtn admin-btn" href="https://app.fabric.microsoft.com/reportEmbed?reportId=48ee305d-6830-46b4-93f9-c972f4cc2d39&autoAuth=true&ctid=5fb256f0-fbf2-40d2-81d5-bac1b32c419d" id="adminBtn" style="display:none;">ğŸ“Š Admin</a>
      <a class="navbtn" href="index.html">â† Back</a>
    </div>
  </header>

  <main>
    <div class="pagetitle"><h1>My Page</h1></div>

    <!-- Profile Card -->
    <section class="card" aria-label="í”„ë¡œí•„ ë° ì§€ê°‘">
      <h2>
        <span class="h2-left">Profile</span>
        <span class="h2-right">
          <span class="dropdown">
            <button class="icon-btn" id="profileMenuBtn" aria-haspopup="true" aria-expanded="false" title="ì„¤ì •">âš™ï¸ ì„¤ì •</button>
            <div class="menu" id="profileMenu" role="menu" aria-label="í”„ë¡œí•„ ë©”ë‰´">
              <button id="logoutFromMenuBtn" class="logout" role="menuitem">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
              <button id="openDeletionFromMenuBtn" class="danger" role="menuitem">íšŒì› íƒˆí‡´</button>
            </div>
          </span>
        </span>
      </h2>

      <!-- Avatar + Basic info -->
      <div class="profile-wrap">
        <div class="avatar" id="avatarContainer">
          <span id="avatarInitial">U</span>
        </div>
        <div class="profile">
          <div class="field">
            <div class="label">ê³„ì •</div>
            <div class="value" id="userName">-</div>
          </div>
          <div class="field">
            <div class="label">ê°€ì…ì¼ì</div>
            <div class="value" id="signupDate">-</div>
          </div>
        </div>
      </div>

      <!-- Quick links -->
      <div class="quick" aria-label="ë¹ ë¥¸ ì´ë™">
        <a class="qbtn" href="historical.html">ğŸ“– ì‹œë®¬ë ˆì´ì…˜</a>
        <a class="qbtn" href="realtime.html">ğŸ“ˆ ëª¨ì˜ íˆ¬ì</a>
        <a class="qbtn" href="crypto.html">ğŸ“œ ì•”í˜¸í™”í ë°±ê³¼ì‚¬ì „</a>
        <a class="qbtn" href="news.html">ğŸ“° ë‰´ìŠ¤</a>
      </div>

      <!-- Wallet -->
      <div class="wallet">
        <!-- ì´ ìì‚° í‘œì‹œ (ì„±ê³¼ í‘œì‹œ ì¶”ê°€) -->
        <div class="total-assets">
          <div class="total-assets-left">
            <div class="total-assets-label">ğŸ’° ì´ ìì‚°</div>
            <div id="totalAssets" class="total-assets-amount">0ì›</div>
          </div>
          <div class="total-assets-right">
            <div id="performanceChange" class="performance-change neutral">
              <span id="changeAmount">Â±0ì›</span>
            </div>
            <div id="performancePercent" class="performance-percent neutral">0.00%</div>
          </div>
        </div>
        
        <div class="cash">
          <div>ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡</div>
          <div id="cashKRW" class="cash-amount">0ì›</div>
        </div>
        <div class="holdings">
          <table>
            <thead>
              <tr>
                <th>ì¢…ëª©</th>
                <th>ë³´ìœ ìˆ˜ëŸ‰</th>
                <th>í‰ê· ë§¤ì…ê°€</th>
                <th>
                  í‰ê°€ê¸ˆì•¡ (ì´ìµ/ì†ì‹¤)
                  <button id="refreshHoldingsBtn" class="refresh-btn" title="ìƒˆë¡œê³ ì¹¨" style="position:absolute; right:14px; top:50%; transform:translateY(-50%);">â†º</button>
                </th>
              </tr>
            </thead>
            <tbody id="holdingsBody"><tr><td colspan="4" style="opacity:.7">ë¡œë”© ì¤‘â€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Bottom actions -->
    <div class="actions-row" aria-label="í˜ì´ì§€ ì´ë™">
      <a class="pill-link" href="report.html">ğŸ“‘ REPORT</a>
      <a class="pill-link" href="qna.html">â“ Q&amp;A</a>
    </div>
  </main>

  <!-- ì˜¤ë¥¸ìª½ í•˜ë‹¨ ê³ ì • ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
  <a class="floating-logout" href="/logout" aria-label="ë¡œê·¸ì•„ì›ƒ">
    ğŸšª LOGOUT
  </a>

  <!-- íƒˆí‡´ ëª¨ë‹¬ë§Œ ìœ ì§€ -->
  <div id="deletion-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="deletion-title">
    <div class="modal-content">
      <h2 id="deletion-title">íšŒì› íƒˆí‡´</h2>
      <p>íƒˆí‡´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. íƒˆí‡´ ì‹ ì²­ í›„ í™•ì¸ ì´ë©”ì¼ì´ ë°œì†¡ë˜ë©°, ì´ë©”ì¼ ì¸ì¦ ì‹œ 14ì¼ í›„ì— ê³„ì •ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
      <form id="deletion-form">
        <textarea id="deletion-reason" placeholder="(ì„ íƒ) íƒˆí‡´ ì‚¬ìœ " rows="4"></textarea>
        <div class="modal-actions">
          <button type="button" id="cancel-deletion-btn" class="btn-secondary">ì·¨ì†Œ</button>
          <button type="submit" class="danger-btn">íƒˆí‡´ ì‹ ì²­</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // ì´ˆê¸° ìë³¸ ì„¤ì • (1ì²œë§Œì›)
    const INITIAL_CAPITAL = 10000000;

    // ê´€ë¦¬ì ì‚¬ìš©ì ëª©ë¡
    const adminUsers = [
      '1dt021@msacademy.msai.kr',
      '1dt030@msacademy.msai.kr',
      '1dt019@msacademy.msai.kr',
      '1dt037@msacademy.msai.kr',
      '1dt035@msacademy.msai.kr',
      '1dt001@msacademy.msai.kr',
      '1dt137@msacademy.msai.kr'
    ];

    /* dropdown */
    const profileMenuBtn = $('#profileMenuBtn');
    const profileMenu    = $('#profileMenu');
    function openMenu(){ profileMenu.classList.add('open'); profileMenuBtn.setAttribute('aria-expanded','true'); }
    function closeMenu(){ profileMenu.classList.remove('open'); profileMenuBtn.setAttribute('aria-expanded','false'); }
    profileMenuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); profileMenu.classList.contains('open') ? closeMenu() : openMenu(); });
    document.addEventListener('click', (e)=>{ if (!profileMenu.contains(e.target) && e.target !== profileMenuBtn) closeMenu(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMenu(); });

    /* ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ */
    const logoutFromMenuBtn = $('#logoutFromMenuBtn');
    logoutFromMenuBtn.addEventListener('click', () => {
      closeMenu();
      window.location.href = '/logout';
    });

    /* íƒˆí‡´ ëª¨ë‹¬ */
    const deletionModal  = $('#deletion-modal');
    const openDeletionBtn= $('#openDeletionFromMenuBtn');
    const cancelDeletionBtn = $('#cancel-deletion-btn');
    const deletionForm   = $('#deletion-form');
    function openDeletion(){ deletionModal.style.display='flex'; }
    function closeDeletion(){ deletionModal.style.display='none'; }
    openDeletionBtn.addEventListener('click', ()=>{ closeMenu(); openDeletion(); });
    cancelDeletionBtn.addEventListener('click', closeDeletion);
    window.addEventListener('click', (e)=>{ if (e.target === deletionModal) closeDeletion(); });

    deletionForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const reason = $('#deletion-reason').value;
      try{
        const response = await fetch('/api/user/request-deletion', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ reason })
        });
        const result = await response.json();
        if (response.ok){
          closeDeletion();
          if (result.scheduled){
            alert('íšŒì› íƒˆí‡´ê°€ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤. 14ì¼ ì´ë‚´ ì¬ë¡œê·¸ì¸ ì‹œ íƒˆí‡´ê°€ ì·¨ì†Œë©ë‹ˆë‹¤.');
            window.location.href = '/logout';
          }else{
            alert('íšŒì› íƒˆí‡´ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
          }
        }else{
          alert(`ì˜¤ë¥˜: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
        }
      }catch(err){
        console.error('Deletion request failed:', err);
        alert('íƒˆí‡´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ì•„ë°”íƒ€ ì„¤ì • í•¨ìˆ˜
    function setAvatar(gender, username) {
      const avatarContainer = $('#avatarContainer');
      const avatarInitial = $('#avatarInitial');
      
      if (gender === 'ë‚¨' || gender === 'ì—¬') {
        // ì„±ë³„ ì •ë³´ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ ì‚¬ìš©
        const imageSrc = gender === 'ë‚¨' ? '/images/man.jpg' : '/images/woman.jpg';
        avatarContainer.innerHTML = `<img src="${imageSrc}" alt="${gender}ì„± ì•„ë°”íƒ€" />`;
      } else {
        // ì„±ë³„ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ì´ë‹ˆì…œ ì‚¬ìš©
        avatarInitial.textContent = username.trim().charAt(0).toUpperCase() || 'U';
      }
    }

    // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
    const fmtKRW = n => Number(n).toLocaleString('ko-KR') + 'ì›';
    const fmtPercent = n => n.toFixed(2) + '%';

    // ì„±ê³¼ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePerformance(totalAssets) {
      const changeAmount = totalAssets - INITIAL_CAPITAL;
      const changePercent = ((totalAssets - INITIAL_CAPITAL) / INITIAL_CAPITAL) * 100;
      
      const changeAmountEl = $('#changeAmount');
      const changePercentEl = $('#performancePercent');
      const performanceChangeEl = $('#performanceChange');
      
      // ê¸ˆì•¡ ë³€ë™ í‘œì‹œ
      if (changeAmount > 0) {
        changeAmountEl.textContent = '+' + fmtKRW(changeAmount);
        changePercentEl.textContent = '+' + fmtPercent(changePercent);
        performanceChangeEl.className = 'performance-change gain';
        changePercentEl.className = 'performance-percent gain';
      } else if (changeAmount < 0) {
        changeAmountEl.textContent = fmtKRW(changeAmount);
        changePercentEl.textContent = fmtPercent(changePercent);
        performanceChangeEl.className = 'performance-change loss';
        changePercentEl.className = 'performance-percent loss';
      } else {
        changeAmountEl.textContent = 'Â±' + fmtKRW(0);
        changePercentEl.textContent = fmtPercent(0);
        performanceChangeEl.className = 'performance-change neutral';
        changePercentEl.className = 'performance-percent neutral';
      }
      
      console.log('ì„±ê³¼ ì—…ë°ì´íŠ¸:', {
        totalAssets: fmtKRW(totalAssets),
        changeAmount: fmtKRW(changeAmount),
        changePercent: fmtPercent(changePercent)
      });
    }

    // ì´ ìì‚° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì„±ê³¼ í‘œì‹œ í¬í•¨)
    function updateTotalAssets() {
      // ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡
      const cashText = $('#cashKRW').textContent;
      const cashAmount = parseFloat(cashText.replace(/[^\d]/g, '')) || 0;
      
      // ë³´ìœ  ì¢…ëª©ì˜ í‰ê°€ê¸ˆì•¡ í•©ê³„ ê³„ì‚°
      let totalHoldingsValue = 0;
      const holdingRows = document.querySelectorAll('#holdingsBody tr');
      
      console.log('ì´ ìì‚° ê³„ì‚° ì¤‘...', {
        cashAmount,
        holdingRowsCount: holdingRows.length
      });
      
      holdingRows.forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4 && !cells[0].textContent.includes('ë¡œë”©') && !cells[0].textContent.includes('ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤')) {
          const evaluationCell = cells[3].textContent;
          console.log(`í–‰ ${index}: ${evaluationCell}`);
          
          // í‰ê°€ê¸ˆì•¡ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ (ì›, ì‰¼í‘œ ì œê±°) - ë” ì •í™•í•œ íŒ¨í„´ ë§¤ì¹­
          const numbers = evaluationCell.match(/[\d,]+/g);
          if (numbers && numbers.length > 0) {
            // ì²« ë²ˆì§¸ ìˆ«ìê°€ í‰ê°€ê¸ˆì•¡
            const value = parseFloat(numbers[0].replace(/,/g, '')) || 0;
            totalHoldingsValue += value;
            console.log(`  -> ì¶”ì¶œëœ ê°’: ${value}`);
          }
        }
      });
      
      // ì´ ìì‚° = ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡ + ë³´ìœ  ì¢…ëª© í‰ê°€ê¸ˆì•¡
      const totalAssets = cashAmount + totalHoldingsValue;
      
      console.log('ì´ ìì‚° ê³„ì‚° ê²°ê³¼:', {
        cashAmount,
        totalHoldingsValue,
        totalAssets
      });
      
      // ì´ ìì‚° í‘œì‹œ
      $('#totalAssets').textContent = fmtKRW(totalAssets);
      
      // ì„±ê³¼ í‘œì‹œ ì—…ë°ì´íŠ¸
      updatePerformance(totalAssets);
    }

    // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œí•˜ì—¬ mypage.jsì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡
    window.updateTotalAssets = updateTotalAssets;

    // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ë° ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    (async ()=>{
      try{
        const res = await fetch('/api/user');
        if (!res.ok){
          if (res.status === 401) { location.href = '/'; }
          else { throw new Error('HTTP ' + res.status); }
          return;
        }
        const user = await res.json();
        const username = user.username || '';
        
        $('#userName').textContent = username || 'ì‚¬ìš©ì';
        
        // ì•„ë°”íƒ€ ì„¤ì • (gender ê¸°ë°˜)
        setAvatar(user.gender, username);
        
        const joined = user.created_at ? new Date(user.created_at) : new Date();
        $('#signupDate').textContent = joined.toLocaleDateString('ko-KR');

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ë° ADMIN ë²„íŠ¼ í‘œì‹œ
        if (adminUsers.includes(username)) {
          $('#adminBtn').style.display = 'inline-flex';
        }

        // ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡ í‘œì‹œ (krw_balance ì‚¬ìš©)
        $('#cashKRW').textContent = fmtKRW(user.krw_balance || 0);
        
        // ì´ˆê¸°ì—ëŠ” ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡ë§Œìœ¼ë¡œ ì´ ìì‚° ë° ì„±ê³¼ í‘œì‹œ
        const initialAssets = user.krw_balance || 0;
        $('#totalAssets').textContent = fmtKRW(initialAssets);
        updatePerformance(initialAssets);

      }catch(err){
        console.error('Failed to fetch user data:', err);
      }
    })();
    
    // ë” ê°•ë ¥í•œ ë³´ìœ  ì¢…ëª© ë³€ê²½ ê°ì§€
    let debounceTimer;
    const debouncedUpdate = () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        console.log('ë³´ìœ  ì¢…ëª© ë³€ê²½ ê°ì§€ë¨, ì´ ìì‚° ì—…ë°ì´íŠ¸ ì¤‘...');
        updateTotalAssets();
      }, 200);
    };
    
    // MutationObserverë¡œ í…Œì´ë¸” ë³€ê²½ ê°ì§€
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.target.id === 'holdingsBody' || 
            mutation.target.closest('#holdingsBody')) {
          debouncedUpdate();
        }
      });
    });
    
    // ë³´ìœ  ì¢…ëª© í…Œì´ë¸” ë³€ê²½ ê°ì§€
    const holdingsBody = $('#holdingsBody');
    if (holdingsBody) {
      observer.observe(holdingsBody, { 
        childList: true, 
        subtree: true,
        characterData: true 
      });
    }
    
    // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì— ì´ ìì‚° ì—…ë°ì´íŠ¸ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', () => {
      const refreshBtn = $('#refreshHoldingsBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          setTimeout(() => {
            console.log('ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ í›„ ì´ ìì‚° ì—…ë°ì´íŠ¸');
            updateTotalAssets();
          }, 1000); // 1ì´ˆ í›„ ì—…ë°ì´íŠ¸
        });
      }
    });
    
    // í˜ì´ì§€ ì™„ì „ ë¡œë”© í›„ ì´ ìì‚° ì—…ë°ì´íŠ¸
    window.addEventListener('load', () => {
      setTimeout(() => {
        console.log('í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì´ ìì‚° ì—…ë°ì´íŠ¸');
        updateTotalAssets();
      }, 2000);
    });
    
    // realtime í˜ì´ì§€ ì”ê³  ë™ê¸°í™”
    (function() {
      // realtime í˜ì´ì§€ ì”ê³  ê°’ì„ ê°€ì ¸ì™€ì„œ ì ìš©
      function loadRealtimeBalance() {
        try {
          const stored = localStorage.getItem('realtime_balance');
          if (stored) {
            const data = JSON.parse(stored);
            
            // 5ë¶„ ì´ë‚´ ë°ì´í„°ë§Œ ì‚¬ìš©
            const age = Date.now() - data.updated_at;
            if (age < 5 * 60 * 1000 && data.source === 'realtime_page') {
              
              // realtimeì˜ available_amount ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
              const realtimeValue = data.available_amount;
              const cashElement = document.getElementById('cashKRW');
              
              if (cashElement && realtimeValue) {
                // "0 KRW" í˜•íƒœë¥¼ "0ì›" í˜•íƒœë¡œ ë³€í™˜
                let formattedValue = realtimeValue.replace(' KRW', 'ì›').replace('KRW', 'ì›');
                
                // ìˆ«ìë§Œ ì¶”ì¶œí•´ì„œ í•œêµ­ì–´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const numbers = formattedValue.match(/[\d,]+/);
                if (numbers && numbers[0]) {
                  const numValue = parseInt(numbers[0].replace(/,/g, ''));
                  formattedValue = numValue.toLocaleString('ko-KR') + 'ì›';
                }
                
                // í˜„ì¬ ê°’ê³¼ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
                const currentValue = cashElement.textContent.trim();
                if (currentValue !== formattedValue) {
                  // ì—…ë°ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜
                  cashElement.style.transition = 'all 0.3s ease';
                  cashElement.style.transform = 'scale(1.05)';
                  cashElement.style.color = '#00d4aa';
                  
                  setTimeout(() => {
                    cashElement.textContent = formattedValue;
                    cashElement.style.transform = 'scale(1)';
                    cashElement.style.color = '#ffd700';
                    
                    // ì´ ìì‚° ë° ì„±ê³¼ë„ ì—…ë°ì´íŠ¸
                    if (window.updateTotalAssets) {
                      setTimeout(window.updateTotalAssets, 300);
                    }
                  }, 150);
                  
                  console.log('ğŸ’° realtimeì—ì„œ ì”ê³  ë³µì‚¬ë¨:', formattedValue);
                }
              }
            }
          }
        } catch (error) {
          console.error('realtime ì”ê³  ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }
      
      // BroadcastChannelë¡œ ì‹¤ì‹œê°„ ìˆ˜ì‹ 
      if (typeof BroadcastChannel !== 'undefined') {
        try {
          const channel = new BroadcastChannel('realtime_balance');
          channel.addEventListener('message', (event) => {
            const data = event.data;
            if (data.source === 'realtime_page') {
              
              const realtimeValue = data.available_amount;
              const cashElement = document.getElementById('cashKRW');
              
              if (cashElement && realtimeValue) {
                // ê°’ ë³€í™˜
                let formattedValue = realtimeValue.replace(' KRW', 'ì›').replace('KRW', 'ì›');
                const numbers = formattedValue.match(/[\d,]+/);
                if (numbers && numbers[0]) {
                  const numValue = parseInt(numbers[0].replace(/,/g, ''));
                  formattedValue = numValue.toLocaleString('ko-KR') + 'ì›';
                }
                
                // ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ê¹œë¹¡ì´ íš¨ê³¼)
                cashElement.style.backgroundColor = 'rgba(0, 212, 170, 0.3)';
                cashElement.textContent = formattedValue;
                
                setTimeout(() => {
                  cashElement.style.backgroundColor = '';
                  if (window.updateTotalAssets) {
                    window.updateTotalAssets();
                  }
                }, 1000);
                
                console.log('ğŸ’° realtime ì‹¤ì‹œê°„ ì”ê³  ìˆ˜ì‹ :', formattedValue);
              }
            }
          });
        } catch (e) {
          console.log('BroadcastChannel ë¯¸ì§€ì›, localStorageë§Œ ì‚¬ìš©');
        }
      }
      
      // í˜ì´ì§€ ë¡œë“œì‹œ realtime ì”ê³  í™•ì¸
      loadRealtimeBalance();
      
      // í˜ì´ì§€ í¬ì»¤ìŠ¤ì‹œ realtime ì”ê³  í™•ì¸
      window.addEventListener('focus', loadRealtimeBalance);
      
      // 30ì´ˆë§ˆë‹¤ realtime ì”ê³  í™•ì¸
      setInterval(loadRealtimeBalance, 30000);
      
      // localStorage ë³€ê²½ ê°ì§€ (ë‹¤ë¥¸ íƒ­ì—ì„œ realtime ì‚¬ìš©ì‹œ)
      window.addEventListener('storage', (e) => {
        if (e.key === 'realtime_balance' && e.newValue) {
          loadRealtimeBalance();
        }
      });
    })(); 
  </script>
  <script src="/mypage.js"></script>
</body>
</html>