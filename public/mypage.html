<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITC | 마이페이지</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root{
      color-scheme: dark;
      --stroke:#2b2b2b;
      --glow:255,255,255;
      --card-bg-1: rgba(255,255,255,.06);
      --card-bg-2: rgba(255,255,255,.02);
    }
    body{
      margin:0; color:#eaeaea;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 600px at 50% 120%, rgba(255,255,255,.08), transparent 60%),
        repeating-linear-gradient(to bottom, rgba(255,255,255,.03) 0 2px, rgba(0,0,0,0) 2px 8px),
        linear-gradient(#151515, #0a0a0a);
      background-attachment: fixed;
    }
    *{ box-sizing:border-box; }

    /* Header - 로그아웃 버튼 제거 */
    header{
      position:fixed; inset:12px 12px auto 12px; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      backdrop-filter:saturate(120%) blur(2px);
    }
    .brand img{
      width:120px; height:auto;
      filter: drop-shadow(0 10px 26px rgba(var(--glow),.22))
              drop-shadow(0 0 20px rgba(var(--glow),.18));
    }
    
    /* Header 우측 버튼 그룹 */
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .navbtn{
      display:inline-flex; align-items:center; gap:8px;
      height:36px; padding:0 12px; border-radius:10px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke); color:#f3f3f3; text-decoration:none; font-weight:700;
      transition:.22s; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .navbtn:hover{
      border-color:rgba(var(--glow),.32);
      box-shadow:0 0 12px rgba(var(--glow),.22);
      transform:translateY(-1px); color:#fff;
    }
    
    /* Admin 버튼 일반 스타일로 변경 */
    .admin-btn {
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      color:#f3f3f3;
    }
    .admin-btn:hover {
      border-color:rgba(var(--glow),.32);
      box-shadow:0 0 12px rgba(var(--glow),.22);
      color:#fff;
    }

    /* Layout */
    main{
      width:min(1100px,92vw);
      margin:130px auto 48px;
      display:flex; flex-direction:column; gap:22px;
      position: relative;
    }
    .pagetitle h1{
      margin:0; font-size:clamp(22px,3.2vw,30px); font-weight:900; letter-spacing:.2px;
      background:linear-gradient(95deg,#fff 0%,#eee 18%,#fff 45%,#d2d2d2 65%,#fff 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      filter: drop-shadow(0 12px 36px rgba(var(--glow),.18)) drop-shadow(0 0 24px rgba(var(--glow),.14));
    }

    /* Card */
    .card{
      position:relative;
      background:linear-gradient(180deg, var(--card-bg-1), var(--card-bg-2) 40%, rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:
        0 8px 22px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 0 30px rgba(255,255,255,.03);
      overflow:hidden;
      transition:.28s;
      padding:22px;
    }
    .card::after{
      content:""; position:absolute; inset:auto 0 0 0; height:46px;
      background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.08));
      pointer-events:none;
    }
    .card:hover{
      transform:translateY(-5px);
      box-shadow:0 12px 26px rgba(0,0,0,.45), 0 0 18px rgba(var(--glow),.16);
      border-color:rgba(var(--glow),.22);
    }

    .card h2{
      margin:0 0 16px; font-size:20px; font-weight:800;
      display:flex; align-items:center; justify-content:space-between;
    }
    .h2-left{ display:flex; align-items:center; gap:10px; }
    .h2-right{ display:flex; align-items:center; gap:8px; }
    .icon-btn{
      border:1px solid var(--stroke); background:rgba(255,255,255,.04); color:#e8e8e8;
      border-radius:10px; padding:8px 12px; cursor:pointer; font-size:14px; font-weight:700;
      transition:.22s;
    }
    .icon-btn:hover{
      border-color:rgba(var(--glow),.30); box-shadow:0 0 12px rgba(var(--glow),.18); transform:translateY(-1px);
    }
    .dropdown{ position:relative; }
    .menu{
      position:absolute; top:110%; right:0; display:none; min-width:200px;
      background:rgba(26,26,26,.96); border:1px solid var(--stroke); border-radius:12px; padding:6px;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .menu.open{ display:block; }
    .menu button{
      width:100%; text-align:left; background:transparent; border:none; color:#e8e8e8;
      padding:10px 12px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;
    }
    .menu button:hover{ background:rgba(255,255,255,.06); }
    .menu .danger{ color:#ffb3b3; }
    .menu .logout{ color:#7e7a6e; }

    /* Profile info */
    .profile-wrap{ display:flex; gap:20px; align-items:center; margin:6px 0 18px; }
    .avatar{
      width:84px; height:84px; border-radius:50%; flex:none;
      background:linear-gradient(135deg, #1a1a1a, #2a2a2a);
      border:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:center;
      font-size:30px; font-weight:800; color:#bcd9ff;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 -1px 0 rgba(0,0,0,.2),
        0 4px 12px rgba(0,0,0,.3);
      overflow: hidden;
    }
    .avatar img {
      width: 70%;
      height: 70%;
      object-fit: contain; /* 실루엣이 잘리지 않도록 */
      display: block;
      filter: 
        brightness(0) 
        invert(1) 
        opacity(0.85);
      /* 검은 실루엣을 흰색으로 변환하고 약간 투명하게 */
    }
    .profile{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)); }
    .field .label{ opacity:.7; font-size:13px; }
    .field .value{ font-size:17px; margin-top:2px; }
    @media (max-width:640px){ .profile{ grid-template-columns:1fr; } }

    /* Quick */
    .quick{ display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 2px; }
    .qbtn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.04); color:#e8e8e8; text-decoration:none; font-weight:700;
      transition:.22s;
    }
    .qbtn:hover{ border-color:rgba(var(--glow),.30); box-shadow:0 0 12px rgba(var(--glow),.16); transform:translateY(-1px); }
    .qbtn img{ width:18px; height:18px; display:block; }

    /* Wallet */
    .wallet{ margin-top:8px; padding-top:16px; border-top:1px dashed #616161; display:grid; gap:14px; }
    
    /* 총 자산 스타일 - 성과 표시 추가 */
    .total-assets {
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:14px 16px;
      box-shadow: 
        inset 0 1px 0 rgba(255,255,255,.1),
        0 4px 12px rgba(0,0,0,.15);
      margin-bottom:10px;
    }
    .total-assets-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .total-assets-label {
      font-weight: 700;
      font-size: 16px;
      color: #fff;
    }
    .total-assets-amount {
      color: #00d4aa; /* 총 자산은 청록색으로 */
      font-weight: 800;
      font-size: 18px;
      text-shadow: 0 0 8px rgba(0, 212, 170, 0.3);
    }
    .total-assets-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    .performance-change {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .performance-percent {
      font-weight: 800;
      font-size: 14px;
      padding: 2px 8px;
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
    }
    .gain {
      color: #ff6b6b;
      text-shadow: 0 0 6px rgba(255, 107, 107, 0.4);
    }
    .loss {
      color: #84ceff;
      text-shadow: 0 0 6px rgba(132, 206, 255, 0.4);
    }
    .neutral {
      color: #ccc;
    }
    
    .cash{
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(255,255,255,.05);
      border:1px solid var(--stroke); border-radius:12px; padding:12px 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .cash-amount {
      color: #ffd700; /* 금액 텍스트 노란색 */
      font-weight: 700;
    }
    .holdings{
      background:rgba(255,255,255,.04);
      border:1px solid var(--stroke); border-radius:12px; overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }

    table{ width:100%; border-collapse:collapse; font-size:15px; table-layout:fixed; }
    th,td{ padding:12px 14px; border-bottom:1px solid #262626; text-align:left; }
    th{ background:rgba(255,255,255,.04); font-weight:700; }
    tr:last-child td{ border-bottom:none; }

    /* 테이블 컬럼 너비 조정 - 4개 컬럼으로 확장 */
    th:nth-child(1), td:nth-child(1){ width:20%; border-right:1px solid var(--stroke); }
    th:nth-child(2), td:nth-child(2){ width:25%; border-right:1px solid var(--stroke); }
    th:nth-child(3), td:nth-child(3){ width:25%; border-right:1px solid var(--stroke); }
    th:nth-child(4), td:nth-child(4){ width:30%; }

    /* Bottom links */
    .actions-row{
      width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:-4px;
    }
    .pill-link{
      background:rgba(255,255,255,.04);
      border:1px solid var(--stroke); color:#f2f2f2;
      border-radius:11px; height:40px; padding:0 14px; text-decoration:none; font-weight:800;
      display:inline-flex; align-items:center; gap:10px; transition:.24s;
    }
    .pill-link:hover{ 
      border-color:rgba(var(--glow),.30); 
      box-shadow:0 0 12px rgba(var(--glow),.20), 0 10px 20px rgba(0,0,0,.35); 
      color:#fff; 
      transform:translateY(-1px); 
    }

    /* 오른쪽 하단 고정 로그아웃 버튼 */
    .floating-logout {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
      background: rgba(255, 68, 58, 0.267);
      border: 1px solid rgba(71, 69, 69, 0.4);
      color: #b94e4e;
      border-radius: 50px;
      padding: 12px 20px;
      font-weight: 700;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all .24s ease;
      box-shadow: 0 4px 12px rgba(255,69,58,.15);
    }
    .floating-logout:hover {
      background: rgba(255,69,58,.2);
      border-color: rgba(255,69,58,.6);
      box-shadow: 0 6px 20px rgba(255,69,58,.25);
      transform: translateY(-2px);
      color: #ff4757;
    }

    /* Modals (탈퇴만 유지) */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.7);
      display:none; justify-content:center; align-items:center; z-index:1000;
    }
    .modal-content{
      background:rgba(44,44,44,.98); padding:24px; border-radius:12px; width:90%; max-width:480px;
      border:1px solid var(--stroke); box-shadow:0 10px 24px rgba(0,0,0,.45);
    }
    .modal-content h2{ margin-top:0; }
    .modal-content textarea{
      width:100%; padding:10px; border-radius:8px; border:1px solid #555; background:#1a1a1a; color:#e8e8e8; margin-top:10px;
    }
    .modal-actions{ margin-top:20px; display:flex; justify-content:flex-end; gap:10px; }
    .btn-secondary{ background:#555; color:#fff; border:none; padding:10px 16px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-secondary:hover{ background:#777; }
    .danger-btn{ background:#c82333; color:#fff; border:none; padding:10px 16px; border-radius:8px; font-weight:700; cursor:pointer; }
    .danger-btn:hover{ background:#a51c2b; }

    th:last-child {
      position: relative;
    }

    .refresh-btn{
      margin-left:6px;
      background:transparent;
      border:none;
      color:#ccc;
      cursor:pointer;
      font-size:14px;
      line-height:1;
    }
    .refresh-btn:hover{ color:#fff; }

    /* 평균매입가 스타일링 */
    .avg-price {
      font-weight: 600;
      color:#ccc;
    }

    @media (max-width: 768px) {
      .floating-logout {
        bottom: 16px;
        right: 16px;
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .total-assets {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .total-assets-right {
        align-items: flex-start;
      }
      
      .performance-change {
        justify-content: space-between;
        width: 100%;
      }
    }

  </style>
</head>
<body>
  <header>
    <a class="brand" href="index.html"><img src="/images/logo.png" alt="ITC 로고" /></a>
    <div class="header-actions">
      <!-- Admin button - initially hidden -->
      <a class="navbtn admin-btn" href="https://app.fabric.microsoft.com/reportEmbed?reportId=48ee305d-6830-46b4-93f9-c972f4cc2d39&autoAuth=true&ctid=5fb256f0-fbf2-40d2-81d5-bac1b32c419d" id="adminBtn" style="display:none;">📊 Admin</a>
      <a class="navbtn" href="index.html">← Back</a>
    </div>
  </header>

  <main>
    <div class="pagetitle"><h1>My Page</h1></div>

    <!-- Profile Card -->
    <section class="card" aria-label="프로필 및 지갑">
      <h2>
        <span class="h2-left">Profile</span>
        <span class="h2-right">
          <span class="dropdown">
            <button class="icon-btn" id="profileMenuBtn" aria-haspopup="true" aria-expanded="false" title="설정">⚙️ 설정</button>
            <div class="menu" id="profileMenu" role="menu" aria-label="프로필 메뉴">
              <button id="logoutFromMenuBtn" class="logout" role="menuitem">🚪 로그아웃</button>
              <button id="openDeletionFromMenuBtn" class="danger" role="menuitem">회원 탈퇴</button>
            </div>
          </span>
        </span>
      </h2>

      <!-- Avatar + Basic info -->
      <div class="profile-wrap">
        <div class="avatar" id="avatarContainer">
          <span id="avatarInitial">U</span>
        </div>
        <div class="profile">
          <div class="field">
            <div class="label">계정</div>
            <div class="value" id="userName">-</div>
          </div>
          <div class="field">
            <div class="label">가입일자</div>
            <div class="value" id="signupDate">-</div>
          </div>
        </div>
      </div>

      <!-- Quick links -->
      <div class="quick" aria-label="빠른 이동">
        <a class="qbtn" href="historical.html">📖 시뮬레이션</a>
        <a class="qbtn" href="realtime.html">📈 모의 투자</a>
        <a class="qbtn" href="crypto.html">📜 암호화폐 백과사전</a>
        <a class="qbtn" href="news.html">📰 뉴스</a>
      </div>

      <!-- Wallet -->
      <div class="wallet">
        <!-- 총 자산 표시 (성과 표시 추가) -->
        <div class="total-assets">
          <div class="total-assets-left">
            <div class="total-assets-label">💰 총 자산</div>
            <div id="totalAssets" class="total-assets-amount">0원</div>
          </div>
          <div class="total-assets-right">
            <div id="performanceChange" class="performance-change neutral">
              <span id="changeAmount">±0원</span>
            </div>
            <div id="performancePercent" class="performance-percent neutral">0.00%</div>
          </div>
        </div>
        
        <div class="cash">
          <div>주문 가능 금액</div>
          <div id="cashKRW" class="cash-amount">0원</div>
        </div>
        <div class="holdings">
          <table>
            <thead>
              <tr>
                <th>종목</th>
                <th>보유수량</th>
                <th>평균매입가</th>
                <th>
                  평가금액 (이익/손실)
                  <button id="refreshHoldingsBtn" class="refresh-btn" title="새로고침" style="position:absolute; right:14px; top:50%; transform:translateY(-50%);">↺</button>
                </th>
              </tr>
            </thead>
            <tbody id="holdingsBody"><tr><td colspan="4" style="opacity:.7">로딩 중…</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Bottom actions -->
    <div class="actions-row" aria-label="페이지 이동">
      <a class="pill-link" href="report.html">📑 REPORT</a>
      <a class="pill-link" href="qna.html">❓ Q&amp;A</a>
    </div>
  </main>

  <!-- 오른쪽 하단 고정 로그아웃 버튼 -->
  <a class="floating-logout" href="/logout" aria-label="로그아웃">
    🚪 LOGOUT
  </a>

  <!-- 탈퇴 모달만 유지 -->
  <div id="deletion-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="deletion-title">
    <div class="modal-content">
      <h2 id="deletion-title">회원 탈퇴</h2>
      <p>탈퇴 사유를 입력해주세요. 탈퇴 신청 후 확인 이메일이 발송되며, 이메일 인증 시 14일 후에 계정이 영구적으로 삭제됩니다.</p>
      <form id="deletion-form">
        <textarea id="deletion-reason" placeholder="(선택) 탈퇴 사유" rows="4"></textarea>
        <div class="modal-actions">
          <button type="button" id="cancel-deletion-btn" class="btn-secondary">취소</button>
          <button type="submit" class="danger-btn">탈퇴 신청</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // 초기 자본 설정 (1천만원)
    const INITIAL_CAPITAL = 10000000;

    // 관리자 사용자 목록
    const adminUsers = [
      '1dt021@msacademy.msai.kr',
      '1dt030@msacademy.msai.kr',
      '1dt019@msacademy.msai.kr',
      '1dt037@msacademy.msai.kr',
      '1dt035@msacademy.msai.kr',
      '1dt001@msacademy.msai.kr',
      '1dt137@msacademy.msai.kr'
    ];

    /* dropdown */
    const profileMenuBtn = $('#profileMenuBtn');
    const profileMenu    = $('#profileMenu');
    function openMenu(){ profileMenu.classList.add('open'); profileMenuBtn.setAttribute('aria-expanded','true'); }
    function closeMenu(){ profileMenu.classList.remove('open'); profileMenuBtn.setAttribute('aria-expanded','false'); }
    profileMenuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); profileMenu.classList.contains('open') ? closeMenu() : openMenu(); });
    document.addEventListener('click', (e)=>{ if (!profileMenu.contains(e.target) && e.target !== profileMenuBtn) closeMenu(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMenu(); });

    /* 로그아웃 기능 */
    const logoutFromMenuBtn = $('#logoutFromMenuBtn');
    logoutFromMenuBtn.addEventListener('click', () => {
      closeMenu();
      window.location.href = '/logout';
    });

    /* 탈퇴 모달 */
    const deletionModal  = $('#deletion-modal');
    const openDeletionBtn= $('#openDeletionFromMenuBtn');
    const cancelDeletionBtn = $('#cancel-deletion-btn');
    const deletionForm   = $('#deletion-form');
    function openDeletion(){ deletionModal.style.display='flex'; }
    function closeDeletion(){ deletionModal.style.display='none'; }
    openDeletionBtn.addEventListener('click', ()=>{ closeMenu(); openDeletion(); });
    cancelDeletionBtn.addEventListener('click', closeDeletion);
    window.addEventListener('click', (e)=>{ if (e.target === deletionModal) closeDeletion(); });

    deletionForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const reason = $('#deletion-reason').value;
      try{
        const response = await fetch('/api/user/request-deletion', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ reason })
        });
        const result = await response.json();
        if (response.ok){
          closeDeletion();
          if (result.scheduled){
            alert('회원 탈퇴가 예약되었습니다. 14일 이내 재로그인 시 탈퇴가 취소됩니다.');
            window.location.href = '/logout';
          }else{
            alert('회원 탈퇴 요청이 접수되었습니다. 이메일을 확인해 완료해주세요.');
          }
        }else{
          alert(`오류: ${result.message || '알 수 없는 오류가 발생했습니다.'}`);
        }
      }catch(err){
        console.error('Deletion request failed:', err);
        alert('탈퇴 요청 중 오류가 발생했습니다.');
      }
    });

    // 아바타 설정 함수
    function setAvatar(gender, username) {
      const avatarContainer = $('#avatarContainer');
      const avatarInitial = $('#avatarInitial');
      
      if (gender === '남' || gender === '여') {
        // 성별 정보가 있으면 이미지 사용
        const imageSrc = gender === '남' ? '/images/man.jpg' : '/images/woman.jpg';
        avatarContainer.innerHTML = `<img src="${imageSrc}" alt="${gender}성 아바타" />`;
      } else {
        // 성별 정보가 없으면 기존 이니셜 사용
        avatarInitial.textContent = username.trim().charAt(0).toUpperCase() || 'U';
      }
    }

    // 숫자 포맷팅 함수
    const fmtKRW = n => Number(n).toLocaleString('ko-KR') + '원';
    const fmtPercent = n => n.toFixed(2) + '%';

    // 성과 표시 업데이트 함수
    function updatePerformance(totalAssets) {
      const changeAmount = totalAssets - INITIAL_CAPITAL;
      const changePercent = ((totalAssets - INITIAL_CAPITAL) / INITIAL_CAPITAL) * 100;
      
      const changeAmountEl = $('#changeAmount');
      const changePercentEl = $('#performancePercent');
      const performanceChangeEl = $('#performanceChange');
      
      // 금액 변동 표시
      if (changeAmount > 0) {
        changeAmountEl.textContent = '+' + fmtKRW(changeAmount);
        changePercentEl.textContent = '+' + fmtPercent(changePercent);
        performanceChangeEl.className = 'performance-change gain';
        changePercentEl.className = 'performance-percent gain';
      } else if (changeAmount < 0) {
        changeAmountEl.textContent = fmtKRW(changeAmount);
        changePercentEl.textContent = fmtPercent(changePercent);
        performanceChangeEl.className = 'performance-change loss';
        changePercentEl.className = 'performance-percent loss';
      } else {
        changeAmountEl.textContent = '±' + fmtKRW(0);
        changePercentEl.textContent = fmtPercent(0);
        performanceChangeEl.className = 'performance-change neutral';
        changePercentEl.className = 'performance-percent neutral';
      }
      
      console.log('성과 업데이트:', {
        totalAssets: fmtKRW(totalAssets),
        changeAmount: fmtKRW(changeAmount),
        changePercent: fmtPercent(changePercent)
      });
    }

    // 총 자산 업데이트 함수 (성과 표시 포함)
    function updateTotalAssets() {
      // 주문 가능 금액
      const cashText = $('#cashKRW').textContent;
      const cashAmount = parseFloat(cashText.replace(/[^\d]/g, '')) || 0;
      
      // 보유 종목의 평가금액 합계 계산
      let totalHoldingsValue = 0;
      const holdingRows = document.querySelectorAll('#holdingsBody tr');
      
      console.log('총 자산 계산 중...', {
        cashAmount,
        holdingRowsCount: holdingRows.length
      });
      
      holdingRows.forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4 && !cells[0].textContent.includes('로딩') && !cells[0].textContent.includes('보유 종목이 없습니다')) {
          const evaluationCell = cells[3].textContent;
          console.log(`행 ${index}: ${evaluationCell}`);
          
          // 평가금액에서 숫자만 추출 (원, 쉼표 제거) - 더 정확한 패턴 매칭
          const numbers = evaluationCell.match(/[\d,]+/g);
          if (numbers && numbers.length > 0) {
            // 첫 번째 숫자가 평가금액
            const value = parseFloat(numbers[0].replace(/,/g, '')) || 0;
            totalHoldingsValue += value;
            console.log(`  -> 추출된 값: ${value}`);
          }
        }
      });
      
      // 총 자산 = 주문 가능 금액 + 보유 종목 평가금액
      const totalAssets = cashAmount + totalHoldingsValue;
      
      console.log('총 자산 계산 결과:', {
        cashAmount,
        totalHoldingsValue,
        totalAssets
      });
      
      // 총 자산 표시
      $('#totalAssets').textContent = fmtKRW(totalAssets);
      
      // 성과 표시 업데이트
      updatePerformance(totalAssets);
    }

    // 전역으로 노출하여 mypage.js에서 호출할 수 있도록
    window.updateTotalAssets = updateTotalAssets;

    // 사용자 데이터 로드 및 관리자 권한 확인
    (async ()=>{
      try{
        const res = await fetch('/api/user');
        if (!res.ok){
          if (res.status === 401) { location.href = '/'; }
          else { throw new Error('HTTP ' + res.status); }
          return;
        }
        const user = await res.json();
        const username = user.username || '';
        
        $('#userName').textContent = username || '사용자';
        
        // 아바타 설정 (gender 기반)
        setAvatar(user.gender, username);
        
        const joined = user.created_at ? new Date(user.created_at) : new Date();
        $('#signupDate').textContent = joined.toLocaleDateString('ko-KR');

        // 관리자 권한 확인 및 ADMIN 버튼 표시
        if (adminUsers.includes(username)) {
          $('#adminBtn').style.display = 'inline-flex';
        }

        // 주문 가능 금액 표시 (krw_balance 사용)
        $('#cashKRW').textContent = fmtKRW(user.krw_balance || 0);
        
        // 초기에는 주문 가능 금액만으로 총 자산 및 성과 표시
        const initialAssets = user.krw_balance || 0;
        $('#totalAssets').textContent = fmtKRW(initialAssets);
        updatePerformance(initialAssets);

      }catch(err){
        console.error('Failed to fetch user data:', err);
      }
    })();
    
    // 더 강력한 보유 종목 변경 감지
    let debounceTimer;
    const debouncedUpdate = () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        console.log('보유 종목 변경 감지됨, 총 자산 업데이트 중...');
        updateTotalAssets();
      }, 200);
    };
    
    // MutationObserver로 테이블 변경 감지
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.target.id === 'holdingsBody' || 
            mutation.target.closest('#holdingsBody')) {
          debouncedUpdate();
        }
      });
    });
    
    // 보유 종목 테이블 변경 감지
    const holdingsBody = $('#holdingsBody');
    if (holdingsBody) {
      observer.observe(holdingsBody, { 
        childList: true, 
        subtree: true,
        characterData: true 
      });
    }
    
    // 새로고침 버튼에 총 자산 업데이트 추가
    document.addEventListener('DOMContentLoaded', () => {
      const refreshBtn = $('#refreshHoldingsBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          setTimeout(() => {
            console.log('새로고침 버튼 클릭 후 총 자산 업데이트');
            updateTotalAssets();
          }, 1000); // 1초 후 업데이트
        });
      }
    });
    
    // 페이지 완전 로딩 후 총 자산 업데이트
    window.addEventListener('load', () => {
      setTimeout(() => {
        console.log('페이지 로딩 완료 후 총 자산 업데이트');
        updateTotalAssets();
      }, 2000);
    });
    
    // realtime 페이지 잔고 동기화
    (function() {
      // realtime 페이지 잔고 값을 가져와서 적용
      function loadRealtimeBalance() {
        try {
          const stored = localStorage.getItem('realtime_balance');
          if (stored) {
            const data = JSON.parse(stored);
            
            // 5분 이내 데이터만 사용
            const age = Date.now() - data.updated_at;
            if (age < 5 * 60 * 1000 && data.source === 'realtime_page') {
              
              // realtime의 available_amount 값을 그대로 사용
              const realtimeValue = data.available_amount;
              const cashElement = document.getElementById('cashKRW');
              
              if (cashElement && realtimeValue) {
                // "0 KRW" 형태를 "0원" 형태로 변환
                let formattedValue = realtimeValue.replace(' KRW', '원').replace('KRW', '원');
                
                // 숫자만 추출해서 한국어 형식으로 변환
                const numbers = formattedValue.match(/[\d,]+/);
                if (numbers && numbers[0]) {
                  const numValue = parseInt(numbers[0].replace(/,/g, ''));
                  formattedValue = numValue.toLocaleString('ko-KR') + '원';
                }
                
                // 현재 값과 다를 때만 업데이트
                const currentValue = cashElement.textContent.trim();
                if (currentValue !== formattedValue) {
                  // 업데이트 애니메이션
                  cashElement.style.transition = 'all 0.3s ease';
                  cashElement.style.transform = 'scale(1.05)';
                  cashElement.style.color = '#00d4aa';
                  
                  setTimeout(() => {
                    cashElement.textContent = formattedValue;
                    cashElement.style.transform = 'scale(1)';
                    cashElement.style.color = '#ffd700';
                    
                    // 총 자산 및 성과도 업데이트
                    if (window.updateTotalAssets) {
                      setTimeout(window.updateTotalAssets, 300);
                    }
                  }, 150);
                  
                  console.log('💰 realtime에서 잔고 복사됨:', formattedValue);
                }
              }
            }
          }
        } catch (error) {
          console.error('realtime 잔고 로드 실패:', error);
        }
      }
      
      // BroadcastChannel로 실시간 수신
      if (typeof BroadcastChannel !== 'undefined') {
        try {
          const channel = new BroadcastChannel('realtime_balance');
          channel.addEventListener('message', (event) => {
            const data = event.data;
            if (data.source === 'realtime_page') {
              
              const realtimeValue = data.available_amount;
              const cashElement = document.getElementById('cashKRW');
              
              if (cashElement && realtimeValue) {
                // 값 변환
                let formattedValue = realtimeValue.replace(' KRW', '원').replace('KRW', '원');
                const numbers = formattedValue.match(/[\d,]+/);
                if (numbers && numbers[0]) {
                  const numValue = parseInt(numbers[0].replace(/,/g, ''));
                  formattedValue = numValue.toLocaleString('ko-KR') + '원';
                }
                
                // 즉시 업데이트 (깜빡이 효과)
                cashElement.style.backgroundColor = 'rgba(0, 212, 170, 0.3)';
                cashElement.textContent = formattedValue;
                
                setTimeout(() => {
                  cashElement.style.backgroundColor = '';
                  if (window.updateTotalAssets) {
                    window.updateTotalAssets();
                  }
                }, 1000);
                
                console.log('💰 realtime 실시간 잔고 수신:', formattedValue);
              }
            }
          });
        } catch (e) {
          console.log('BroadcastChannel 미지원, localStorage만 사용');
        }
      }
      
      // 페이지 로드시 realtime 잔고 확인
      loadRealtimeBalance();
      
      // 페이지 포커스시 realtime 잔고 확인
      window.addEventListener('focus', loadRealtimeBalance);
      
      // 30초마다 realtime 잔고 확인
      setInterval(loadRealtimeBalance, 30000);
      
      // localStorage 변경 감지 (다른 탭에서 realtime 사용시)
      window.addEventListener('storage', (e) => {
        if (e.key === 'realtime_balance' && e.newValue) {
          loadRealtimeBalance();
        }
      });
    })(); 
  </script>
  <script src="/mypage.js"></script>
</body>
</html>